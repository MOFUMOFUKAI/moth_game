<!DOCTYPE html> 
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icn_mothvoid.png">
  <title>MOTHVOID</title>
  <style>
    * {
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      user-select: none;
    }
    body {
      margin: 0;
      background: #000;
      color: white;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;  /* â† ç¸¦æ–¹å‘ã„ã£ã±ã„ã«ä½¿ã† */
      overflow: hidden;
    }
    img, button {
      -webkit-user-drag: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    #titleScreen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 10;
    }
    #titleLogo {
      width: 380px;
      margin-bottom: 20px;
    }
    #pressToStart {
      font-size: 20px;
      color: #FFD700;
      animation: blink 2s infinite;
      font-family: 'monospace';
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    #time {
      display: none;
    }
    #game {
      position: relative;
      width: 100vw;
      height: 150vw;
      max-width: 400px;
      max-height: 600px;
      margin-top: -2px; /* â† ã“ã®1è¡Œã‚’è¿½åŠ  */
      background: #111;
      border: 2px solid #fff;
      overflow: hidden;
      margin: -80px auto 0; /* â† ä¸Šã«30pxå¯„ã›ã‚‹ */
      z-index: 0; 
    }
    #player {
      position: absolute;
      width: 48px;
      height: 48px;
      bottom: 10px;
      left: 180px;
      background-image: url("chr_moth.gif");
      background-size: cover;
      z-index: 2;
    }
    #hitbox {
      position: absolute;
      width: 35px;
      height: 35px;
      bottom: 12px;
      left: 182px;
      pointer-events: none;
      z-index: 2;
    }
    .obstacle {
      position: absolute;
      width: 50px;
      height: 50px;
      background: red;
      z-index: 2;
    }
    .obstacle.stage4 {
      background-color: #555;
    }
    .afterimage {
      position: absolute;
      width: 40px;
      height: 40px;
      pointer-events: none;
      z-index: 2;
      animation: fade .1s forwards;
    }
    .afterimage::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(0, 200, 255, 0.4) 0%, rgba(0, 200, 255, 0.0) 80%);
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.3);
      top: 0;
      left: 0;
      pointer-events: none;
    }
    @keyframes fade {
      to { opacity: 0; }
    }
    .dodge-flare {
      position: absolute;
      width: 40px;
      height: 40px;
      top: 0;
      left: 0;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0, 200, 255, 0.4), rgba(0, 200, 255, 0));
      pointer-events: none;
      z-index: 1;
    }
    .heal {
      position: absolute;
      width: 40px;
      height: 40px;
      font-size: 28px;
      color: pink;
      text-align: center;
      line-height: 40px;
      pointer-events: none;
    }
    .explosion {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: radial-gradient(circle, orange, red, transparent);
      animation: explode 0.4s ease-out forwards;
      pointer-events: none;
    }
    .rainbow {
      animation: rainbow 0.5s infinite;
    }
    @keyframes explode {
     0% { opacity: 1; transform: scale(0.5); }
     100% { opacity: 0; transform: scale(2); }
    }
    @keyframes rainbow {
      0% { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(360deg); }
    }
    .damage-flash {
      animation: flashWhite 0.15s ease-in-out;
    }
    @keyframes flashWhite {
      0% { filter: brightness(1); }
      50% { filter: brightness(3); }
      100% { filter: brightness(1); }
    }
   /* ã‚¹ã‚³ã‚¢ï¼ˆç™½æ å¤–ï¼‰ */
    #uiTop {
      position: relative; 
      width: 400px;
      margin-bottom: 80px;
      color: white;
      font-family: monospace;
    }
    #score {
      text-align: center;
      font-size: 20px;
      margin-bottom: 4px;
    }
   /* ãƒãƒ¼ãƒˆï¼ˆãƒ©ã‚¤ãƒ•è¡¨ç¤ºï¼‰ãƒ¬ãƒ™ãƒ«ãƒ»çµŒé¨“å€¤ç™½æ å†…å·¦ä¸Šã«è¡¨ç¤º */
    #levelExpRow {
     position: absolute;
     top: 8px;
     right: 6px;
     font-size: 14px;
     z-index: 10;
    }
    #smartphoneHint {
     color: white;
     font-size: 0.85em;
     margin-top: 10px;
     line-height: 1.4;
    }
    #lives {
      position: absolute;
      top: 5px;
      left: 5px;
      font-size: 20px;
      z-index: 5;
    }
    #gameClear, #gameOver {
      position: absolute;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: yellow;
      background: rgba(0, 0, 0, 0.7);
      font-size: 24px;
      z-index: 20;
      pointer-events: none; 
    }
    #thankYouText {
      font-size: 36px;
      margin-bottom: 10px;
    }
    #timeRating {
      font-size: 30px;
      margin-bottom: 10px;
    }
    #credits {
      font-size: 16px;
    }
    #restartButton {
      display: none;
      position: absolute;
      left: 50%;
      bottom: 2%; /* ã‚²ãƒ¼ãƒ ç”»é¢ã®ä¸­å¤®ã«è¡¨ç¤º */
      transform: translate(-50%, -50%);
      padding: 8px 16px;
      font-size: 16px;
      background-color: #f39c12;
      color: white;
      border: none;
      border-radius: 5px;
      z-index: 9999;               /* é‡ãªã‚Šé †ã‚’æœ€å‰é¢ã«èª¿æ•´ */
      cursor: pointer;
      pointer-events: auto;       /* ã‚¿ãƒƒãƒã‚’ç¢ºå®Ÿã«å—ã‘ä»˜ã‘ã‚‹ */
      touch-action: manipulation; /* â† ã‚¿ãƒƒãƒ—åå¿œã‚’æœ€é©åŒ–ï¼ˆç‰¹ã«iOSï¼‰ */
    }
    #touchControls {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;  /* â† ä¸‹æƒãˆã«å¤‰æ›´ */
      width: 400px;
      margin-top: 20px;
      padding: 0 10px;
      height: 40px;  /* â† é«˜ã•ã‚’å›ºå®š */
      position: relative;
    }
    #moveInstruction,
    #parryInstruction {
      position: absolute;
      bottom: 65px; /* â† ãƒœã‚¿ãƒ³ã‚ˆã‚Šä¸Šã«å›ºå®šè¡¨ç¤º */
      font-size: 14px;
      color: #FFD700;
      font-family: monospace;
      text-align: center;
      width: 120px;
      white-space: nowrap;
    }
    #moveInstruction {
      left: 20px;
    }
    #parryInstruction {
      right: 60px;
    }
    .arrowGroup {
      display: flex;
      gap: 30px;
      margin-left: 30px; /* â† çŸ¢å°å…¨ä½“ã‚’å³ã«ãšã‚‰ã™ */
    }
    .parryGroup {
      display: flex;
      justify-content: flex-end;
    }

    .control-button {
      width: 60px;
      height: 60px;
    }
    #btnParry {
      margin-right: 70px; /* â† å³è©°ã‚èª¿æ•´ */
      margin-top: 1px;   /* â† ãƒ‘ãƒªã‚£ã ã‘ã•ã‚‰ã«å°‘ã—ä¸‹ã« */
    }

    #screenFade {
      position: absolute;
      top: 0; left: 0;
      width: 400px;
      height: 600px;
      background: #000;
      pointer-events: none;
      opacity: 0;
      transition: opacity .75s ease;
      z-index: 9;
    }
    #background {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-size: 100% auto;
      background-repeat: repeat-y;
      background-position-y: 0px;
      z-index: 0;
    }
    #bgDarkenLayer {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.75s ease;
      z-index: 1;
    }
    .obstacle-img {
      position: absolute;
      pointer-events: none;
      transform: translate(-50%, -50%);
    }
    .score-popup {
      position: absolute;
      font-size: 18px;
      font-weight: bold;
      font-family: monospace;
      pointer-events: none;
      animation: floatUp 0.5s ease-out forwards;
      z-index: 100;
    }

    @keyframes floatUp {
      0% {
        opacity: 1;
        transform: translateY(0px);
      }
      100% {
        opacity: 0;
        transform: translateY(-30px);
      }
    }
    
    /* â–¼ ãƒãƒ¼ã‚ºï¼å†é–‹ãƒœã‚¿ãƒ³ã®é…ç½®ãƒ»è¦‹ãŸç›® */
   #pauseControls {
     position: absolute;
     top: -3px;
     right: 20px;
     z-index: 15;
     display: flex;
     gap: 6px;
   }

   #pauseButton,
   #resumeButton {
     font-size: 18px;
     background: none;
     border: none;
     color: white;
     cursor: pointer;
     padding: 2px 6px;
   }

   /* ãƒãƒ¼ã‚ºä¸­ã«ä¸­å¤®ã«è¡¨ç¤ºã•ã‚Œã‚‹PAUSEãƒ†ã‚­ã‚¹ãƒˆ */
   #pauseOverlay {
     position: absolute;
     top: 50%;
     left: 50%;
     transform: translate(-50%, -50%);
     font-size: 36px;
     color: white;
     background: rgba(0, 0, 0, 0.6);
     padding: 10px 30px;
     border-radius: 10px;
     display: none;
     z-index: 999;
     pointer-events: none;
   }

  .void-rank {
    font-size: 28px;
    color: gold;
    text-shadow: 0 0 10px gold, 0 0 20px orange;
    font-weight: bold;
    animation: glow 1.5s infinite alternate;
  }

  .void-subtext {
    font-size: 14px;
    color: #ccc;
    margin-top: 5px;
  }

  @keyframes glow {
    from { text-shadow: 0 0 5px gold; }
    to { text-shadow: 0 0 20px gold, 0 0 30px orange; }
  }
  
#voidFeathers {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 9999;
}

.feather {
  position: absolute;
  width: 24px;
  height: 24px;
  background-image: url('eff_feather.png');
  background-size: cover;
  opacity: 1;
  z-index: 99999;
  pointer-events: none;
  transform: translate(0, 0) rotate(0deg);
  animation: featherFly var(--flyTime, 2s) ease-out forwards,
             featherWobble 3s ease-in-out infinite;
            
}

@keyframes featherFly {
  0% {
    transform: translate(0px, 0px) rotate(var(--startAngle));
    opacity: 1;
  }
  10% {
    transform: translate(calc(var(--dx) * 1px), calc(var(--dy) * 0.3px)) rotate(var(--midAngle));
    opacity: 1;
  }
  100% {
    transform: translate(calc(var(--dx) * 1px), calc(var(--dy) * 1px)) rotate(var(--endAngle));
    opacity: 0;
  }
}
@keyframes featherWobble {
  0%, 100% {
    filter: brightness(1.8);
  }
  50% {
    filter: brightness(2.3);
  }
}

  </style>
</head>

<body>
<!-- UIã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚³ã‚¢ï¼‰ â†’ ç™½æ ã®å¤–ã€ç”»é¢ä¸­å¤®ä¸Š -->
<div id="uiTop">
  <div id="score">ã‚¹ã‚³ã‚¢: 0</div>
  <div id="musicTitle" style="
  position: absolute;
  top: 60px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 18px;
  font-family: monospace;
  text-shadow: 0 0 6px black;
  opacity: 0;
  transition: opacity 0.5s ease;
  z-index: 10;
  pointer-events: none;
"></div>
   <!-- ãƒãƒ¼ã‚ºï¼å†é–‹ãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šï¼‰ -->
  <div id="pauseControls">
    <button id="pauseButton" title="ãƒãƒ¼ã‚º">â¸</button>
    <button id="resumeButton" title="å†é–‹" style="display: none;">â–¶ï¸</button>
  </div>
</div>
<!-- ã‚¿ã‚¤ãƒ è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ãªã©ï¼‰ -->
<div id="time" style="display: none;">ã‚¿ã‚¤ãƒ : 0.000ç§’</div>

<!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
<div id="titleScreen">
<!-- HIGH SCORE è¦‹å‡ºã—ã‚’è¿½åŠ  -->
  <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px; color: #FFD700;">HIGH SCORE</div>
<!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®ã‚¹ã‚³ã‚¢è¡¨ç¤ºé ˜åŸŸï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ­ã‚´ã®ä¸Šãªã©ï¼‰ -->
  <div id="topHighScore" style="font-size: 14px; margin: 5px auto 0 auto; text-align: center;"></div>
  <img src="title_mothvoid.webp" alt="MOTHVOIDã‚¿ã‚¤ãƒˆãƒ«ãƒ­ã‚´" id="titleLogo">
  <p id="pressToStart">PRESS ANY BUTTON</p>
  <p id="smartphoneHint" class="title-only">
  Ver.1.2.0<br>
  â€»ã‚¹ãƒãƒ›ã®å ´åˆ<br>
  ã€Œå…±æœ‰ãƒœã‚¿ãƒ³â†’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€<br>
  ãã®å¾Œãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‹ã‚‰<br>
  ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã®ãŒãŠã‚¹ã‚¹ãƒ¡ï¼<br>
  â€»iOS 15ä»¥ä¸Šï¼ˆiPhone / iPadï¼‰<br>
  â€»Safari/Chromeã¯æœ€æ–°ç‰ˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
  
</p>
</div>

<!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="game">
 <!-- Vãƒ©ãƒ³ã‚¯ç¾½æ ¹æ¼”å‡º -->
  <div id="voidFeathers" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:99999;"></div>
  <div id="background"></div>
  <div id="bgDarkenLayer"></div>
  <div id="player"></div>
  <div id="hitbox"></div>
  <div id="lives">â¤ï¸â¤ï¸â¤ï¸</div>
  <div id="screenFade"></div>
   <!-- ãƒ¬ãƒ™ãƒ«ï¼çµŒé¨“å€¤è¡¨ç¤ºï¼ˆç™½æ å³ä¸Šï¼‰ -->
  <div id="levelExpRow">
    <span id="level">Lv.1</span>
    <span id="exp">EXP: 0 / 200</span>
  </div>
  
  <!-- ãƒãƒ¼ã‚ºä¸­ã®è¡¨ç¤º -->
  <div id="pauseOverlay">PAUSE</div>
  
  <!-- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
    <img id="justParryEffect" src="eff_just_parry.gif"
       style="display: none; position: absolute; width: 60px; height: 60px; z-index: 3; pointer-events: none;">
    <!-- BGM -->
    <audio id="bgm_stage1" loop><source src="bgm_stage1.mp3" type="audio/mpeg"></audio>
    <audio id="bgm_stage2" loop><source src="bgm_stage2.mp3" type="audio/mpeg"></audio>
    <audio id="bgm_stage3" loop><source src="bgm_stage3.mp3" type="audio/mpeg"></audio>
    <audio id="bgm_final" loop><source src="bgm_final.mp3" type="audio/mpeg"></audio>
    <audio id="bgm_final2" loop><source src="bgm_final2.mp3" type="audio/mpeg"></audio>
    <audio id="bgm_result" loop>  <source src="bgm_result.mp3" type="audio/mpeg"></audio>
    <!-- SE -->
    <audio id="seParry"><source src="se_parry.mp3" type="audio/mpeg"></audio>
    <audio id="seDodge"><source src="se_dodge.mp3" type="audio/mpeg"></audio>
    <audio id="seBombL"><source src="se_bomb_L.mp3" type="audio/mpeg"></audio>
    <audio id="seItem"><source src="se_item.mp3" type="audio/mpeg"></audio>
    <audio id="seJustParry"><source src="se_justparry.mp3" type="audio/mpeg"></audio>
    <!-- ã‚¯ãƒªã‚¢ç”»é¢ -->
    <div id="gameClear">
     <div>
        <h2 id="thankYouText">Thank you for playing!</h2>
        <p id="timeRating"></p>
        <p id="credits">
          <span>Director: akky</span><br>
          <span>Designer: MAS</span><br>
          <span>Programmer: GPT</span><br>
          <span>MOTHVOID 2025/7/01</span>
        </p>
        
        <!-- âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º -->
        <div id="scoreList" style="margin-top: 14px; font-size: 16px;"></div>
    
      </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
    <div id="gameOver">
      <h2>Game Over</h2>
    </div>
    <!-- å†ãƒ—ãƒ¬ã‚¤ãƒœã‚¿ãƒ³ -->
    <button id="restartButton">å†ãƒ—ãƒ¬ã‚¤</button>
  </div> <!-- â† #game ã®é–‰ã˜ã‚¿ã‚° -->
  
    <!-- â–¼ ãƒã‚¤ã‚¹ã‚³ã‚¢åå‰å…¥åŠ›UIï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
    <div id="nameEntryScreen" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:#000d; color:white; z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
      <div style="font-size:20px; margin-bottom:10px;">HIGH SCORE! ENTER YOUR NAME</div>
      <div id="nameEntry" style="font-size:36px; letter-spacing:10px;">A A A A</div>
      <div style="margin-top:20px;">
        <button onclick="prevChar()">â—€</button>
        <button onclick="nextChar()">â–¶</button>
        <button onclick="goBackChar()" id="backButton" style="margin-left: 20px;">å‰ã¸</button> <!-- âœ… æ–°ã—ãè¿½åŠ  -->
        <button onclick="confirmNameEntry()" id="confirmButton" style="margin-left: 20px;">æ¬¡ã¸</button>
      </div>
    </div>
    
    <!-- ã‚¿ãƒƒãƒæ“ä½œãƒœã‚¿ãƒ³ -->
<div id="touchControls" class="title-only">
  <div class="arrowGroup">
    <div id="moveInstruction" class="instruction title-only">å·¦å³ç§»å‹•ï¼é€£ç¶šå…¥åŠ›ã§å›é¿</div>
    <img id="btnLeft" src="btn_left.png" class="control-button">
    <img id="btnRight" src="btn_right.png" class="control-button">
  </div>
  <div class="parryGroup">
    <div id="parryInstruction" class="instruction title-only">ãƒ‘ãƒªã‚£ï¼ã‚¸ãƒ£ã‚¹ãƒˆãƒ‘ãƒªã‚£</div>
    <img id="btnParry" src="btn_parry.png" class="control-button">
  </div>
 <script>
  const game = document.getElementById("game");
  const player = document.getElementById("player");
  const hitbox = document.getElementById("hitbox");
  const scoreEl = document.getElementById("score");
  const livesEl = document.getElementById("lives");
  const timeEl = document.getElementById("time");
  const levelEl = document.getElementById("level");
  const maxLevel = 7; 
  const expEl = document.getElementById("exp");
  const gameClear = document.getElementById("gameClear");
  const timeRatingEl = document.getElementById("timeRating");
  const restartButton = document.getElementById("restartButton");
  const seParry = document.getElementById("seParry");
  const seBombL = document.getElementById("seBombL");
  const seDodge = document.getElementById("seDodge");
  const seItem = document.getElementById("seItem");
  const seJustParry = document.getElementById("seJustParry");
  const btnLeft  = document.getElementById("btnLeft");
  const btnRight = document.getElementById("btnRight");
  const btnParry = document.getElementById("btnParry");
  const titleScreen = document.getElementById("titleScreen");
  const availableChars = [..."ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_.!*@#?<> "];
  const bgm = {
     Stage1: document.getElementById("bgm_stage1"),
     Stage2: document.getElementById("bgm_stage2"),
     Stage3: document.getElementById("bgm_stage3"),
     Final:  document.getElementById("bgm_final"),
     Final2: document.getElementById("bgm_final2"),
     Result: document.getElementById("bgm_result")
   };
  

  let score = 0;
  let lives = 3;
  let maxLives = 3;
  let gameOver = false;
  let invincible = false;
  let parryActive = false;
  let justParry = false;
  let playerX = 180;
  let playerSpeed = 3;
  let obstacleSpeed = 15;  // éšœå®³ç‰©ã®é€Ÿåº¦
  let startTime = Date.now();  // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã®æ™‚é–“
  let gameTime = 0;  // çµŒéæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  let lastScoreUpdateTime = 0;  // æœ€å¾Œã«ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°ã—ãŸãƒŸãƒªç§’
  let highScore = localStorage.getItem("highScore") || 0;
  let parryGauge = 0;
  const maxGauge = 3;
  let level = 1;
  let exp = 0;
  const allObstacles = [];
  let stage = 1;
  let lastParryTime   = 0;   // å‰å›ãƒ‘ãƒªã‚£ã‚’æ‰“ã£ãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  const PARRY_COOLDOWN = 450; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ™‚é–“ [ms]
  let firstInteraction = false;
  let currentBGM = null;
  let gameStarted = false;
  let gamePaused = false;
  const scrollDuration = 120; // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ï¼ˆç§’ï¼‰
  let baseInterval   = 800;  // â˜… ç¾åœ¨ã®é–“éš”ï¼ˆåˆæœŸ 800msï¼‰
  let obstacleTimerId      = null; // â˜… setInterval ã® ID ã‚’ä¿æŒ
  let obstacleSpawnInterval = null;
  let isPaused = false;
  let pauseStart = 0;
  let totalPausedTime = 0;

  // å›é¿ç§»å‹•é–¢é€£ã®å¤‰æ•°
  let lastKey        = "";      // ç›´å‰ã®æ–¹å‘ã‚­ãƒ¼
  let lastKeyTime    = 0;       // æŠ¼ä¸‹ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  let isDodging      = false;   // å›é¿ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ä¸­
  let speedBoost     = false;   // å›é¿å¾Œ 0.3 s ã ã‘ 2 å€é€Ÿ
  let keyPressed = {};  // æŠ¼ä¸‹ä¸­ã‹ã©ã†ã‹
  let pausedDueToVisibility = false; // ã‚¿ãƒ–éè¡¨ç¤ºã«ã‚ˆã‚‹ä¸€æ™‚åœæ­¢ã‹ã©ã†ã‹
  let lastExplosionTime = 0;
  
  // â–¼ ãƒã‚¤ã‚¹ã‚³ã‚¢ä¿å­˜ç”¨ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆlocalStorageä½¿ç”¨ï¼‰
  const HIGH_SCORE_KEY = "yamamayu_high_scores";
  const defaultHighScores = [
    { name: "MOTH", score: 400000, rating: "SS" },
    { name: "LMNG", score: 350000, rating: "S" },
    { name: "KAIK", score: 300000, rating: "A" },
    { name: "YMMY", score: 250000, rating: "B" },
    { name: "OOMZ", score: 200000, rating: "C" }
  ];

  // ãƒã‚¤ã‚¹ã‚³ã‚¢å–å¾—
  function loadHighScores() {
    const json = localStorage.getItem(HIGH_SCORE_KEY);
    return json ? JSON.parse(json) : defaultHighScores;
  }

  // ãƒã‚¤ã‚¹ã‚³ã‚¢ä¿å­˜
  function saveHighScores(highScores) {
    localStorage.setItem(HIGH_SCORE_KEY, JSON.stringify(highScores));
  }

  // ç¾åœ¨ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ï¼ˆ5ä»¶ä»¥å†…ï¼‰ã‚’ä¿æŒ
  let highScores = loadHighScores();
  let enteringName = false;
  let nameChars = ["A", "A", "A", "A"];
  let namePos = 0;

  const ratingCoefficients = {
    "V": 4.0,
    "SS": 3.6,
    "S": 3.2,
    "A": 2.8,
    "B": 2.4,
    "C": 2.0,
    "D": 1.6,
    "E": 1.2
  };

  const DOUBLE_TAP_MS = 200;    // 0.2 ç§’ä»¥å†…
  const STEP_PX       = 30;     // 1 ã‚¹ãƒ†ãƒƒãƒ—è·é›¢

  window.addEventListener("load", () => {
    if (bgm["stage1"]) bgm["stage1"].load(); // èª­ã¿è¾¼ã¿ã ã‘ã—ã¦ãŠã
  });
/* =======================================================
   â–¼ ã‚²ãƒ¼ãƒ é–‹å§‹ï¼å†ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†ï¼ˆBGMãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³å¯¾å¿œï¼‰
   ======================================================= */

// ã‚¿ã‚¤ãƒãƒ¼IDã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å®šç¾©
let obstacleGenerationInterval;
let scoreUpdateInterval;
let timeUpdateInterval;

// BGM ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³å†ç”Ÿé–¢æ•°ï¼ˆvolume 0 â†’ 1ï¼‰
function fadeInBGM(audio, duration = 1000) {
  const target = parseFloat(audio.dataset.targetVolume || 1);
  audio.volume = 0;
  audio.currentTime = 0;
  audio.play().catch(console.warn);

  const step = target / (duration / 50);
  let n = 0;
  const id = setInterval(() => {
    n++;
    audio.volume = Math.min(target, audio.volume + step);
    if (audio.volume >= target || n >= (duration / 50)) {
      clearInterval(id);
      currentBGM = audio;  // â† ã“ã“ã§ã‚ˆã†ã‚„ã currentBGM ã‚’ç¢ºå®š
    }
  }, 50);
}

/* =======================================================
   â–¼ BGM ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ======================================================= */
function crossfadeBGM(fromAudio, toAudio, duration = 1500) {
  if (!fromAudio || !toAudio || fromAudio === toAudio) return;

  const fromTarget = 0;
  const toTarget   = parseFloat(toAudio.dataset.targetVolume || 1);  // â˜… è¿½åŠ 

  const stepTime = 50;
  const steps    = duration / stepTime;
  const fromStep = (fromAudio.volume - fromTarget) / steps;
  const toStep   =  toTarget               / steps;

  toAudio.volume = 0;
  toAudio.currentTime = 0;
  toAudio.play().catch(console.warn);

  let n = 0;
  const id = setInterval(() => {
    n++;
    fromAudio.volume = Math.max(fromTarget, fromAudio.volume - fromStep);
    toAudio.volume   = Math.min(toTarget , toAudio.volume   + toStep );

    if (n >= steps) {
      clearInterval(id);
      fromAudio.pause();
      fromAudio.volume = parseFloat(fromAudio.dataset.targetVolume || 1);
      currentBGM = toAudio;
    }
  }, stepTime);
}
/* =======================================================
   â–¼ æ›²åè¡¨ç¤º
   ======================================================= */
function showMusicTitle(text) {
  const titleEl = document.getElementById("musicTitle");
  titleEl.textContent = text;
  titleEl.style.opacity = 1;

  setTimeout(() => {
    titleEl.style.opacity = 0;
  }, 5000);
}
/* =======================================================
   â–¼ èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦
   ======================================================= */
let backgroundOffset = 0;
let scrollSpeed = 0.2; // ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã«å¤‰åŒ–ã™ã‚‹åŸºæœ¬é€Ÿåº¦ï¼ˆåˆæœŸå€¤ï¼‰

function scrollBackground() {
  // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸåŠ é€Ÿå‡¦ç†
  let extraSpeed = 0;
  if (score >= 300000) {
    const steps = Math.floor((score - 300000) / 150000) + 1;
    extraSpeed = Math.min(steps, 7); // æœ€å¤§åŠ é€Ÿã¯ +7.0 ã¾ã§
  }

  // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†
  backgroundOffset += scrollSpeed + extraSpeed;
  const bg = document.getElementById("background");
  if (bg) {
    bg.style.backgroundPositionY = `${backgroundOffset}px`;
  }

  requestAnimationFrame(scrollBackground);
}

// ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã®åŸºæœ¬ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ã‚’è¨­å®šï¼ˆã‚²ãƒ¼ãƒ é–‹å§‹ãƒ»é€²è¡Œæ™‚ã«å‘¼ã³å‡ºã—ï¼‰
function setStageBackgroundSpeed(stage) {
  if (stage === 1) scrollSpeed = 0.3;
  else if (stage === 2) scrollSpeed = 0.5;
  else if (stage === 3) scrollSpeed = 0.8;
  else if (stage === 4) scrollSpeed = 2.0;
  else if (stage === 5) scrollSpeed = 2.0; // ã‚¹ãƒ†ãƒ¼ã‚¸4ã¨åŒã˜é€Ÿåº¦ã‚’ç¶­æŒ
}

/* =======================================================
   â–¼ èƒŒæ™¯ & BGM ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ä»˜ãã‚¹ãƒ†ãƒ¼ã‚¸ç®¡ç†
   ======================================================= */

/** èƒŒæ™¯â€BGM ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã®æ‰€è¦æ™‚é–“ï¼ˆmsï¼‰ */
const FADE_MS = 1500;          // â†BGM ã® crossfadeBGM() ã¨æƒãˆã¦ã„ã¾ã™

/**
 * æš—è»¢ â†’ èƒŒæ™¯ç”»åƒåˆ‡æ›¿ â†’ æ˜è»¢
 * @param {number} nextStage 1ã€œ5
 */
function crossfadeBackground(nextStage){
  const bg    = document.getElementById("background");
  const darken = document.getElementById("bgDarkenLayer");

  // æš—ãã™ã‚‹
  darken.style.opacity = 1;

  setTimeout(() => {
    // èƒŒæ™¯ç”»åƒåˆ‡æ›¿ï¼ˆæš—ã„ã¾ã¾åˆ‡ã‚Šæ›¿ãˆï¼‰
    bg.style.backgroundImage = `url(env_stage${nextStage}.webp)`;

    // æ˜ã‚‹ãæˆ»ã™
    darken.style.opacity = 0;
  }, FADE_MS / 2);
}

/* =======================================================
   â–¼ èƒŒæ™¯æƒ…å ±æ›´æ–°
   ======================================================= */
function updateBackgroundInstant(stageNum) {
  const bg = document.getElementById("background");

  // èƒŒæ™¯ç”»åƒã‚’å³æ™‚åˆ‡æ›¿
  bg.style.backgroundImage = `url(env_stage${stageNum}.webp)`; // ä¾‹: env_stage2.webp

  // å¿…è¦ãªåˆæœŸã‚¹ã‚¿ã‚¤ãƒ«å†è¨­å®šï¼ˆå¿µã®ãŸã‚ãƒªã‚»ãƒƒãƒˆï¼‰
  bg.style.backgroundRepeat = "repeat-y";
  bg.style.backgroundSize = "100% auto";
  bg.style.backgroundPositionY = `${backgroundOffset}px`; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã«åˆã‚ã›ã‚‹
}
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¤å®š &  ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«/BGM åŒæœŸã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function checkStage() {
  const prev = stage;

  // é€šå¸¸ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆ1ã€œ4ï¼‰ã‚’æ®µéšçš„ã«åˆ¤å®š
  stage =
    score >= 600000 ? 5 :
    score >= 150000 ? 4 :
    score >= 100000 ? 3 :
    score >=  50000 ? 2 : 1;

  /* â”€ ã‚¹ãƒ†ãƒ¼ã‚¸ãŒå¤‰ã‚ã£ãŸã‚‰ â”€ */
  if (stage !== prev) {

    /* èƒŒæ™¯ã‚’ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ */
    crossfadeBackground(stage);

    // BGMåˆ‡ã‚Šæ›¿ãˆå¯¾è±¡ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¿œã˜ã¦æ±ºå®š
    const targetBGM =
      stage === 5 ? bgm.Final2 :  // ã‚¹ã‚³ã‚¢60ä¸‡ä»¥ä¸Šï¼šæœ€çµ‚BGMã«åˆ‡æ›¿
      [bgm.Stage1, bgm.Stage2, bgm.Stage3, bgm.Final][stage - 1];

    if (!currentBGM){
      // åˆå›ã ã‘ã¯ãƒœãƒªãƒ¥ãƒ¼ãƒ  0â†’1 ã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã§é–‹å§‹
      fadeInBGM(targetBGM, FADE_MS);
    }else if (currentBGM !== targetBGM){
      crossfadeBGM(currentBGM, targetBGM, FADE_MS);
    }

    currentBGM = targetBGM;
    setStageBackgroundSpeed(stage); // â† ã“ã“ã§èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ã‚’å¤‰æ›´
    
     // ğŸµ æ›²åã‚’è¡¨ç¤º
    const musicTitles = {
      1: "â™ªStarlight Vanguard",
      2: "â™ªBrave Ascent",
      3: "â™ªVoidborne Resolve",
      4: "â™ªBurn the Void",
      5: "â™ªBeyond the Edge"
    };
    showMusicTitle(musicTitles[stage]);
  }
}

window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("nameEntryScreen").style.display = "none";
  enteringName = false;
  window.newHighScore = null;

  // â† ã“ã‚Œã‚’è¿½åŠ ï¼ˆã‚¹ã‚³ã‚¢è¡¨ç¤ºåˆæœŸåŒ–ï¼‰
  displayTopHighScore();
});
/* =======================================================
   â–¼ ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†
   ======================================================= */
function startGame() {
  if (!gameOver && firstInteraction) return;
  firstInteraction = true;
    // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢éè¡¨ç¤º
  const titleScreen = document.getElementById("titleScreen");
  displayTopHighScore(); // â† å…ˆã«è¡¨ç¤ºã™ã‚‹ï¼ˆéè¡¨ç¤ºã«ã™ã‚‹å‰ï¼ï¼‰
  if (titleScreen) {
    titleScreen.style.display = "none";
    document.getElementById("moveInstruction").style.display = "none";
    document.getElementById("parryInstruction").style.display = "none";
  }
  allObstacles.forEach(obj => obj.remove());
  allObstacles.length = 0;
  scrollBackground();
  
  /* â˜…â˜…â˜…â˜…â˜… ã“ã“ã‹ã‚‰éŸ³é‡ãƒ—ãƒªã‚»ãƒƒãƒˆ â˜…â˜…â˜…â˜…â˜… */
  const BGM_VOLUME = 0.8;   // â† å¥½ã¿ã«åˆã‚ã›ã¦æ•°å€¤ã‚’å¤‰ãˆã‚‹
  const SE_VOLUME  = 0.8;   // â† SE å…¨èˆ¬ã®åŸºæœ¬éŸ³é‡

  // å¿…è¦ãª SE ãŒå¢—ãˆãŸã‚‰é…åˆ—ã«è¿½åŠ ã—ã¦ä¸‹ã•ã„
  [seParry, seDodge, seBombL, seItem, seJustParry].forEach(se => se.volume = SE_VOLUME);

  // BGM ã¯ fadeInBGM / crossfadeBGM å†…ã§ targetVolume ã‚’èª­ã‚€ã‚ˆã†ã«ã™ã‚‹
  [bgm.Stage1, bgm.Stage2, bgm.Stage3, bgm.Final, bgm.Final2, bgm.Result].forEach(bgm => {
    bgm.dataset.targetVolume = BGM_VOLUME;   // <- ç›®æ¨™éŸ³é‡ã‚’è¨˜æ†¶
  });
  /* â˜…â˜…â˜…â˜…â˜… ã“ã“ã¾ã§éŸ³é‡ãƒ—ãƒªã‚»ãƒƒãƒˆ â˜…â˜…â˜…â˜…â˜… */
  
  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ã¨ã‚ªãƒ•ã‚»ãƒƒãƒˆãƒ»ãƒ¬ãƒ™ãƒ«ãƒ»çµŒé¨“å€¤ãªã©ã‚’åˆæœŸåŒ–
  level = 1;
  exp = 0;
  maxLives = 3;
  lives = maxLives;
  playerSpeed = 3;
  scrollSpeed = 0.3;        // ã‚¹ãƒ†ãƒ¼ã‚¸1ã®é€Ÿåº¦ã«æˆ»ã™
  backgroundOffset = 0;     // èƒŒæ™¯ä½ç½®ã‚‚ãƒªã‚»ãƒƒãƒˆ

  setStageBackgroundSpeed(1);  // æ˜ç¤ºçš„ã«ã‚¹ãƒ†ãƒ¼ã‚¸1ã¨ã—ã¦é€Ÿåº¦è¨­å®šï¼ˆâ†ã‚ˆã‚Šå …å®Ÿï¼‰
  // èƒŒæ™¯ç”»åƒã‚’å³è¡¨ç¤ºï¼ˆã‚²ãƒ¼ãƒ é–‹å§‹ç›´å¾Œã«1æšç›®ã‚’è¡¨ç¤ºï¼‰
  updateBackgroundInstant(1); 
  
  // å¤‰æ•°åˆæœŸåŒ–
  gameOver = false;
  gameStarted = true; 
  score = 0;
  lives = maxLives = 3;
  parryGauge = 0;
  startTime = Date.now();
  lastScoreUpdateTime = 0;        // âœ… â† ã“ã‚Œã‚’è¿½åŠ ï¼ˆã‚¹ã‚³ã‚¢åŠ ç®—å†é–‹ã®ãŸã‚ï¼‰
  gameTime = 0;                   // âœ… â† ã‚¿ã‚¤ãƒ ã‚‚ã‚¼ãƒ­ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
  resetObstacleSpawn(); // â† ã“ã“ã ã‘ã«ã™ã‚‹ 
  
  // BGM åˆæœŸåŒ–ã¨å†ç”Ÿ
  [bgm.Stage1, bgm.Stage2, bgm.Stage3, bgm.Final, bgm.Final2, bgm.Result].forEach(bgm => {
    bgm.pause();
    bgm.currentTime = 0;
    bgm.volume = 0;
  });
  
  stage = 0;
  currentBGM = null;
  checkStage();

  // UI åˆæœŸåŒ–
  gameClear.style.display = "none";
  restartButton.style.display = "none";
//exitButton.style.display = "none"; // â† ã“ã‚Œã‚’è¿½åŠ ï¼
  updateUI();

  // ã‚¿ã‚¤ãƒãƒ¼å†è¨­å®š
  clearInterval(obstacleGenerationInterval);
  clearInterval(scoreUpdateInterval);
  clearInterval(timeUpdateInterval);

  scoreUpdateInterval = setInterval(updateScore, 100);
  timeUpdateInterval = setInterval(updateTime, 30);
}

// æœ€åˆã®å…¥åŠ›ã§èµ·å‹•
window.addEventListener("mousedown", startGame, { once: true });
window.addEventListener("keydown",   startGame, { once: true });
restartButton.addEventListener("click", startGame);

// å†ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³å‡¦ç†
restartButton.addEventListener("click", startGame);
// å†ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³å‡¦ç†ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰â† è¿½åŠ 
restartButton.addEventListener("touchstart", (e) => {
  e.preventDefault(); // iOSã§ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ»é¸æŠãªã©é˜²æ­¢
  startGame();
});

// ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ï¼šã‚¹ãƒãƒ›å¯¾å¿œ
titleScreen.addEventListener("touchstart", () => {
  if (!gameStarted) startGame();
});
/* =======================================================
   â–¼ ã‚²ãƒ¼ãƒ çµ‚äº†ã‚¹ãƒãƒ›å¯¾å¿œ
   ======================================================= */
function handleExit() {
  const closed = window.close(); // é–‰ã˜ã‚ˆã†ã¨è©¦ã¿ã‚‹ï¼ˆâ€»å¤šãã®ã‚¹ãƒãƒ›ã§ç„¡åŠ¹ï¼‰
  alert("ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚");
}
/* =======================================================
   â–¼ ãƒãƒ¼ã‚ºæ©Ÿèƒ½å‡¦ç†
   ======================================================= */
function pauseGame() {
  pauseStart = Date.now(); 
  
  clearInterval(obstacleGenerationInterval);
  clearInterval(scoreUpdateInterval);
  clearInterval(timeUpdateInterval);
  if (currentBGM) currentBGM.pause();
}

// â–¼ ãƒãƒ¼ã‚ºï¼å†é–‹ãƒœã‚¿ãƒ³å‡¦ç†
const pauseButton = document.getElementById("pauseButton");
const resumeButton = document.getElementById("resumeButton");
const pauseOverlay = document.getElementById("pauseOverlay");

pauseButton.addEventListener("click", () => {
  if (gameOver || gamePaused) return;

  pauseGame(); // æ—¢å­˜é–¢æ•°ã‚’å‘¼ã¶
  gamePaused = true;

  // UIåˆ‡æ›¿
  pauseOverlay.style.display = "block";
  pauseButton.style.display = "none";
  resumeButton.style.display = "inline";
});

resumeButton.addEventListener("click", () => {
  if (gameOver || !gamePaused) return;

  gamePaused = false;
  resumeGame();

  pauseOverlay.style.display = "none";
  pauseButton.style.display = "inline";
  resumeButton.style.display = "none";
});

// â–¼ å†é–‹å‡¦ç†ï¼ˆresumeGameï¼‰ã‚’è¿½åŠ 
function resumeGame() {
  const pauseEnd = Date.now(); 
  totalPausedTime += pauseEnd - pauseStart;
  
  if (currentBGM) currentBGM.play();

  scoreUpdateInterval = setInterval(updateScore, 100);
  timeUpdateInterval = setInterval(updateTime, 30);
  resetObstacleSpawn(); // â† å†é–‹æ™‚ã®éšœå®³ç‰©ç”Ÿæˆå†é–‹
}

/* =======================================================
   â–¼ éšœå®³ç‰©ä½œæˆãƒªã‚»ãƒƒãƒˆå‡¦ç†
   ======================================================= */
function resetObstacleSpawn() {
  if (obstacleSpawnInterval !== null) {
    clearInterval(obstacleSpawnInterval);
    console.log("æ—¢å­˜ã®spawnIntervalåœæ­¢");
  }

  // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸå‡ºç¾é–“éš”ã‚’å®šç¾©
  let baseInterval = 800;
  if (score >= 200000) baseInterval = 400;
  else if (score >= 150000) baseInterval = 500;
  else if (score >= 100000) baseInterval = 600;
  else if (score >= 50000) baseInterval = 700;

  console.log(`[resetObstacleSpawn] baseInterval = ${baseInterval}`);

  obstacleSpawnInterval = setInterval(() => {
    if (!gameOver) createObstacle();
  }, baseInterval);
}

/* =======================================================
   â–¼ éšœå®³ç‰©ä½œæˆå‡¦ç†
   ======================================================= */
function createObstacle() {
  if (gameOver || isPaused) return;
  const item = document.createElement("div");
  item.classList.add("obstacle");

  let sizeOption;
  let colorClass = "";
  let fallSpeed;

  // speedScaleã‚’scoreã«åŸºã¥ã„ã¦è¨ˆç®—
  let speedScale = 1.0;
  if (score >= 150000) {
    const additionalScale = Math.min(Math.floor(score / 150000) * 1.5, 6.0);
    speedScale += additionalScale;
  }
  speedScale = Math.min(speedScale, 10.0);

  // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥å‡ºç¾å†…å®¹
if (stage === 1) {
  sizeOption = Math.random() < 0.6 ? "small" : "big";
  colorClass = "red";
  fallSpeed = sizeOption === "small" ? 4 * speedScale : 3 * speedScale;
} else if (stage === 2) {
  sizeOption = Math.random() < 0.7 ? "small" : "big";
  colorClass = "blue";
  fallSpeed = sizeOption === "small" ? 4 * speedScale : 5 * speedScale;
} else if (stage === 3) {
  sizeOption = Math.random() < 0.8 ? "big" : "huge";
  colorClass = "green";
  fallSpeed = sizeOption === "big" ? 5 * speedScale : 2 * speedScale;
} else if (stage === 4 || stage === 5) { // âœ… ã‚¹ãƒ†ãƒ¼ã‚¸4ã¨5ã‚’çµ±åˆ
  const randomChoice = Math.random();
  if (randomChoice < 0.3) {
    sizeOption = "huge";
    colorClass = "red";
    fallSpeed = 3 * speedScale;
  } else if (randomChoice < 0.4) {
    sizeOption = "huge";
    colorClass = "blue";
    fallSpeed = 2 * speedScale;
  } else {
    sizeOption = "small";
    colorClass = "green";
    fallSpeed = 6 * speedScale;
  }
  item.classList.add("stage4"); // âœ… å¿…è¦ã«å¿œã˜ã¦ "stage5" ã«å¤‰æ›´å¯ï¼ˆæ¼”å‡ºãŒé•ã†å ´åˆï¼‰
}


  // â–¼ GIFç”»åƒã®è¡¨ç¤º
  const img = document.createElement("img");
  const sizeStr = sizeOption;
  const colorInitial = colorClass[0].toUpperCase();
  img.src = `enm_${sizeStr}_${colorInitial}.gif`;
  img.className = "obstacle-img";

  if (sizeOption === "small") {
    img.style.width = "60px";
    img.style.height = "60px";
  } else if (sizeOption === "big") {
    img.style.width = "100px";
    img.style.height = "100px";
  } else {
    img.style.width = "180px";
    img.style.height = "180px";
  }

  img.style.position = "absolute";
  img.style.left = "50%";
  img.style.top = "50%";
  img.style.transform = "translate(-50%, -50%)";
  img.style.pointerEvents = "none";
  item.appendChild(img);

  // è¡¨ç¤ºã‚µã‚¤ã‚ºï¼ˆãƒ’ãƒƒãƒˆãƒœãƒƒã‚¯ã‚¹ã‚‚å®šç¾©ï¼‰
  if (sizeOption === "small") {
    item.style.width = "60px";
    item.style.height = "60px";
    item.dataset.hitboxW = 60;
    item.dataset.hitboxH = 60;
  } else if (sizeOption === "big") {
    item.style.width = "92px";
    item.style.height = "92px";
    item.dataset.hitboxW = 92;
    item.dataset.hitboxH = 92;
  } else if (sizeOption === "huge") {
    item.style.width = "172px";
    item.style.height = "172px";
    item.dataset.hitboxW = 172;
    item.dataset.hitboxH = 172;
  }

  item.style.background = "none";
  item.style.backgroundColor = "transparent";

  // ã‚³ãƒªã‚¸ãƒ§ãƒ³æƒ…å ±
  const hp = sizeOption === "small" ? 1 : sizeOption === "big" ? 2 : 3;
  item.dataset.hp = hp;
  item.dataset.type = "damage";
  item.dataset.stage = stage;

  item.classList.add("obstacle");
//item.classList.add("debug");

  // è¡¨ç¤ºä½ç½®ï¼ˆ40pxã‚°ãƒªãƒƒãƒ‰ï¼‰
  item.style.left = Math.floor(Math.random() * 9) * 40 + "px";
  item.style.top = "0px";

  game.appendChild(item);
  allObstacles.push(item);

  let y = 0;
  const fall = setInterval(() => {
    if (gameOver || !item.parentElement) return clearInterval(fall);
    if (isPaused) return;  
    y += fallSpeed;
    item.style.top = y + "px";

    const playerRect = hitbox.getBoundingClientRect();
    const itemRect = getAdjustedRect(item); 
    // ä»®è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç¢ºèªç”¨ï¼‰
  //drawCollisionBox(itemRect, "rgba(0, 255, 0, 0.3)");
  //drawCollisionBox(playerRect, "rgba(0, 0, 255, 0.3)");

    // ãƒ‘ãƒªã‚£åˆ¤å®š
    if (parryActive && item.dataset.type === "damage") {
      if (checkCollision(playerRect, itemRect)) {
        const isJust = justParry;
        parryGauge++;
        if (parryGauge > maxGauge) parryGauge = maxGauge;
        reflectObstacle(item, isJust);
        updateUI();
        clearInterval(fall);
        return;
      }
    }

    // é€šå¸¸ãƒ’ãƒƒãƒˆ
    if (checkCollision(playerRect, itemRect)) {
      if (!invincible) {
        const dmg = parseInt(item.dataset.hp);
        lives -= dmg;
        if (lives <= 0) endGame();
        setInvincible();
      }
      item.remove();
      updateUI();
      clearInterval(fall);
      return;
    }
    // ç”»é¢å¤–ã¸ã§ãªã„
    if (y > 600) {
      item.remove();
      clearInterval(fall);
    }
  }, 30);
}

/** â˜… æŒ‡å®šãƒŸãƒªç§’ã§éšœå®³ç‰©ç”Ÿæˆã‚¿ã‚¤ãƒãƒ¼ã‚’å†ã‚»ãƒƒãƒˆ */
function setObstacleTimer(interval) {
  clearInterval(obstacleTimerId);
  obstacleTimerId = setInterval(() => {
    if (!gameOver) createObstacle();
  }, interval); // â† interval ã¯ baseInterval ã‚’å—ã‘å–ã‚‹ã¯ãš
}

//åˆæœŸéšœå®³ç‰©ç™ºç”Ÿé–“éš”
/* ==== ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦ç”Ÿæˆé–“éš”ã‚’æ›´æ–° ==== */
function startObstacleGeneration(){
  // åˆå›èµ·å‹•
  setObstacleTimer(800);
}

/** â˜… ã‚¹ã‚³ã‚¢æ›´æ–°ã”ã¨ã«å‘¼ã¶ï¼ˆupdateScore å†…ã®æœ€å¾Œã«ï¼‘è¡Œè¿½åŠ ã™ã‚Œã°ï¼¯ï¼«ï¼‰ */
function updateObstacleIntervalByScore(score) {
  const newInterval = Math.max(200, 800 - Math.floor(score / 200000) * 200); // â† ã“ã‚ŒãŒå¿…è¦ï¼
  const previousInterval = baseInterval;

  if (newInterval !== baseInterval) {
    baseInterval = newInterval;
    console.log(`[ã‚¹ã‚³ã‚¢æ›´æ–°] score=${score}, baseIntervalå¤‰æ›´: ${previousInterval} â†’ ${baseInterval}`);
    resetObstacleSpawn();
  }
}

/* =======================================================
   â–¼ ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œ
   ======================================================= */
function updateStage() {
  const prev = stage;

  if (score >= 600000) {
    stage = 5; // âœ… æ–°ã‚¹ãƒ†ãƒ¼ã‚¸5
  } else if (score >= 150000) {
    stage = 4;
  } else if (score >= 100000) {
    stage = 3;
  } else if (score >=  50000) {
    stage = 2;
  } else {
    stage = 1;
  }

  if (stage !== prev) {
    crossfadeBackground(stage);          // èƒŒæ™¯ã®ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰
    setStageBackgroundSpeed(stage);      // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦å¤‰æ›´
  }
}


/* =======================================================
   â–¼ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡Œå‹•å‡¦ç†
   ======================================================= */
// å›é¿ç§»å‹•é–¢æ•°
function dodge(dir) {
  if (isDodging) return;
  isDodging = true;
  speedBoost = true;
    // ğŸ”Š å›é¿SEã‚’å†ç”Ÿ
  if (seDodge) {
    seDodge.currentTime = 0;
    seDodge.play();
  }
  setInvincible(300);  // ç„¡æ•µæ™‚é–“
  player.classList.add("dodging");

  // ğŸ”µ é’ã„å…‰ã‚’ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«è¿½åŠ 
  const flare = document.createElement("div");
  flare.className = "dodge-flare";
  player.appendChild(flare);

  const startX = playerX;
  spawnAfterImage(startX); // 1ã‚¹ãƒ†ãƒƒãƒ—ç›®ã®å‰

  for (let i = 0; i < 2; i++) {
    const delta = dir === "ArrowLeft" ? -STEP_PX : STEP_PX;
    playerX = Math.max(0, Math.min(360, playerX + delta));
    player.style.left = playerX + "px";
    hitbox.style.left = (playerX + 4) + "px";

    if (i === 0) spawnAfterImage(playerX); // 1ã‚¹ãƒ†ãƒƒãƒ—å¾Œã®æ®‹åƒ
  }

  setTimeout(() => {
    speedBoost = false;
    isDodging = false;
    player.classList.remove("dodging");
    flare.remove(); // ğŸ”µ é’ã„å…‰ã‚’é™¤å»
  }, 300);
}

/* æ®‹åƒç”Ÿæˆ 0.1 s */
function spawnAfterImage(xPos){
  const img = document.createElement("div");
  img.className = "afterimage";
  img.style.left = xPos + "px";
  img.style.bottom = "10px";
  img.style.backgroundImage = 'url("chr_moth.gif")';
  img.style.backgroundSize = 'cover';
  game.appendChild(img);
  setTimeout(() => img.remove(), 100);
}
/* â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…  å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©ã“ã“ã‹ã‚‰  â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   - âŒ¨  â† â†’ / Aãƒ»Dï¼šæŠ¼ã—ã£ã±ã§é€šå¸¸ç§»å‹•ã€0.2s ä»¥å†…ã® 2 å›æŠ¼ã—ã§ dodge()
   - ğŸ–±  ã‚¯ãƒªãƒƒã‚¯  ï¼šparry
   - ğŸ¤š ã‚¿ãƒƒãƒ     ï¼šå·¦ãƒ»å³ãƒ»ãƒ‘ãƒªã‚£
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…±é€šç§»å‹•å‡¦ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ã‚¹ãƒãƒ›ã§ã®é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆç”»åƒä¿å­˜ãªã©ï¼‰ã‚’ç„¡åŠ¹åŒ–
document.addEventListener("contextmenu", e => e.preventDefault());
let isTouchHolding = false;
let touchHoldInterval = null;

function stepMove(dir){
  if (gameOver || isPaused) return;
  const delta = speedBoost ? playerSpeed * 2 : playerSpeed;

  if (dir === "ArrowLeft")  playerX = Math.max(0,   playerX - delta);
  if (dir === "ArrowRight") playerX = Math.min(360, playerX + delta);

  player.style.left = playerX + "px";
  hitbox.style.left = (playerX + 4) + "px";
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—åˆ¤å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleTap(dirKey){
  const now = performance.now();
  if (isTouchHolding) return; // æŠ¼ã—ã£ã±ä¸­ã¯ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ç„¡è¦–

  if (lastKey === dirKey && now - lastKeyTime <= DOUBLE_TAP_MS){
    dodge(dirKey);
    lastKey = "";
  } else {
    lastKey = dirKey;
    lastKeyTime = now;
    stepMove(dirKey);
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PCã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("keydown", e => {
  if (gameOver) return;

  const key = e.key;

  // ğŸ”¶ ãƒ‘ãƒªã‚£ï¼šFã‚­ãƒ¼ã¾ãŸã¯Enterã‚­ãƒ¼ã§ç™ºå‹•
  if (key === "f" || key === "F" || key === "Enter") {
    activateParry();
    return; // ãƒ‘ãƒªã‚£ç™ºå‹•å¾Œã¯ä»–ã®å‡¦ç†ã‚’ã—ãªã„
  }

  // â¬…ï¸â¡ï¸ å·¦å³ã‚­ãƒ¼å‡¦ç†ï¼ˆç§»å‹•ï¼å›é¿ï¼‰
  const isLeft  = key === "ArrowLeft"  || key === "a" || key === "A";
  const isRight = key === "ArrowRight" || key === "d" || key === "D";

  if (!isLeft && !isRight) return;

  const dirKey = isLeft ? "ArrowLeft" : "ArrowRight";
  keyPressed[dirKey] = true;

  if (e.repeat) {
    stepMove(dirKey);
  } else {
    handleTap(dirKey);
  }
});
document.addEventListener("keyup", e => {
  const key = e.key;
  if (key === "ArrowLeft"  || key === "a" || key === "A") keyPressed["ArrowLeft"]  = false;
  if (key === "ArrowRight" || key === "d" || key === "D") keyPressed["ArrowRight"] = false;
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ PCã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ‘ãƒªã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
game.addEventListener("mousedown", () => {
  if (gameOver) return;
  activateParry();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚¹ãƒãƒ›ã‚¿ãƒƒãƒãƒ‘ãƒªã‚£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
game.addEventListener("touchstart", e => {
  e.preventDefault();
  if (gameOver) return;
  activateParry();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚¹ãƒãƒ›ï¼šæŠ¼ã—ã£ã±ï¼†ã‚¿ãƒƒãƒ—å¯¾å¿œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startTouchHold(dirKey) {
  isTouchHolding = true;
  stopTouchHold();
  keyPressed[dirKey] = true;
  touchHoldInterval = setInterval(() => {
    stepMove(dirKey);
  }, 30);
}

function stopTouchHold() {
  clearInterval(touchHoldInterval);
  touchHoldInterval = null;
  isTouchHolding = false;
  keyPressed["ArrowLeft"] = false;
  keyPressed["ArrowRight"] = false;
}

// å·¦ãƒœã‚¿ãƒ³
btnLeft.addEventListener("touchstart", e => {
  e.preventDefault();
  startTouchHold("ArrowLeft");
});
btnLeft.addEventListener("touchend", e => {
  e.preventDefault();
  stopTouchHold();
  handleTap("ArrowLeft");
});
btnLeft.addEventListener("touchcancel", stopTouchHold);

// å³ãƒœã‚¿ãƒ³
btnRight.addEventListener("touchstart", e => {
  e.preventDefault();
  startTouchHold("ArrowRight");
});
btnRight.addEventListener("touchend", e => {
  e.preventDefault();
  stopTouchHold();
  handleTap("ArrowRight");
});
btnRight.addEventListener("touchcancel", stopTouchHold);

// ã‚¹ãƒãƒ›ãƒ‘ãƒªã‚£ãƒœã‚¿ãƒ³ï¼ˆã‚¿ãƒƒãƒ—å¯¾å¿œï¼‰
btnParry.addEventListener("touchstart", e => {
  e.preventDefault();
  activateParry();
});
// ğŸ”½ ãƒãƒ¼ã‚ºãƒœã‚¿ãƒ³ã§ã‚²ãƒ¼ãƒ ä¸€æ™‚åœæ­¢
pauseButton.addEventListener("click", () => {
  isPaused = true;
  pauseOverlay.style.display = "flex";
  pauseButton.style.display = "none";
  resumeButton.style.display = "inline";
});

// ğŸ”½ å†é–‹ãƒœã‚¿ãƒ³ã§ã‚²ãƒ¼ãƒ å†é–‹
resumeButton.addEventListener("click", () => {
  isPaused = false;
  pauseOverlay.style.display = "none";
  pauseButton.style.display = "inline";
  resumeButton.style.display = "none";
});
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æŠ¼ã—ã£ã±ç§»å‹•ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¹ãƒãƒ›/PCå…±é€šï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setInterval(() => {
  if (isPaused) return;
  if (keyPressed["ArrowLeft"])  stepMove("ArrowLeft");
  if (keyPressed["ArrowRight"]) stepMove("ArrowRight");
}, 30);

/* â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…  å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©ã“ã“ã¾ã§  â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… */

  // ã‚¿ã‚¤ãƒ ã®æ›´æ–°ï¼ˆãƒŸãƒªç§’å˜ä½ï¼‰
  function updateTime() {
    if (isPaused) return;
    if (gameOver) return; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«ã¯ã‚¿ã‚¤ãƒ æ›´æ–°ã—ãªã„
    gameTime = (Date.now() - startTime - totalPausedTime); // âœ… ãƒãƒ¼ã‚ºæ™‚é–“ã‚’é™¤å¤–
    timeEl.innerHTML = `ã‚¿ã‚¤ãƒ : ${(gameTime / 1000).toFixed(3)}ç§’`;  // å°æ•°ç‚¹ä»¥ä¸‹3æ¡ã§è¡¨ç¤º
    
      // ğŸ‘‡ ã“ã“ã«ã‚‚ãƒ­ã‚°ã‚’è¿½åŠ 
//console.log("ğŸ•’ ã‚¿ã‚¤ãƒ é€²è¡Œä¸­ gameTime =", gameTime);
  }

// ã‚¹ã‚³ã‚¢ã®æ›´æ–° â”€ 100ms ã”ã¨ã« +10 åŠ ç®—ã—æ•´æ•°ã§è¡¨ç¤º & ã‚¹ãƒ†ãƒ¼ã‚¸/BGM åˆ¤å®šã‚‚å®Ÿæ–½
function updateScore() {
  if (isPaused) return;
  if (gameOver) return;                       // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ä¸­ã¯æ›´æ–°ã—ãªã„

  const elapsed = Date.now() - startTime;     // çµŒéãƒŸãƒªç§’
  const tick    = Math.floor(elapsed / 100);  // 100ms å˜ä½ã®ã‚«ã‚¦ãƒ³ã‚¿

  // 100ms é€²ã‚“ã ã‚‰ã‚¹ã‚³ã‚¢åŠ ç®—
  if (tick > lastScoreUpdateTime) {
    lastScoreUpdateTime = tick;
    score += 10;

    /* â–¼ ã“ã“ã§ã‚¹ãƒ†ãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ & BGM ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã‚’åˆ¤å®š */
    if (typeof checkStage === "function") {
      checkStage();   // â† äº‹å‰ã«è¿½åŠ ã—ãŸ checkStage() ã‚’å‘¼ã¶
    }

    // UI åæ˜ ï¼ˆå°æ•°ç‚¹ä»¥ä¸‹ãªã—ï¼‰
    scoreEl.textContent = "ã‚¹ã‚³ã‚¢: " + Math.floor(score);
    updateObstacleIntervalByScore(score);
  }
}

/* =======================================================
   â–¼ UIã®æ›´æ–°å‡¦ç†
   ======================================================= */
function updateUI() {
  // ãƒãƒ¼ãƒˆã®æ•°è¡¨ç¤ºï¼ˆè² ã®repeatå¯¾ç­–ã‚ã‚Šï¼‰
  livesEl.innerHTML =
    "â¤ï¸".repeat(Math.max(0, lives)) +
    "ğŸ–¤".repeat(Math.max(0, maxLives - lives));

  // ãƒ¬ãƒ™ãƒ«è¡¨ç¤º
  levelEl.textContent = "Lv. " + level;

  // çµŒé¨“å€¤è¡¨ç¤º
  if (level < maxLevel) {
    expEl.textContent = `EXP: ${exp} / ${level * 200}`;
  } else {
    expEl.textContent = `EXP: MAX`;
  }

  // ã‚¹ã‚³ã‚¢è¡¨ç¤º
  scoreEl.textContent = "ã‚¹ã‚³ã‚¢: " + score;
}

/* =======================================================
   â–¼ çµŒé¨“å€¤è¿½åŠ 
   ======================================================= */
function addExp(amount) {
  if (level >= maxLevel) return;

  exp += amount;
  let threshold = level * 200;

  while (exp >= threshold && level < maxLevel) {
    exp -= threshold;
    level++;
    maxLives++;
    lives = Math.min(lives + 1, maxLives);
    playerSpeed *= 1.05;
    threshold = level * 200;
  }

  updateUI();
}
/* =======================================================
   â–¼ ãƒ‘ãƒªã‚£/ã‚¸ãƒ£ã‚¹ãƒˆãƒ‘ãƒªã‚£
   ======================================================= */
   function activateParry() {
   if (gameOver || isPaused) return;
  // ãƒ‘ãƒªã‚£ã®é€£å°„é˜²æ­¢ï¼ˆã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã¨ç™ºå‹•ä¸­ãƒã‚§ãƒƒã‚¯ï¼‰
  if (parryActive || Date.now() - lastParryTime < PARRY_COOLDOWN) return;
  lastParryTime = Date.now();

  seParry.play();         // åŠ¹æœéŸ³å†ç”Ÿ
  setInvincible(380);     // ç„¡æ•µæ™‚é–“ï¼ˆ0.38ç§’ï¼‰

  parryActive = true;
  justParry = false;

  // é€šå¸¸ãƒ‘ãƒªã‚£ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
  const effect = document.createElement("img");
  effect.src = "eff_parry.gif";
  effect.style.position = "absolute";
  effect.style.left = (player.offsetLeft + player.offsetWidth / 2 - 45) + "px";
  effect.style.top = (player.offsetTop + player.offsetHeight / 2 - 45) + "px";
  effect.style.width = "90px";
  effect.style.height = "90px";
  effect.style.pointerEvents = "none";
  effect.style.zIndex = "3";
  game.appendChild(effect);

  // é€šå¸¸ãƒ‘ãƒªã‚£ã¯0.35ç§’è¡¨ç¤º â†’ ã‚¸ãƒ£ã‚¹ãƒˆã§ãªã‘ã‚Œã°å‰Šé™¤
  setTimeout(() => {
    if (!justParry) effect.remove();
  }, 350);

  // ---------------- â‘¡ ã‚¸ãƒ£ã‚¹ãƒˆãƒ‘ãƒªã‚£åˆ¤å®š ----------------
  setTimeout(() => {
    const pRect = player.getBoundingClientRect();
    const pcx = (pRect.left + pRect.right) / 2;
    const pcy = (pRect.top + pRect.bottom) / 2;

    document.querySelectorAll(".obstacle").forEach(obs => {
      const oRect = obs.getBoundingClientRect();

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ä¸­å¿ƒã‹ã‚‰éšœå®³ç‰©ã®ã‚¨ãƒƒã‚¸ã¾ã§ã®æœ€çŸ­è·é›¢
      const dx = Math.max(oRect.left - pcx, 0, pcx - oRect.right);
      const dy = Math.max(oRect.top - pcy, 0, pcy - oRect.bottom);
      const dist = Math.hypot(dx, dy);

      if (!justParry && dist <= 42) {  // åˆ¤å®šè·é›¢ï¼š42pxä»¥å†…
        justParry = true;

        // eff_parry.gifã‚’å‰Šé™¤
        effect.remove();
        showJustParry();  // â† ã“ã“ã§å‘¼ã¶
        
        // ---------------- â‘¢ eff_just_parry.gif ã‚’è¡¨ç¤º ----------------
        const jSize = 60;
        const j = document.createElement("img");
        j.src = "eff_just_parry.gif";
        j.style.position = "absolute";
        j.style.left = (player.offsetLeft + player.offsetWidth / 2 - jSize / 2) + "px";
        j.style.top = (player.offsetTop + player.offsetHeight / 2 - jSize / 2) + "px";
        j.style.width = jSize + "px";
        j.style.height = jSize + "px";
        j.style.pointerEvents = "none";
        j.style.zIndex = "3";
        game.appendChild(j);
        setTimeout(() => j.remove(), 600);
      }
    });
  }, 80); // åˆ¤å®šã‚¿ã‚¤ãƒŸãƒ³ã‚°

  // ---------------- â‘£ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è§£é™¤ ----------------
  setTimeout(() => {
    parryActive = false;
    justParry = false;
  }, PARRY_COOLDOWN);
}

/* ===== helper : eff_just_parry.gif ã‚’ 0.6s ã ã‘è¡¨ç¤º ===== */
function showJustParry() {
  const justParryEffect = document.getElementById("justParryEffect");
  if (!justParryEffect) return;

  // å†ç”Ÿä½ç½®èª¿æ•´ï¼ˆä¸­å¤®ã«è¡¨ç¤ºï¼‰
  justParryEffect.style.display = "block";
  justParryEffect.style.left = (player.offsetLeft + player.offsetWidth / 2 - justParryEffect.offsetWidth / 2) + "px";
  justParryEffect.style.top  = (player.offsetTop + player.offsetHeight / 2 - justParryEffect.offsetHeight / 2) + "px";

  // ğŸ”Š SEå†ç”Ÿï¼ˆåŠ¹æœéŸ³ï¼‰
  if (typeof seJustParry !== "undefined" && seJustParry) {
    seJustParry.currentTime = 0;
    seJustParry.play().catch(e => console.warn("JustParryéŸ³å†ç”Ÿå¤±æ•—:", e));
  }

  // 0.5ç§’å¾Œã«éè¡¨ç¤º
  setTimeout(() => {
    justParryEffect.style.display = "none";
  }, 500);
}

/* =======================================================
   â–¼ è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸æ™‚ã®åŠé€æ˜å‡¦ç†
   ======================================================= */
  function setInvincible(duration = 1000) {
    invincible = true;
    player.style.opacity = "0.5";
    setTimeout(() => {
      invincible = false;
      player.style.opacity = "1";
    }, duration);
  }

/* =======================================================
   â–¼ çˆ†ç™ºç™ºç”Ÿå‡¦ç†
   ======================================================= */
function createExplosion(x, y, scoreValue = 0, isJust = false, noExplosion = false, expValue = 0) {
  // ---------- çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ----------
  if (!noExplosion) {
    const explosion = document.createElement("img");
    explosion.src = "eff_bomb_L.gif";
    explosion.style.position = "absolute";
    explosion.style.left = x + "px";  // â† ä½™è¨ˆãª +20 å‰Šé™¤
    explosion.style.top  = y + "px";
    explosion.style.width = "100px";
    explosion.style.height = "100px";
    explosion.style.transform = "translate(-50%, -50%)";
    explosion.style.pointerEvents = "none";
    explosion.style.zIndex = "10";
    game.appendChild(explosion);
      // ğŸ”Š çˆ†ç™ºéŸ³ã‚’å†ç”Ÿ
  if (seBombL) {
    seBombL.currentTime = 0;
    seBombL.play();
  }

    setTimeout(() => explosion.remove(), 400);
  }

  // ---------- ã‚¹ã‚³ã‚¢ + çµŒé¨“å€¤è¡¨ç¤º ----------
  if (scoreValue > 0) {
    const scoreText = document.createElement("div");
    scoreText.textContent = `+${scoreValue}${expValue > 0 ? `\nEXP+${expValue}` : ""}`;
    scoreText.style.position = "absolute";
    scoreText.style.left = x + "px";       // â† ä½™è¨ˆãª +20 å‰Šé™¤
    scoreText.style.top  = (y - 10) + "px";
    scoreText.style.fontSize = "12px";     // â† ä¸€æ®µéšå°ã•ã
    scoreText.style.fontWeight = "bold";
    scoreText.style.whiteSpace = "pre";    // æ”¹è¡Œã‚ã‚Š
    scoreText.style.color = isJust ? "yellow" : "white";
    scoreText.style.zIndex = "15";
    scoreText.style.pointerEvents = "none";
    scoreText.style.transform = "translate(-50%, 0px)";
    game.appendChild(scoreText);

    // æµ®ãä¸ŠãŒã£ã¦æ¶ˆãˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    let offset = 0;
    const floatUp = setInterval(() => {
      offset += 1;
      scoreText.style.transform = `translate(-50%, -${offset}px)`;
      if (offset > 50) {  // â† è¡¨ç¤ºæ™‚é–“ ç´„2ç§’ï¼ˆ40ms Ã— 50ï¼‰
        clearInterval(floatUp);
        scoreText.remove();
      }
    }, 40);
  }
}
/* =======================================================
   â–¼ çˆ†ç™ºç™ºç”Ÿå‡¦ç†è»½é‡åŒ–
   ======================================================= */
function safeCreateExplosion(x, y, score, isJust, isBomb, exp) {
  const now = Date.now();
  if (now - lastExplosionTime < 50) return;  // 50msä»¥å†…ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
  lastExplosionTime = now;

  createExplosion(x, y, score, isJust, isBomb, exp);
}
/* =======================================================
   â–¼ éšœå®³ç‰©ãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨ç¾
   ======================================================= */
  function applyHitFlash(obstacle) {
    obstacle.style.filter = "brightness(2)";
    setTimeout(() => {
      if (obstacle) obstacle.style.filter = "";
    }, 150);
  }
/* =======================================================
   â–¼ ã‚³ãƒªã‚¸ãƒ§ãƒ³åˆ¤å®š
   ======================================================= */
  function checkCollision(r1, r2) {
    return !(r1.top > r2.bottom || r1.bottom < r2.top || r1.left > r2.right || r1.right < r2.left);
  }

/* =======================================================
   â–¼ éšœå®³ç‰©ã‚³ãƒªã‚¸ãƒ§ãƒ³ã‚µã‚¤ã‚ºå¤‰æ›´ï¼ˆé«˜ã•ï¼‰
   ======================================================= */
function getAdjustedRect(elem) {
  const rect = elem.getBoundingClientRect();
  const newHeight = rect.height * 0.7;

  return {
    top: rect.bottom - newHeight,        // â† ä¸‹å¯„ã›ã«å¤‰æ›´
    bottom: rect.bottom,
    left: rect.left,
    right: rect.right,
    width: rect.width,
    height: newHeight
  };
}
/* =======================================================
   â–¼ éšœå®³ç‰©åŒå£«ã®ã‚³ãƒªã‚¸ãƒ§ãƒ³åˆ¤å®š
   ======================================================= */
function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh) {
  return (
    ax < bx + bw &&
    ax + aw > bx &&
    ay < by + bh &&
    ay + ah > by
  );
}

/* =======================================================
   â–¼ åå°„å‡¦ç†ï¼ˆåå°„ã§ãã‚‹éšœå®³ç‰©ã«å¯¾ã—ã¦åå°„ã‚’è¡Œã†ï¼‰
   ======================================================= */
function reflectObstacle(obstacle, isRainbow) {
  let hp = parseInt(obstacle.dataset.hp);
  obstacle.dataset.type = "reflected";
  obstacle.dataset.hp = hp;

  let y = parseInt(obstacle.style.top);
  let x = parseInt(obstacle.style.left);
  let vy = -obstacleSpeed * (isRainbow ? 1.5 : 1);

  if (isRainbow) obstacle.classList.add("rainbow");

  // æ‹¡å¤§ãƒ’ãƒƒãƒˆã‚µã‚¤ã‚ºã‚’ã‚»ãƒƒãƒˆï¼ˆ500msé™å®šï¼‰
  const originalW = obstacle.offsetWidth;
  const originalH = obstacle.offsetHeight;
  const expandedW = originalW * 1.2;
  const expandedH = originalH * 1.2;
  obstacle.dataset.hitboxW = expandedW;
  obstacle.dataset.hitboxH = expandedH;

  setTimeout(() => {
    if (obstacle && obstacle.parentElement) {
      obstacle.dataset.hitboxW = originalW;
      obstacle.dataset.hitboxH = originalH;
    }
  }, 500);

  const move = setInterval(() => {
    if (!obstacle.parentElement) return clearInterval(move);

    y += vy;
    obstacle.style.top = y + "px";
    
      // âœ… ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ã§å‡¦ç†é »åº¦ã‚’åŠåˆ†ã«åˆ¶å¾¡
    if (!obstacle.frameCount) obstacle.frameCount = 0;
    obstacle.frameCount++;
    if (obstacle.frameCount % 2 !== 0) return;

    const selfW = parseFloat(obstacle.dataset.hitboxW || originalW);
    const selfH = parseFloat(obstacle.dataset.hitboxH || originalH);
    const selfX = parseInt(obstacle.style.left);
    const selfY = y;

    for (let other of allObstacles) {
      if (other === obstacle || !other.parentElement) continue;

      const otherX = parseInt(other.style.left);
      const otherY = parseInt(other.style.top);
      const otherW = parseFloat(other.dataset.hitboxW || other.offsetWidth);
      const otherH = parseFloat(other.dataset.hitboxH || other.offsetHeight);

      if (!rectsOverlap(selfX, selfY, selfW, selfH, otherX, otherY, otherW, otherH)) {
        continue;
      }

      const hp1 = parseInt(obstacle.dataset.hp);
      const hp2 = parseInt(other.dataset.hp);
      const stageType = parseInt(other.dataset.stage || 1);

      let scoreAdd = 0;
      let expAdd = 0;

        // æ•µã®å¾—ç‚¹ã¨çµŒé¨“å€¤
      if (stageType === 1 || stageType === 2) {
        scoreAdd = hp2 === 2 ? 1500 : 1000;
        expAdd = hp2 === 2 ? 15 : 10;
      } else if (stageType === 3) {
        scoreAdd = hp2 === 3 ? 2500 : 1500;
        expAdd = hp2 === 3 ? 25 : 15;
      } else if (stageType === 4) {
        const imgSrc = other.querySelector("img")?.src || "";
        if (hp2 === 3 && imgSrc.includes("enm_huge_B")) {
          scoreAdd = 8000;
          expAdd = 80;
        } else if (hp2 === 3) {
          scoreAdd = 5000;
          expAdd = 50;
        } else if (hp2 === 1) {
          scoreAdd = 2000;
          expAdd = 20;
        }
      }

      if (isRainbow) {
        // ã‚¸ãƒ£ã‚¹ãƒˆãƒ‘ãƒªã‚£
        score += scoreAdd * 2;
        addExp(expAdd);
        safeCreateExplosion(otherX, otherY, scoreAdd * 2, true, false, expAdd);
        other.remove();
      } else {
        // é€šå¸¸ãƒ‘ãƒªã‚£
        if (hp1 === hp2) {
          score += scoreAdd;
          addExp(expAdd);
          safeCreateExplosion(otherX, otherY, scoreAdd, false, false, expAdd);
          obstacle.remove();
          other.remove();
          clearInterval(move);
        } else if (hp1 > hp2) {
          score += scoreAdd;
          addExp(expAdd);
          safeCreateExplosion(otherX, otherY, scoreAdd, false, false, expAdd);
          obstacle.dataset.hp = hp1 - 1;
          other.remove();
        } else {
          other.dataset.hp = hp2 - 1;
          other.style.opacity = "0.4";
          setTimeout(() => {
            if (other) other.style.opacity = "1";
        }, 150);
          obstacle.remove();
          clearInterval(move);
        }
      }

      updateUI();
    }

    if (y < 0) {
      obstacle.remove();
      clearInterval(move);
    }
  }, 30);
}

/* =======================================================
   â–¼ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢æ™‚ã®RANKåˆ¤å®š
   ======================================================= */
function getTimeRating(score, time) {
  const scorePerTime = score / time;  // ã‚¹ã‚³ã‚¢ Ã· ã‚¿ã‚¤ãƒ ï¼ˆç§’å˜ä½ã‚’æƒ³å®šï¼‰

  let rating = '';

  // RANKåŸºæº–ï¼ˆã‚¹ã‚³ã‚¢Ã·ã‚¿ã‚¤ãƒ ï¼‰
  if (scorePerTime >= 4.0) {
    rating = "V";
  } else if (scorePerTime >= 3.6) {
    rating = "SS";
  } else if (scorePerTime >= 3.2) {
    rating = "S";
  } else if (scorePerTime >= 2.8) {
    rating = "A";
  } else if (scorePerTime >= 2.4) {
    rating = "B";
  } else if (scorePerTime >= 2.0) {
    rating = "C";
  } else if (scorePerTime >= 1.6) {
    rating = "D";
  } else {
    rating = "E";
  }

  return rating;
}

  function getRating(score, time) {
    // â†ã“ã®ã‚ˆã†ã«è¿½åŠ 
    const spt = score / time;
    if (spt >= 4000) return "V";
    if (spt >= 3600) return "SS";
    if (spt >= 3200) return "S";
    if (spt >= 2800) return "A";
    if (spt >= 2400) return "B";
    if (spt >= 2000) return "C";
    if (spt >= 1600) return "D";
    return "E";
  }
/* =======================================================
   â–¼ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢å‡¦ç†
   ======================================================= */
function endGame() {
  gameOver = true;

  // BGMåœæ­¢
  bgm.Stage1.pause();
  bgm.Stage2.pause();
  bgm.Stage3.pause();
  bgm.Final.pause();
  if (bgm.Final2) bgm.Final2.pause(); // âœ… è¿½åŠ 

  // æ—¢ã«è¿½åŠ ã•ã‚ŒãŸGame Overãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Œã°å‰Šé™¤
  const existingOver = document.getElementById("gameOverText");
  if (existingOver) existingOver.remove();

  clearInterval(obstacleTimerId);

  // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
  if (score < 150000) {
    const gameOverText = document.createElement("h2");
    gameOverText.id = "gameOverText";   
    gameOverText.textContent = "Game Over!";
    gameOverText.style.color = "yellow";
    gameOverText.style.marginTop = "200px";
    game.appendChild(gameOverText);
    
    gameClear.style.display = "none";
    restartButton.style.display = "block";
    restartButton.style.pointerEvents = "auto"; // ã‚¹ãƒãƒ›ã§ã‚‚ç¢ºå®Ÿã«ã‚¿ãƒƒãƒ—å¯èƒ½ã«

  } else {
    // â–¼â–¼â–¼ã€ã“ã“ã«éšœå®³ç‰©å‰Šé™¤å‡¦ç†ã‚’è¿½åŠ ã€‘â–¼â–¼â–¼
    allObstacles.forEach(obj => obj.remove());
    allObstacles.length = 0;

    // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢å‡¦ç†
    const clearTime = (gameTime / 1000).toFixed(3);
    const rating = getTimeRating(score, gameTime);

    console.log("ã‚¹ã‚³ã‚¢:", score);
    console.log("ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒ ï¼ˆç§’ï¼‰:", clearTime);
    console.log("ã‚¹ã‚³ã‚¢ Ã· ã‚¿ã‚¤ãƒ :", score / gameTime);
    console.log("RANK:", rating);

    timeRatingEl.textContent = `RANK: ${rating}`;
    
    // âœ… â–¼â–¼â–¼ ã“ã“ã« Vãƒ©ãƒ³ã‚¯æ¼”å‡ºã‚’è¿½åŠ  â–¼â–¼â–¼
    if (rating.trim().toUpperCase() === "V") {
      // ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã«ç‰¹åˆ¥ãªè£…é£¾ã‚’ä»˜åŠ 
      timeRatingEl.classList.add("void-rank");
      
      // ã‚µãƒ–ãƒ†ã‚­ã‚¹ãƒˆã€ŒV - VOID RANKã€è¿½åŠ 
      const subtext = document.createElement("div");
      subtext.textContent = "V - VOID RANK";
      subtext.className = "void-subtext";
      timeRatingEl.parentElement.appendChild(subtext);
      
      // ç¾½æ ¹æ¼”å‡ºã‚’èµ·å‹•
      triggerVoidFeathers();
    }
    // âœ… â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²
    showMusicTitle("â™ªTwilight Flutter");
    
    gameClear.style.display = "flex";
    restartButton.style.display = "block";
    document.getElementById("thankYouText").style.display = "block";
    
    // âœ… è¡¨ç¤ºç”¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°
    displayHighScores();
    
    // âœ… UIè¡¨ç¤ºãŒçµ‚ã‚ã£ã¦ã‹ã‚‰ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯ã‚’å‘¼ã¶
    setTimeout(() => {
      checkAndRegisterHighScore(score, rating);
    }, 500); // è¡¨ç¤ºå®Œäº†å¾Œã€0.5ç§’ã§å‘¼ã³å‡ºã™
  }
    // âœ… ã‚¯ãƒªã‚¢BGMå†ç”Ÿ
    bgm.Result.currentTime = 0;
    bgm.Result.volume = 0.8;
    bgm.Result.play();
  
  updateUI();
}

setInterval(() => {
  if (gameStarted && !gameOver) {
    maybeSpawnHeart(); // ãƒãƒ¼ãƒˆç”Ÿæˆ
    maybeSpawnLemon(); // ãƒ¬ãƒ¢ãƒ³ç”Ÿæˆ
    updateStage();
  }
}, 1000);

/* =======================================================
   â–¼Vãƒ©ãƒ³ã‚¯ã®ç‰¹æ®Šç¾½æ ¹æ¼”å‡ºï¼ˆæ–°è¦è¿½åŠ é–¢æ•°ï¼‰
   ======================================================= */
function triggerVoidFeathers() {
  const container = document.getElementById("voidFeathers");
  const game = document.getElementById("game");
  if (!container || !game) return;

  container.innerHTML = "";
  container.style.display = "block";

  const featherCount = 20;
  const maxSpread = 240;
  const gravityY = 30;

  const gameRect = game.getBoundingClientRect();
  const centerX = gameRect.width / 2;
  const centerY = gameRect.height / 3;

  for (let i = 0; i < featherCount; i++) {
    const feather = document.createElement("div");
    feather.className = "feather";

    const angle = Math.PI + Math.random() * Math.PI;
    const radius = Math.random() * maxSpread;
    const dx = Math.cos(angle) * radius;
    const dy = Math.sin(angle) * radius + 180;

    const flyTimeSec = (5.0 + Math.random()).toFixed(2);
    const rotateSpeedSec = (8.0 + Math.random() * 2).toFixed(2);

    const startAngle = Math.floor(Math.random() * 360);
    const midAngle = startAngle + (Math.random() * 60 - 30);
    const endAngle = midAngle + (Math.random() * 60 - 30);

    feather.style.setProperty("--dx", dx);
    feather.style.setProperty("--dy", dy);
    feather.style.setProperty("--flyTime", `${flyTimeSec}s`);
    feather.style.setProperty("--rotateSpeed", `${rotateSpeedSec}s`);
    feather.style.setProperty("--startAngle", `${startAngle}deg`);
    feather.style.setProperty("--midAngle", `${midAngle}deg`);
    feather.style.setProperty("--endAngle", `${endAngle}deg`);

    feather.style.left = `${centerX}px`;
    feather.style.top = `${centerY}px`;

    // âœ… æ­£ã—ã„å ´æ‰€ã«è¿½åŠ ï¼ˆã“ã‚ŒãŒé‡è¦ï¼ï¼‰
    game.appendChild(feather); 

    // ã‚¢ãƒ‹ãƒ¡å¾Œå‰Šé™¤
    setTimeout(() => {
      feather.remove();
    }, parseFloat(flyTimeSec) * 1000 - 400);
  }
}

/* =======================================================
   â–¼ ãƒãƒ¼ãƒˆç”Ÿæˆ
   ======================================================= */
function maybeSpawnHeart() {
  // ãƒ©ã‚¤ãƒ•ãŒæº€ã‚¿ãƒ³ã®å ´åˆã¯ä½•ã‚‚å‡ºç¾ã—ãªã„
  if (lives >= maxLives) return;
  if (isPaused) return;

  let isGold = false;

  // ğŸ’› ã‚´ãƒ¼ãƒ«ãƒ‰ãƒãƒ¼ãƒˆå‡ºç¾æ¡ä»¶ï¼ˆãƒ©ã‚¤ãƒ•1ä»¥ä¸‹ã‹ã¤2%ï¼‰
  if (lives <= 1 && Math.random() < 0.02) {
    isGold = true;
  }
  // ğŸ’— é€šå¸¸ãƒãƒ¼ãƒˆå‡ºç¾æ¡ä»¶ï¼ˆ5%ï¼‰
  else if (Math.random() < 0.05) {
    isGold = false;
  } else {
    return; // ã©ã¡ã‚‰ã‚‚æ¡ä»¶ã‚’æº€ãŸã•ãªã‘ã‚Œã°å‡ºç¾ã—ãªã„
  }

  const heart = document.createElement("div");
  heart.classList.add("heal");
  heart.textContent = isGold ? "ğŸ’›" : "ğŸ’—";
  heart.style.left = Math.floor(Math.random() * 9) * 40 + "px";
  heart.style.top = "0px";
  game.appendChild(heart);

  let heartY = 0;
  const fallSpeed = isGold ? 8 : 5;

  const heartFall = setInterval(() => {
    if (heartY > 600) {
      heart.remove();
      clearInterval(heartFall);
      return;
    }

    heartY += fallSpeed;
    heart.style.top = heartY + "px";

    const heartRect = heart.getBoundingClientRect();
    const playerRect = hitbox.getBoundingClientRect();

    // ğŸ¯ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå–å¾—ã—ãŸå ´åˆ
    if (checkCollision(heartRect, playerRect)) {
      if (lives < maxLives) {
        lives = isGold ? maxLives : lives + 1;
        heart.remove();

        if (seItem) {
          seItem.currentTime = 0;
          seItem.play().catch(e => console.warn("ã‚¢ã‚¤ãƒ†ãƒ SEå†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));
        }

        updateUI();
        clearInterval(heartFall);
      }
      return;
    }

    // ğŸ’¥ åå°„éšœå®³ç‰©ã«å½“ãŸã£ãŸã‚‰ç ´å£Šï¼ˆSEãªã—ï¼‰
    for (let obstacle of allObstacles) {
      const obstacleRect = obstacle.getBoundingClientRect();
      if (checkCollision(heartRect, obstacleRect) && obstacle.dataset.type === "reflected") {
        heart.remove();
        clearInterval(heartFall);

        createExplosion(
          heartRect.left + heartRect.width / 2 - game.getBoundingClientRect().left,
          heartRect.top + heartRect.height / 2 - game.getBoundingClientRect().top,
          0, false, false
        );

        return;
      }
    }
  }, 30);
}

/* =======================================================
   â–¼ ãƒ¬ãƒ¢ãƒ³ç”Ÿæˆ
   ======================================================= */
function maybeSpawnLemon() {
  if (lives === maxLives && Math.random() < 0.03) {
    if (isPaused) return;
    const lemon = document.createElement("div");
    lemon.classList.add("heal");
    lemon.textContent = "ğŸ‹";
    lemon.style.left = Math.floor(Math.random() * 9) * 40 + "px";
    lemon.style.top = "0px";
    game.appendChild(lemon);

    let lemonY = 0;
    const lemonFall = setInterval(() => {
      if (lemonY > 600) {
        lemon.remove();
        clearInterval(lemonFall);
        return;
      }

      lemonY += 5;
      lemon.style.top = lemonY + "px";

      const lemonRect = lemon.getBoundingClientRect();
      const gameRect = game.getBoundingClientRect();
      const lemonCenterX = lemonRect.left + lemonRect.width / 2 - gameRect.left;
      const lemonCenterY = lemonRect.top + lemonRect.height / 2 - gameRect.top;

      const playerRect = hitbox.getBoundingClientRect();

      // ğŸ¯ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒãƒ¬ãƒ¢ãƒ³ã‚’å–å¾—ã—ãŸå ´åˆ
      if (checkCollision(lemonRect, playerRect)) {
        const lemonScore = 10000;
        const lemonExp = 300;

        createExplosion(lemonCenterX, lemonCenterY, lemonScore, false, true, lemonExp);

        score += lemonScore;
        addExp(lemonExp);

        // âœ… ã“ã“ã ã‘ã§ã‚¢ã‚¤ãƒ†ãƒ SEã‚’é³´ã‚‰ã™
        if (seItem) {
          seItem.currentTime = 0;
          seItem.play().catch(e => console.warn("ã‚¢ã‚¤ãƒ†ãƒ SEå†ç”Ÿã‚¨ãƒ©ãƒ¼:", e));
        }

        lemon.remove();
        updateUI();
        clearInterval(lemonFall);
        return;
      }

      // âš ï¸ åå°„ã•ã‚ŒãŸéšœå®³ç‰©ã«å½“ãŸã£ãŸå ´åˆã®ã¿ç ´å£Šï¼ˆSEãªã—ï¼‰
      for (let obstacle of allObstacles) {
        const obstacleRect = obstacle.getBoundingClientRect();
        if (checkCollision(lemonRect, obstacleRect) && obstacle.dataset.type === "reflected") {
          lemon.remove();
          clearInterval(lemonFall);

          // ğŸ”¥ çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¨SEï¼ˆã‚¢ã‚¤ãƒ†ãƒ SEã¯é³´ã‚‰ã•ãªã„ï¼‰
          createExplosion(lemonCenterX, lemonCenterY);
          return;
        }
      }

      // é€šå¸¸éšœå®³ç‰©ã«å½“ãŸã£ã¦ã‚‚æ¶ˆãˆãªã„ï¼ˆç„¡è¦–ï¼‰
    }, 30);
  }
}

// === 1. ã‚¢ã‚»ãƒƒãƒˆèª­ã¿è¾¼ã¿é–¢æ•° ===
function loadImage(src) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = resolve;
    img.onerror = reject;
    img.src = src;
  });
}
/* =======================================================
   â–¼ ã‚¢ã‚¤ãƒ†ãƒ å–å¾—SE
   ======================================================= */
function loadAudio(audioEl) {
  return new Promise((resolve, reject) => {
    audioEl.oncanplaythrough = resolve;
    audioEl.onerror = reject;
    audioEl.load();
  });
}
/* =======================================================
   â–¼ ãƒã‚¤ã‚¹ã‚³ã‚¢åå‰å…¥åŠ›
   ======================================================= */
function checkAndRegisterHighScore(score, rating) {
  console.log("âœ… checkAndRegisterHighScore ãŒå‘¼ã°ã‚Œã¾ã—ãŸ");
  console.log("ğŸ” score:", score, "rating:", rating);
  console.log("ğŸ’¬ enteringName:", enteringName, "newHighScore:", window.newHighScore);
  console.log("ğŸ“Œ gameStarted:", gameStarted, "gameOver:", gameOver);

  const coefficient = ratingCoefficients[rating] || 1.0;
  const newPower = score * coefficient;
  console.log("ğŸ§® RANKä¿‚æ•°:", coefficient, "â†’ ãƒ‘ãƒ¯ãƒ¼:", newPower);

  // âš ï¸ å‰å›ã® newHighScore ãŒæ®‹ã£ã¦ã„ãŸã‚‰ã‚¯ãƒªã‚¢ï¼ˆå¿µã®ãŸã‚ï¼‰
  if (gameStarted && gameOver && !enteringName && window.newHighScore) {
    console.log("ğŸ§¹ å‰å›ã® newHighScore ã‚’ãƒªã‚»ãƒƒãƒˆ");
    window.newHighScore = null;
  }

  if (enteringName || window.newHighScore) {
    console.log("âš ï¸ ã™ã§ã«åå‰ç™»éŒ²ä¸­ã¾ãŸã¯å®Œäº†æ¸ˆã¿ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚");
    return;
  }
  if (gameStarted === false || gameOver === false) {
    console.log("âš ï¸ ã‚²ãƒ¼ãƒ ãŒã¾ã çµ‚äº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚");
    return;
  }

  if (score < 150000 || !ratingCoefficients[rating]) {
    console.log("âŒ ã‚¹ã‚³ã‚¢ãŒåŸºæº–æœªæº€ã‹ã€RANKä¿‚æ•°ãŒç„¡åŠ¹ã€‚");
    return;
  }

  // ç¾åœ¨ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ãƒ‘ãƒ¯ãƒ¼é †ã«ã‚½ãƒ¼ãƒˆ
  highScores.sort((a, b) => {
    const aPower = a.score * (ratingCoefficients[a.rating] || 1.0);
    const bPower = b.score * (ratingCoefficients[b.rating] || 1.0);
    return bPower - aPower;
  });

  const lowestPower = highScores.length < 5 ? 0 :
    highScores[4].score * (ratingCoefficients[highScores[4].rating] || 1.0);

  console.log("ğŸ† æœ€ä¸‹ä½Power:", lowestPower, "vs ä»Šå›ã®Power:", newPower);

  if (newPower > lowestPower) {
    console.log("ğŸ‰ ãƒã‚¤ã‚¹ã‚³ã‚¢å…¥ã‚Šåˆ¤å®šæˆåŠŸï¼åå‰å…¥åŠ›ã‚’è¡¨ç¤ºã—ã¾ã™");

    enteringName = true;
    namePos = 0;
    nameChars = ["A", "A", "A", "A"];
    updateNameEntryDisplay();

    const entryScreen = document.getElementById("nameEntryScreen");
    if (entryScreen) {
      entryScreen.style.display = "flex";
      entryScreen.style.zIndex = "9999"; // å¿µã®ãŸã‚
    } else {
      console.log("â— nameEntryScreen ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼");
    }

    window.newHighScore = { score, rating };
  } else {
    console.log("â›” ãƒã‚¤ã‚¹ã‚³ã‚¢å…¥ã‚Šã›ãšã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™");
  }
}

function updateNameEntryDisplay() {
  const str = nameChars.map((c, i) => (i === namePos ? `[${c}]` : c)).join(" ");
  document.getElementById("nameEntry").textContent = str;

  // ã€Œæ¬¡ã¸ã€ã¾ãŸã¯ã€Œæ±ºå®šã€ã®åˆ‡ã‚Šæ›¿ãˆ
  const confirmBtn = document.getElementById("confirmButton");
  if (confirmBtn) {
    confirmBtn.textContent = (namePos === nameChars.length - 1) ? "æ±ºå®š" : "æ¬¡ã¸";
  }

  // ã€Œå‰ã¸ã€ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ¶å¾¡
  const backBtn = document.getElementById("backButton");
  if (backBtn) {
    backBtn.disabled = (namePos === 0); // æœ€åˆã®æ–‡å­—ã§ã¯ç„¡åŠ¹åŒ–
    backBtn.style.opacity = (namePos === 0) ? 0.3 : 1;
  }
}

function nextChar() {
  if (!enteringName) return;
  const idx = availableChars.indexOf(nameChars[namePos]);
  const nextIdx = (idx + 1) % availableChars.length;
  nameChars[namePos] = availableChars[nextIdx];
  updateNameEntryDisplay();
}

function prevChar() {
  if (!enteringName) return;
  const idx = availableChars.indexOf(nameChars[namePos]);
  const prevIdx = (idx - 1 + availableChars.length) % availableChars.length;
  nameChars[namePos] = availableChars[prevIdx];
  updateNameEntryDisplay();
}

function goBackChar() {
  if (namePos > 0) {
    namePos--;
    updateNameEntryDisplay();
  }
}

function displayTopHighScore() {
  const top = highScores[0];
  if (!top) return;
  const coeff = ratingCoefficients[top.rating] || 1.0;
  const power = Math.floor(top.score * coeff);
  const display = `${top.name}ã€€${top.score.toLocaleString()}ã€€RANKï¼š${top.rating}`;
  document.getElementById("topHighScore").textContent = display;
}

window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("nameEntryScreen").style.display = "none";
  enteringName = false;
  window.newHighScore = null;

  // âœ… ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã«ãƒˆãƒƒãƒ—ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º
  displayTopHighScore();
});

function getRatingMultiplier(rating) {
  return ratingCoefficients[rating] || 1.0;
}

function confirmNameEntry() {
  if (!enteringName) return;

  // æ¬¡ã®æ–‡å­—ã¸ç§»å‹•
  namePos++;

  if (namePos < nameChars.length) {
    updateNameEntryDisplay();
    return; // ã¾ã æœªç¢ºå®šã®æ–‡å­—ãŒã‚ã‚‹ã®ã§ç¢ºå®šã—ãªã„
  }

  // 4æ–‡å­—ã™ã¹ã¦ç¢ºå®šæ¸ˆã¿
  const name = nameChars.join("");
  highScores.push({
    name,
    score: window.newHighScore.score,
    rating: window.newHighScore.rating
  });

  // å†åº¦ã‚½ãƒ¼ãƒˆï¼†5ä»¶ã«çµã‚‹
  highScores.sort((a, b) => {
    const aPower = a.score * (ratingCoefficients[a.rating] || 1.0);
    const bPower = b.score * (ratingCoefficients[b.rating] || 1.0);
    return bPower - aPower;
  });
  highScores = highScores.slice(0, 5);
  saveHighScores(highScores);

  // UIå‡¦ç†
  document.getElementById("nameEntryScreen").style.display = "none";
  enteringName = false;

  // ğŸ¯ å…¥åŠ›ç›´å¾Œã«å³åæ˜ ï¼
  displayHighScores();

  // å¿µã®ãŸã‚ newHighScore ã‚’ãƒªã‚»ãƒƒãƒˆ
  window.newHighScore = null;

  // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ç”»é¢ã‚’è¡¨ç¤ºï¼ˆå†è¡¨ç¤ºï¼‰
  gameClear.style.display = "flex";
}


/* =======================================================
   â–¼ ãƒã‚¤ã‚¹ã‚³ã‚¢è¡¨
   ======================================================= */
function displayHighScores() {
  const scoreListEl = document.getElementById("scoreList");
  if (!scoreListEl) return;

  const ranks = highScores.map((entry, index) => {
    const rating = getRating(entry.score / getRatingMultiplier(entry.rating));
    return `${index + 1}. ${entry.name}ï¼š${entry.score}ï¼ˆ${entry.rating}ï¼‰`;
  });

  scoreListEl.innerHTML = `<p>ğŸ† High Scores</p>` + ranks.map(r => `<div>${r}</div>`).join("");
}

/* =======================================================
   â–¼ ã‚¹ãƒãƒ›è‡ªå‹•æ‹¡å¤§è¡¨ç¤º
   ======================================================= */
window.addEventListener("load", function () {
  setTimeout(function () {
    window.scrollTo(0, 1);
  }, 100);
});
/* =======================================================
   â–¼ visibilitychange ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
   ======================================================= */
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    if (gameStarted && !gameOver) {
      pauseGame(); // â†“ã§å®šç¾©
      pausedDueToVisibility = true;
    }
  } else {
    if (pausedDueToVisibility) {
      showResumeOverlay(); // â†“ã§å®šç¾©
      pausedDueToVisibility = false;
    }
  }
});
/* =======================================================
   â–¼ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒªã‚¸ãƒ§ãƒ³è¡¨ç¤º
   ======================================================= */
/*function drawCollisionBox(rect, color = "rgba(255, 0, 0, 0.3)") {
  const box = document.createElement("div");
  box.style.position = "absolute";
  box.style.left = rect.left + "px";
  box.style.top = rect.top + "px";
  box.style.width = rect.width + "px";
  box.style.height = rect.height + "px";
  box.style.backgroundColor = color;
  box.style.zIndex = "9999"; // ä¸€ç•ªä¸Šã«è¡¨ç¤º
  box.style.pointerEvents = "none";
  document.body.appendChild(box);

  // å°‘ã—çµŒã£ãŸã‚‰æ¶ˆãˆã‚‹ã‚ˆã†ã«ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨é€”ï¼‰
  setTimeout(() => box.remove(), 100);
}*/

</script>
</body>
</html>
