<!DOCTYPE html> 
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icn_mothvoid.png">
  <title>MOTHVOID</title>
  <style>
    * {
      -webkit-user-select: none;
      -webkit-touch-callout: none;
      user-select: none;
    }
    body {
      margin: 0;
      background: #000;
      color: white;
      font-family: monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;  /* â† ç¸¦æ–¹å‘ã„ã£ã±ã„ã«ä½¿ã† */
      overflow: hidden;
    }
    img, button {
      -webkit-user-drag: none;
      user-select: none;
      -webkit-touch-callout: none;
    }
    #titleScreen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 10;
    }
    #titleLogo {
      width: 380px;
      margin-bottom: 20px;
    }
    #pressToStart {
      font-size: 20px;
      color: #FFD700;
      animation: blink 2s infinite;
      font-family: 'monospace';
    }
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    #time {
      display: none;
    }
    #game {
      position: relative;
      width: 100vw;
      height: 150vw;
      max-width: 400px;
      max-height: 600px;
      margin-top: -2px; /* â† ã“ã®1è¡Œã‚’è¿½åŠ  */
      background: #111;
      border: 2px solid #fff;
      overflow: hidden;
      margin: -80px auto 0; /* â† ä¸Šã«30pxå¯„ã›ã‚‹ */
      z-index: 0; 
    }
    #player {
      position: absolute;
      width: 48px;
      height: 48px;
      bottom: 10px;
      left: 180px;
      background-image: url("chr_moth.gif");
      background-size: cover;
      z-index: 2;
    }
    #hitbox {
      position: absolute;
      width: 35px;
      height: 35px;
      bottom: 12px;
      left: 182px;
      pointer-events: none;
      z-index: 2;
    }
    .obstacle {
      position: absolute;
      width: 50px;
      height: 50px;
      background: red;
      z-index: 2;
    }
    .obstacle.stage4 {
      background-color: #555;
    }
    .afterimage {
      position: absolute;
      width: 40px;
      height: 40px;
      pointer-events: none;
      z-index: 2;
      animation: fade .1s forwards;
    }
    .afterimage::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, rgba(0, 200, 255, 0.4) 0%, rgba(0, 200, 255, 0.0) 80%);
      border-radius: 50%;
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.3);
      top: 0;
      left: 0;
      pointer-events: none;
    }
    @keyframes fade {
      to { opacity: 0; }
    }
    .dodge-flare {
      position: absolute;
      width: 40px;
      height: 40px;
      top: 0;
      left: 0;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0, 200, 255, 0.4), rgba(0, 200, 255, 0));
      pointer-events: none;
      z-index: 1;
    }
    .heal {
      position: absolute;
      width: 40px;
      height: 40px;
      font-size: 28px;
      color: pink;
      text-align: center;
      line-height: 40px;
      pointer-events: none;
    }
    .explosion {
      position: absolute;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: radial-gradient(circle, orange, red, transparent);
      animation: explode 0.4s ease-out forwards;
      pointer-events: none;
    }
    .rainbow {
      animation: rainbow 0.5s infinite;
    }
    @keyframes explode {
     0% { opacity: 1; transform: scale(0.5); }
     100% { opacity: 0; transform: scale(2); }
    }
    @keyframes rainbow {
      0% { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(360deg); }
    }
    .damage-flash {
      animation: flashWhite 0.15s ease-in-out;
    }
    @keyframes flashWhite {
      0% { filter: brightness(1); }
      50% { filter: brightness(3); }
      100% { filter: brightness(1); }
    }
   /* ã‚¹ã‚³ã‚¢ï¼ˆç™½æ å¤–ï¼‰ */
    #uiTop {
      position: relative; 
      width: 400px;
      margin-bottom: 80px;
      color: white;
      font-family: monospace;
    }
    #score {
      text-align: center;
      font-size: 20px;
      margin-bottom: 4px;
    }
   /* ãƒãƒ¼ãƒˆï¼ˆãƒ©ã‚¤ãƒ•è¡¨ç¤ºï¼‰ãƒ¬ãƒ™ãƒ«ãƒ»çµŒé¨“å€¤ç™½æ å†…å·¦ä¸Šã«è¡¨ç¤º */
    #levelExpRow {
     position: absolute;
     top: 8px;
     right: 6px;
     font-size: 14px;
     z-index: 10;
    }
    #smartphoneHint {
     color: white;
     font-size: 0.85em;
     margin-top: 10px;
     line-height: 1.4;
    }
    #lives {
      position: absolute;
      top: 5px;
      left: 5px;
      font-size: 20px;
      z-index: 5;
    }
    #comboText {
      position: absolute;
    }
    #gameClear, #gameOver {
      position: absolute;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: flex-start;
      padding-top: 80px;
      text-align: center;
      color: yellow;
      background: rgba(0, 0, 0, 0.7);
      font-size: 20px;
      z-index: 20;
      pointer-events: none; 
    }
   #thankYouText {
     font-size: clamp(18px, 6vw, 32px);  /* â† ç”»é¢å¹…ã«å¿œã˜ã¦è‡ªå‹•ç¸®å° */
     margin-bottom: 10px;
     white-space: nowrap;
     overflow: hidden;
     text-overflow: ellipsis;
     max-width: 100%;
   }
    #timeRating {
      font-size: 30px;
      margin-bottom: 10px;
    }
    #credits {
      font-size: 16px;
    }
    #restartButton {
      display: none;
      position: absolute;
      left: 50%;
      bottom: 2%; /* ã‚²ãƒ¼ãƒ ç”»é¢ã®ä¸­å¤®ã«è¡¨ç¤º */
      transform: translate(-50%, -50%);
      padding: 8px 16px;
      font-size: 16px;
      background-color: #f39c12;
      color: white;
      border: none;
      border-radius: 5px;
      z-index: 9999;               /* é‡ãªã‚Šé †ã‚’æœ€å‰é¢ã«èª¿æ•´ */
      cursor: pointer;
      pointer-events: auto;       /* ã‚¿ãƒƒãƒã‚’ç¢ºå®Ÿã«å—ã‘ä»˜ã‘ã‚‹ */
      touch-action: manipulation; /* â† ã‚¿ãƒƒãƒ—åå¿œã‚’æœ€é©åŒ–ï¼ˆç‰¹ã«iOSï¼‰ */
    }
    #touchControls {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;  /* â† ä¸‹æƒãˆã«å¤‰æ›´ */
      width: 400px;
      margin-top: 42px;
      padding: 0 10px;
      height: 40px;  /* â† é«˜ã•ã‚’å›ºå®š */
      position: relative;
    }
    #moveInstruction,
    #parryInstruction {
      position: absolute;
      bottom: 65px; /* â† ãƒœã‚¿ãƒ³ã‚ˆã‚Šä¸Šã«å›ºå®šè¡¨ç¤º */
      font-size: 14px;
      color: #FFD700;
      font-family: monospace;
      text-align: center;
      width: 120px;
      white-space: nowrap;
    }
    #moveInstruction {
      left: 20px;
    }
    #parryInstruction {
      right: 60px;
    }
    .arrowGroup {
      display: flex;
      gap: 30px;
      margin-left: 30px; /* â† çŸ¢å°å…¨ä½“ã‚’å³ã«ãšã‚‰ã™ */
    }
    .parryGroup {
      display: flex;
      justify-content: flex-end;
    }

    .control-button {
      width: 60px;
      height: 60px;
    }
    #btnParry {
      margin-right: 70px; /* â† å³è©°ã‚èª¿æ•´ */
    }

    #screenFade {
      position: absolute;
      top: 0; left: 0;
      width: 400px;
      height: 600px;
      background: #000;
      pointer-events: none;
      opacity: 0;
      transition: opacity .75s ease;
      z-index: 9;
    }
    #background {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-size: 100% auto;
      background-repeat: repeat-y;
      background-position-y: 0px;
      z-index: 0;
    }
    #bgDarkenLayer {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: black;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.75s ease;
      z-index: 1;
    }
    .obstacle-img {
      position: absolute;
      pointer-events: none;
      transform: translate(-50%, -50%);
    }
    .score-popup {
      position: absolute;
      font-size: 18px;
      font-weight: bold;
      font-family: monospace;
      pointer-events: none;
      animation: floatUp 0.5s ease-out forwards;
      z-index: 100;
    }

    @keyframes floatUp {
      0% {
        opacity: 1;
        transform: translateY(0px);
      }
      100% {
        opacity: 0;
        transform: translateY(-30px);
      }
    }
    
    /* â–¼ ãƒãƒ¼ã‚ºï¼å†é–‹ãƒœã‚¿ãƒ³ã®é…ç½®ãƒ»è¦‹ãŸç›® */
   #pauseControls {
     position: absolute;
     top: -3px;
     right: 20px;
     z-index: 15;
     display: flex;
     gap: 6px;
   }

   #pauseButton,
   #resumeButton {
     font-size: 18px;
     background: none;
     border: none;
     color: white;
     cursor: pointer;
     padding: 2px 6px;
   }

   /* ãƒãƒ¼ã‚ºä¸­ã«ä¸­å¤®ã«è¡¨ç¤ºã•ã‚Œã‚‹PAUSEãƒ†ã‚­ã‚¹ãƒˆ */
   #pauseOverlay {
     position: absolute;
     top: 50%;
     left: 50%;
     transform: translate(-50%, -50%);
     font-size: 36px;
     color: white;
     background: rgba(0, 0, 0, 0.6);
     padding: 10px 30px;
     border-radius: 10px;
     display: none;
     z-index: 999;
     pointer-events: none;
   }

  .void-rank {
    font-size: 28px;
    color: gold;
    text-shadow: 0 0 10px gold, 0 0 20px orange;
    font-weight: bold;
    animation: glow 1.5s infinite alternate;
  }

  .void-subtext {
    font-size: 14px;
    color: #ccc;
    margin-top: 5px;
  }

  @keyframes glow {
    from { text-shadow: 0 0 5px gold; }
    to { text-shadow: 0 0 20px gold, 0 0 30px orange; }
  }
  
#voidFeathers {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 9999;
}
.invincible-orb {
  position: absolute;
  width: 12px;
  height: 12px;
  background: purple;
  border-radius: 50%;
  pointer-events: none;
  z-index: 5;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  animation: rotateAround 1s linear infinite;
}
.orb1 { animation-delay: 0s; }
.orb2 { animation-delay: 0.5s; }

@keyframes rotateAround {
  0% {
    transform: translate(-50%, -50%) rotate(0deg) translateX(30px) rotate(0deg);
  }
  100% {
    transform: translate(-50%, -50%) rotate(360deg) translateX(30px) rotate(-360deg);
  }
}

.feather {
  position: absolute;
  width: 24px;
  height: 24px;
  background-image: url('eff_feather.png');
  background-size: cover;
  opacity: 1;
  z-index: 99999;
  pointer-events: none;
  transform: translate(0, 0) rotate(0deg);
  animation: featherFly var(--flyTime, 2s) ease-out forwards,
             featherWobble 3s ease-in-out infinite;
            
}

@keyframes featherFly {
  0% {
    transform: translate(0px, 0px) rotate(var(--startAngle));
    opacity: 1;
  }
  10% {
    transform: translate(calc(var(--dx) * 1px), calc(var(--dy) * 0.3px)) rotate(var(--midAngle));
    opacity: 1;
  }
  100% {
    transform: translate(calc(var(--dx) * 1px), calc(var(--dy) * 1px)) rotate(var(--endAngle));
    opacity: 0;
  }
}
@keyframes featherWobble {
  0%, 100% {
    filter: brightness(1.8);
  }
  50% {
    filter: brightness(2.3);
  }
}

  </style>
</head>
<body>
<!-- UIã‚¨ãƒªã‚¢ï¼ˆã‚¹ã‚³ã‚¢ï¼‰ â†’ ç™½æ ã®å¤–ã€ç”»é¢ä¸­å¤®ä¸Š -->
<div id="uiTop">
  <div id="score">ã‚¹ã‚³ã‚¢: 0</div>
  <div id="musicTitle" style="
  position: absolute;
  top: 530px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  font-size: 16px;
  font-family: monospace;
  text-shadow: 0 0 6px black;
  opacity: 0;
  transition: opacity 0.5s ease;
  z-index: 10;
  pointer-events: none;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 90vw;
"></div>
   <!-- ãƒãƒ¼ã‚ºï¼å†é–‹ãƒœã‚¿ãƒ³ï¼ˆå³ä¸Šï¼‰ -->
  <div id="pauseControls">
    <button id="pauseButton" title="ãƒãƒ¼ã‚º">â¸</button>
    <button id="resumeButton" title="å†é–‹" style="display: none;">â–¶ï¸</button>
  </div>
</div>
<!-- ã‚¿ã‚¤ãƒ è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ãªã©ï¼‰ -->
<div id="time" style="display: none;">ã‚¿ã‚¤ãƒ : 0.000ç§’</div>

<!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ -->
<div id="titleScreen">
<!-- HIGH SCORE è¦‹å‡ºã—ã‚’è¿½åŠ  -->
  <div style="font-size: 16px; font-weight: bold; margin-bottom: 4px; color: #FFD700;">HIGH SCORE</div>
<!-- ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã®ã‚¹ã‚³ã‚¢è¡¨ç¤ºé ˜åŸŸï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ­ã‚´ã®ä¸Šãªã©ï¼‰ -->
  <div id="topHighScore" style="font-size: 14px; margin: 5px auto 0 auto; text-align: center;"></div>
  <img src="title_mothvoid.webp" alt="MOTHVOIDã‚¿ã‚¤ãƒˆãƒ«ãƒ­ã‚´" id="titleLogo">
  <p id="pressToStart">PRESS ANY BUTTON</p>
  <p id="smartphoneHint" class="title-only">
  Ver.1.2.4<br>
  â€»ã‚¹ãƒãƒ›ã®å ´åˆ<br>
  ã€Œå…±æœ‰ãƒœã‚¿ãƒ³â†’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã€<br>
  ãã®å¾Œãƒ›ãƒ¼ãƒ ç”»é¢ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‹ã‚‰<br>
  ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã®ãŒãŠã‚¹ã‚¹ãƒ¡ï¼<br>
  â€»iOS 15ä»¥ä¸Šï¼ˆiPhone / iPadï¼‰<br>
  â€»Safari/Chromeã¯æœ€æ–°ç‰ˆã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
  
</p>
</div>

<!-- ã‚²ãƒ¼ãƒ ç”»é¢ -->
<div id="game">
 <!-- Vãƒ©ãƒ³ã‚¯ç¾½æ ¹æ¼”å‡º -->
  <div id="voidFeathers" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:99999;"></div>
  <div id="background"></div>
  <div id="bgDarkenLayer"></div>
  <div id="player"></div>
  <div id="hitbox"></div>
  <div id="lives">â¤ï¸â¤ï¸â¤ï¸</div>
  <div id="screenFade"></div>
   <!-- ãƒ¬ãƒ™ãƒ«ï¼çµŒé¨“å€¤è¡¨ç¤ºï¼ˆç™½æ å³ä¸Šï¼‰ -->
  <div id="levelExpRow">
    <span id="level">Lv.1</span>
    <span id="exp">EXP: 0 / 200</span>
  </div>
  
  <!-- ãƒãƒ¼ã‚ºä¸­ã®è¡¨ç¤º -->
  <div id="pauseOverlay">PAUSE</div>
  
  <!-- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
    <img id="justParryEffect" src="eff_just_parry.gif"
       style="display: none; position: absolute; width: 60px; height: 60px; z-index: 3; pointer-events: none;">
    <!-- BGM -->
    <audio id="bgm_stage1" loop><source src="bgm_stage1.mp3" type="audio/mpeg"></audio>
    <audio id="bgm_stage2" loop><source src="bgm_stage2.mp3" type="audio/mpeg"></audio>
    <audio id="bgm_stage3" loop><source src="bgm_stage3.mp3" type="audio/mpeg"></audio>
    <audio id="bgm_final" loop><source src="bgm_final.mp3" type="audio/mpeg"></audio>
    <audio id="bgm_final2" loop><source src="bgm_final2.mp3" type="audio/mpeg"></audio>
    <audio id="bgm_result" loop>  <source src="bgm_result.mp3" type="audio/mpeg"></audio>
    <!-- SE -->
    <audio id="seParry"><source src="se_parry.mp3" type="audio/mpeg"></audio>
    <audio id="seDodge"><source src="se_dodge.mp3" type="audio/mpeg"></audio>
    <audio id="seBombL"><source src="se_bomb_L.mp3" type="audio/mpeg"></audio>
    <audio id="seItem"><source src="se_item.mp3" type="audio/mpeg"></audio>
    <audio id="seJustParry"><source src="se_justparry.mp3" type="audio/mpeg"></audio>
    <!-- ã‚¯ãƒªã‚¢ç”»é¢ -->
    <div id="gameClear">
     <div>
        <h2 id="thankYouText">Thank you for playing!</h2>
        <p id="timeRating"></p>
        <p id="credits">
          <span>Director: akky</span><br>
          <span>Designer: MAS</span><br>
          <span>Programmer: GPT</span><br>
          <span>MOTHVOID 2025/7/01</span>
        </p>
        
        <!-- âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º -->
        <div id="scoreList" style="margin-top: 14px; font-size: 16px;"></div>
    
      </div>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ -->
    <div id="gameOver">
      <h2>Game Over</h2>
    </div>
    <!-- å†ãƒ—ãƒ¬ã‚¤ãƒœã‚¿ãƒ³ -->
    <button id="restartButton">å†ãƒ—ãƒ¬ã‚¤</button>
  </div> <!-- â† #game ã®é–‰ã˜ã‚¿ã‚° -->
  
    <!-- â–¼ ãƒã‚¤ã‚¹ã‚³ã‚¢åå‰å…¥åŠ›UIï¼ˆåˆæœŸã¯éè¡¨ç¤ºï¼‰ -->
    <div id="nameEntryScreen" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:#000d; color:white; z-index:999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
      <div style="font-size:20px; margin-bottom:10px;">HIGH SCORE! ENTER YOUR NAME</div>
      <div id="nameEntry" style="font-size:36px; letter-spacing:10px;">A A A A</div>
      <div style="margin-top:20px;">
        <button onclick="prevChar()">â—€</button>
        <button onclick="nextChar()">â–¶</button>
        <button onclick="goBackChar()" id="backButton" style="margin-left: 20px;">å‰ã¸</button> <!-- âœ… æ–°ã—ãè¿½åŠ  -->
        <button onclick="confirmNameEntry()" id="confirmButton" style="margin-left: 20px;">æ¬¡ã¸</button>
      </div>
    </div>
    
    <!-- ã‚¿ãƒƒãƒæ“ä½œãƒœã‚¿ãƒ³ -->
<div id="touchControls" class="title-only">
  <div class="arrowGroup">
    <div id="moveInstruction" class="instruction title-only">å·¦å³ç§»å‹•ï¼é€£ç¶šå…¥åŠ›ã§å›é¿</div>
    <img id="btnLeft" src="btn_left.png" class="control-button">
    <img id="btnRight" src="btn_right.png" class="control-button">
  </div>
  <div class="parryGroup">
    <div id="parryInstruction" class="instruction title-only">ãƒ‘ãƒªã‚£ï¼ã‚¸ãƒ£ã‚¹ãƒˆãƒ‘ãƒªã‚£</div>
    <img id="btnParry" src="btn_parry.png" class="control-button">
  </div>
 <script>
 /* =======================================================
   â–¼ ã‚²ãƒ¼ãƒ å®šæ•°ãƒ»è¨­å®šå€¤
   ======================================================= */
  const game = document.getElementById("game");
  const player = document.getElementById("player");
  const hitbox = document.getElementById("hitbox");
  const scoreEl = document.getElementById("score");
  const livesEl = document.getElementById("lives");
  const timeEl = document.getElementById("time");
  const levelEl = document.getElementById("level");
  const maxLevel = 7; 
  const expEl = document.getElementById("exp");
  const normalParryRadius = 56;
  const PARRY_COOLDOWN = 400; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ™‚é–“ [ms]
  const maxGauge = 3;
  const gameClear = document.getElementById("gameClear");
  const scrollDuration = 120; // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ï¼ˆç§’ï¼‰
  const timeRatingEl = document.getElementById("timeRating");
  const restartButton = document.getElementById("restartButton");
  const seParry = document.getElementById("seParry");
  const seBombL = document.getElementById("seBombL");
  const seDodge = document.getElementById("seDodge");
  const seItem = document.getElementById("seItem");
  const seJustParry = document.getElementById("seJustParry");
  const allObstacles = [];
  const btnLeft  = document.getElementById("btnLeft");
  const btnRight = document.getElementById("btnRight");
  const btnParry = document.getElementById("btnParry");
  const titleScreen = document.getElementById("titleScreen");
  const availableChars = [..."ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_.!*@#?<> "];
    // â–¼ ãƒã‚¤ã‚¹ã‚³ã‚¢ä¿å­˜ç”¨ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆlocalStorageä½¿ç”¨ï¼‰
  const HIGH_SCORE_KEY = "yamamayu_high_scores";
  const defaultHighScores = [
    { name: "MOTH", score: 400000, rating: "SS" },
    { name: "LMNG", score: 350000, rating: "S" },
    { name: "KAIK", score: 300000, rating: "A" },
    { name: "YMMY", score: 250000, rating: "B" },
    { name: "OOMZ", score: 200000, rating: "C" }
  ];
  const bgm = {
     Stage1: document.getElementById("bgm_stage1"),
     Stage2: document.getElementById("bgm_stage2"),
     Stage3: document.getElementById("bgm_stage3"),
     Final:  document.getElementById("bgm_final"),
     Final2: document.getElementById("bgm_final2"),
     Result: document.getElementById("bgm_result")
   };
  
 /* =======================================================
    â–¼ ã‚²ãƒ¼ãƒ é€²è¡ŒçŠ¶æ…‹ï¼ˆå¤‰åŒ–ã™ã‚‹å€¤ï¼‰
   ======================================================= */
  let score = 0;
  let lives = 3;
  let maxLives = 3;
  let gameOver = false;
  let invincible = false;
  let parryActive = false;
  let justParry = false;
  let playerX = 180;
  let playerSpeed = 3;
  let obstacleSpeed = 15;  // éšœå®³ç‰©ã®é€Ÿåº¦
  let startTime = Date.now();  // ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã®æ™‚é–“
  let gameTime = 0;  // çµŒéæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
  let obstacleGenerationInterval;
  let scoreUpdateInterval;
  let timeUpdateInterval;
  let lastScoreUpdateTime = 0;  // æœ€å¾Œã«ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°ã—ãŸãƒŸãƒªç§’
  let highScore = localStorage.getItem("highScore") || 0;
  let justParryRadius = 40;  // Lv.1 åˆæœŸå€¤ï¼ˆæœ€å¤§52ã¾ã§ä¸Šæ˜‡ï¼‰
  let parryGauge = 0; 
  let level = 1;
  let exp = 0;
  let stage = 1;
  let lastParryTime   = 0;   // å‰å›ãƒ‘ãƒªã‚£ã‚’æ‰“ã£ãŸã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  let firstInteraction = false;
  let currentBGM = null;
  let gameStarted = false;
  let gamePaused = false;
  let baseInterval   = 800;  // â˜… ç¾åœ¨ã®é–“éš”ï¼ˆåˆæœŸ 800msï¼‰
  let obstacleTimerId      = null; // â˜… setInterval ã® ID ã‚’ä¿æŒ
  let obstacleSpawnInterval = null;
  let itemFallTimers = []; // ğŸ’¡ ã™ã¹ã¦ã®è½ä¸‹ã‚¢ã‚¤ãƒ†ãƒ ã® fall ID ã‚’ã“ã“ã«è¨˜éŒ²
  let isPaused = false;
  let pauseStart = 0;
  let totalPausedTime = 0;
  let superInvincible = false;
  let orb1, orb2;
  let lastKey        = "";      // ç›´å‰ã®æ–¹å‘ã‚­ãƒ¼
  let lastKeyTime    = 0;       // æŠ¼ä¸‹ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  let isDodging      = false;   // å›é¿ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ä¸­
  let speedBoost     = false;   // å›é¿å¾Œ 0.3 s ã ã‘ 2 å€é€Ÿ
  let keyPressed = {};  // æŠ¼ä¸‹ä¸­ã‹ã©ã†ã‹
  let pausedDueToVisibility = false; // ã‚¿ãƒ–éè¡¨ç¤ºã«ã‚ˆã‚‹ä¸€æ™‚åœæ­¢ã‹ã©ã†ã‹
  let lastExplosionTime = 0;
  let isTouchHolding = false;
  let touchHoldInterval = null;
  // ==== Combo System Globals ====
  let currentComboCount = 0;        // ä»Šã®ãƒ’ãƒƒãƒˆæ•°ï¼ˆ2ä»¥ä¸Šã‹ã‚‰ï¼‰
  let comboInProgress = false;      // ã‚³ãƒ³ãƒœä¸­ã‹
  let comboLastUpdateTime = 0;      // æœ€å¾Œã®ãƒ’ãƒƒãƒˆæ™‚åˆ»ï¼ˆãƒŸãƒªç§’ï¼‰
  let comboReflectedCount = 0;      // ç¾åœ¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªåå°„å¼¾ã®æ•°
  let comboBonusGiven = false;      // ãƒœãƒ¼ãƒŠã‚¹ãŒæ—¢ã«è¡¨ç¤ºã•ã‚ŒãŸã‹
  let comboWatcherStarted = false;  // âœ… â† ã“ã‚Œã‚’å¿˜ã‚Œãšã«è¿½åŠ 
  let comboEndTimeout = null;
  
  // ãƒã‚¤ã‚¹ã‚³ã‚¢å–å¾—
  function loadHighScores() {
    const json = localStorage.getItem(HIGH_SCORE_KEY);
    return json ? JSON.parse(json) : defaultHighScores;
  }

  // ãƒã‚¤ã‚¹ã‚³ã‚¢ä¿å­˜
  function saveHighScores(highScores) {
    localStorage.setItem(HIGH_SCORE_KEY, JSON.stringify(highScores));
  }

  // ç¾åœ¨ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ï¼ˆ5ä»¶ä»¥å†…ï¼‰ã‚’ä¿æŒ
  let highScores = loadHighScores();
  let enteringName = false;
  let nameChars = ["A", "A", "A", "A"];
  let namePos = 0;

  const ratingCoefficients = {
    "V": 4.0,
    "SS": 3.6,
    "S": 3.2,
    "A": 2.8,
    "B": 2.4,
    "C": 2.0,
    "D": 1.6,
    "E": 1.2
  };

  const DOUBLE_TAP_MS = 200;    // 0.2 ç§’ä»¥å†…
  const STEP_PX       = 30;     // 1 ã‚¹ãƒ†ãƒƒãƒ—è·é›¢
  
  window.addEventListener("load", () => {
    if (bgm["stage1"]) bgm["stage1"].load(); // èª­ã¿è¾¼ã¿ã ã‘ã—ã¦ãŠã
  });
/* =======================================================
   â–¼ ã‚²ãƒ¼ãƒ é–‹å§‹ï¼å†ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†ï¼ˆBGMãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³å¯¾å¿œï¼‰
   ======================================================= */
function fadeInBGM(audio, duration = 1000) {
  const target = parseFloat(audio.dataset.targetVolume || 1);
  audio.volume = 0;
  audio.currentTime = 0;

  // âœ… ã“ã“ã§ã™ã currentBGM ã‚’ç¢ºå®šã™ã‚‹
  currentBGM = audio;

  audio.play().catch(e => {
    console.warn("ğŸ”‡ BGM fade-in failed:", e);
  });

  const step = target / (duration / 50);
  let n = 0;
  const id = setInterval(() => {
    n++;
    audio.volume = Math.min(target, audio.volume + step);
    if (audio.volume >= target || n >= (duration / 50)) {
      clearInterval(id);
    }
  }, 50);
}

/* =======================================================
   â–¼ BGM ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
   ======================================================= */
function crossfadeBGM(fromAudio, toAudio, duration = 1500) {
  if (!fromAudio || !toAudio || fromAudio === toAudio) return;

  const fromTarget = 0;
  const toTarget = parseFloat(toAudio.dataset.targetVolume || 1);

  const stepTime = 50;
  const steps = duration / stepTime;
  const fromStep = (fromAudio.volume - fromTarget) / steps;
  const toStep = toTarget / steps;

  toAudio.volume = 0;
  toAudio.currentTime = 0;

  toAudio.play().catch(e => {
    console.warn("ğŸ”‡ crossfadeBGM: play failed", e);
  });

  let n = 0;
  const id = setInterval(() => {
    n++;
    fromAudio.volume = Math.max(fromTarget, fromAudio.volume - fromStep);
    toAudio.volume = Math.min(toTarget, toAudio.volume + toStep);

    if (n >= steps) {
      clearInterval(id);
      fromAudio.pause();
      fromAudio.volume = parseFloat(fromAudio.dataset.targetVolume || 1);
    }
  }, stepTime);
}

/* =======================================================
   â–¼ æ›²åè¡¨ç¤º
   ======================================================= */
function showMusicTitle(text) {
  const titleEl = document.getElementById("musicTitle");
  titleEl.textContent = text;
  titleEl.style.opacity = 1;

  setTimeout(() => {
    titleEl.style.opacity = 0;
  }, 5000);
}
/* =======================================================
   â–¼ èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦
   ======================================================= */
let backgroundOffset = 0;
let scrollSpeed = 0.2; // ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã«å¤‰åŒ–ã™ã‚‹åŸºæœ¬é€Ÿåº¦ï¼ˆåˆæœŸå€¤ï¼‰

function scrollBackground() {
  // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸåŠ é€Ÿå‡¦ç†
  let extraSpeed = 0;
  if (score >= 300000) {
    const steps = Math.floor((score - 300000) / 150000) + 1;
    extraSpeed = Math.min(steps, 7); // æœ€å¤§åŠ é€Ÿã¯ +7.0 ã¾ã§
  }

  // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†
  backgroundOffset += scrollSpeed + extraSpeed;
  const bg = document.getElementById("background");
  if (bg) {
    bg.style.backgroundPositionY = `${backgroundOffset}px`;
  }

  requestAnimationFrame(scrollBackground);
}

// ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã®åŸºæœ¬ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ã‚’è¨­å®šï¼ˆã‚²ãƒ¼ãƒ é–‹å§‹ãƒ»é€²è¡Œæ™‚ã«å‘¼ã³å‡ºã—ï¼‰
function setStageBackgroundSpeed(stage) {
  if (stage === 1) scrollSpeed = 0.3;
  else if (stage === 2) scrollSpeed = 0.5;
  else if (stage === 3) scrollSpeed = 0.8;
  else if (stage === 4) scrollSpeed = 2.0;
  else if (stage === 5) scrollSpeed = 2.0; // ã‚¹ãƒ†ãƒ¼ã‚¸4ã¨åŒã˜é€Ÿåº¦ã‚’ç¶­æŒ
}

/* =======================================================
   â–¼ èƒŒæ™¯ ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ä»˜ãã‚¹ãƒ†ãƒ¼ã‚¸ç®¡ç†
   ======================================================= */

/** èƒŒæ™¯â€BGM ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã®æ‰€è¦æ™‚é–“ï¼ˆmsï¼‰ */
const FADE_MS = 1500;          // â†BGM ã® crossfadeBGM() ã¨æƒãˆã¦ã„ã¾ã™

/**
 * æš—è»¢ â†’ èƒŒæ™¯ç”»åƒåˆ‡æ›¿ â†’ æ˜è»¢
 * @param {number} nextStage 1ã€œ5
 */
function crossfadeBackground(nextStage){
  const bg    = document.getElementById("background");
  const darken = document.getElementById("bgDarkenLayer");

  // æš—ãã™ã‚‹
  darken.style.opacity = 1;

  setTimeout(() => {
    // èƒŒæ™¯ç”»åƒåˆ‡æ›¿ï¼ˆæš—ã„ã¾ã¾åˆ‡ã‚Šæ›¿ãˆï¼‰
    bg.style.backgroundImage = `url(env_stage${nextStage}.webp)`;

    // æ˜ã‚‹ãæˆ»ã™
    darken.style.opacity = 0;
  }, FADE_MS / 2);
}

/* =======================================================
   â–¼ èƒŒæ™¯æƒ…å ±æ›´æ–°
   ======================================================= */
function updateBackgroundInstant(stageNum) {
  const bg = document.getElementById("background");

  // èƒŒæ™¯ç”»åƒã‚’å³æ™‚åˆ‡æ›¿
  bg.style.backgroundImage = `url(env_stage${stageNum}.webp)`; // ä¾‹: env_stage2.webp

  // å¿…è¦ãªåˆæœŸã‚¹ã‚¿ã‚¤ãƒ«å†è¨­å®šï¼ˆå¿µã®ãŸã‚ãƒªã‚»ãƒƒãƒˆï¼‰
  bg.style.backgroundRepeat = "repeat-y";
  bg.style.backgroundSize = "100% auto";
  bg.style.backgroundPositionY = `${backgroundOffset}px`; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã«åˆã‚ã›ã‚‹
}
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
     ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¤å®š &  ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«/BGM åŒæœŸã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function checkStage() {
  const prevStage = stage;

  // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸã‚¹ãƒ†ãƒ¼ã‚¸æ›´æ–°
  stage =
    score >= 600000 ? 5 :
    score >= 150000 ? 4 :
    score >= 100000 ? 3 :
    score >=  50000 ? 2 : 1;

  if (stage !== prevStage) {
    crossfadeBackground(stage);
    setStageBackgroundSpeed(stage);

    const newBGM =
      stage === 5 ? bgm.Final2 :
      [bgm.Stage1, bgm.Stage2, bgm.Stage3, bgm.Final][stage - 1];

    const oldBGM = currentBGM; // â† æ—§æ›²ã‚’ä¸€æ™‚ä¿å­˜

    // æ›²ãŒå¤‰ã‚ã£ã¦ã„ã‚Œã°ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã€åˆå›ã‚„åŒä¸€ãªã‚‰ fadeIn
    if (oldBGM && oldBGM !== newBGM && !oldBGM.paused && oldBGM.currentTime > 0) {
      crossfadeBGM(oldBGM, newBGM, FADE_MS);
    } else {
      fadeInBGM(newBGM, FADE_MS);
    }

    currentBGM = newBGM; // æœ€å¾Œã«æ›´æ–°ï¼

    const musicTitles = {
      1: "â™ªStarlight Vanguard",
      2: "â™ªBrave Ascent",
      3: "â™ªVoidborne Resolve",
      4: "â™ªBurn the Void",
      5: "â™ªBeyond the Edge"
    };
    showMusicTitle(musicTitles[stage]);
  }
}

window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("nameEntryScreen").style.display = "none";
  enteringName = false;
  window.newHighScore = null;

  displayTopHighScore();
});
/* =======================================================
   â–¼ ãƒ¡ã‚¤ãƒ³ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç†
   ======================================================= */
function startGame() {
  if (enteringName) return; // â† ãƒã‚¤ã‚¹ã‚³ã‚¢åå…¥åŠ›ä¸­ãªã‚‰ç„¡åŠ¹åŒ–
  if (!gameOver && firstInteraction) return;
  firstInteraction = true;

  // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢éè¡¨ç¤º
  const titleScreen = document.getElementById("titleScreen");
  displayTopHighScore(); // â† å…ˆã«è¡¨ç¤ºã™ã‚‹ï¼ˆéè¡¨ç¤ºã«ã™ã‚‹å‰ï¼ï¼‰
  if (titleScreen) {
    titleScreen.style.display = "none";
    document.getElementById("moveInstruction").style.display = "none";
    document.getElementById("parryInstruction").style.display = "none";
  }

  allObstacles.forEach(obj => obj.remove());
  allObstacles.length = 0;
  scrollBackground();

  /* â˜…â˜…â˜…â˜…â˜… ã“ã“ã‹ã‚‰éŸ³é‡ãƒ—ãƒªã‚»ãƒƒãƒˆ â˜…â˜…â˜…â˜…â˜… */
  const BGM_VOLUME = 0.8;
  const SE_VOLUME  = 0.8;

  [seParry, seDodge, seBombL, seItem, seJustParry].forEach(se => se.volume = SE_VOLUME);

  [bgm.Stage1, bgm.Stage2, bgm.Stage3, bgm.Final, bgm.Final2, bgm.Result].forEach(bgm => {
    bgm.dataset.targetVolume = BGM_VOLUME;
  });
  /* â˜…â˜…â˜…â˜…â˜… ã“ã“ã¾ã§éŸ³é‡ãƒ—ãƒªã‚»ãƒƒãƒˆ â˜…â˜…â˜…â˜…â˜… */

  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦ã¨ã‚ªãƒ•ã‚»ãƒƒãƒˆãƒ»ãƒ¬ãƒ™ãƒ«ãƒ»çµŒé¨“å€¤ãªã©ã‚’åˆæœŸåŒ–
  level = 1;
  exp = 0;
  maxLives = 3;
  lives = maxLives;
  playerSpeed = 3;
  scrollSpeed = 0.3;
  backgroundOffset = 0;

  setStageBackgroundSpeed(1);
  updateBackgroundInstant(1);

  // å¤‰æ•°åˆæœŸåŒ–
  gameOver = false;
  gameStarted = true; 
  score = 0;
  parryGauge = 0;
  startTime = Date.now();
  lastScoreUpdateTime = 0;
  gameTime = 0;
  resetObstacleSpawn();

  // BGM åˆæœŸåŒ–ã¨å†ç”Ÿ
  [bgm.Stage1, bgm.Stage2, bgm.Stage3, bgm.Final, bgm.Final2, bgm.Result].forEach(bgm => {
    bgm.pause();
    bgm.currentTime = 0;
    bgm.volume = 0;
  });

  stage = 0;
//currentBGM = null;
  checkStage();

  // UI åˆæœŸåŒ–
  gameClear.style.display = "none";
  restartButton.style.display = "none";
  //exitButton.style.display = "none"; // â† ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆæ¸ˆã¿ãªã‚‰æœ‰åŠ¹åŒ–ã—ã¦OK
  pauseButton.style.display = "inline";
  updateUI();

  // ã‚¿ã‚¤ãƒãƒ¼å†è¨­å®š
  clearInterval(obstacleGenerationInterval);
  clearInterval(scoreUpdateInterval);
  clearInterval(timeUpdateInterval);

  scoreUpdateInterval = setInterval(updateScore, 100);
  timeUpdateInterval = setInterval(updateTime, 30);

  // ğŸ” ã‚¹ãƒ†ãƒƒãƒ—â‘¤ï¼šã‚³ãƒ³ãƒœç›£è¦–ãƒ«ãƒ¼ãƒ—ï¼ˆ1å›ã ã‘å®Ÿè¡Œï¼‰
  if (!comboWatcherStarted) {
    comboWatcherStarted = true;
    setInterval(() => {
      if (!comboInProgress) return;

      const now = Date.now();
      if (comboReflectedCount <= 0 && now - comboLastUpdateTime > 300) {
        finishComboBonus();
      }
    }, 100);
  }
}

// æœ€åˆã®å…¥åŠ›ã§èµ·å‹•
window.addEventListener("mousedown", startGame, { once: true });
window.addEventListener("keydown",   startGame, { once: true });
restartButton.addEventListener("click", startGame);

// å†ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³å‡¦ç†
restartButton.addEventListener("click", startGame);
// å†ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³å‡¦ç†ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰â† è¿½åŠ 
restartButton.addEventListener("touchstart", (e) => {
  e.preventDefault(); // iOSã§ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãƒ»é¸æŠãªã©é˜²æ­¢
  startGame();
});

// ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ï¼šã‚¹ãƒãƒ›å¯¾å¿œ
titleScreen.addEventListener("touchstart", () => {
  if (!gameStarted && !enteringName) startGame();  // â† enteringName ã‚’è¿½åŠ 
});
/* =======================================================
   â–¼ ã‚²ãƒ¼ãƒ çµ‚äº†ã‚¹ãƒãƒ›å¯¾å¿œ
   ======================================================= */
function handleExit() {
  const closed = window.close(); // é–‰ã˜ã‚ˆã†ã¨è©¦ã¿ã‚‹ï¼ˆâ€»å¤šãã®ã‚¹ãƒãƒ›ã§ç„¡åŠ¹ï¼‰
  alert("ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã—ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚");
}
/* =======================================================
   â–¼ ãƒãƒ¼ã‚ºæ©Ÿèƒ½å‡¦ç†
   ======================================================= */
function pauseGame() {
  pauseStart = Date.now(); 
  
  clearInterval(obstacleGenerationInterval);
  clearInterval(scoreUpdateInterval);
  clearInterval(timeUpdateInterval);
  if (currentBGM) currentBGM.pause();
}

// â–¼ ãƒãƒ¼ã‚ºï¼å†é–‹ãƒœã‚¿ãƒ³å‡¦ç†
const pauseButton = document.getElementById("pauseButton");
const resumeButton = document.getElementById("resumeButton");
const pauseOverlay = document.getElementById("pauseOverlay");

pauseButton.addEventListener("click", () => {
  if (gameOver || gamePaused) return;

  pauseGame(); // æ—¢å­˜é–¢æ•°ã‚’å‘¼ã¶
  gamePaused = true;

  // UIåˆ‡æ›¿
  pauseOverlay.style.display = "block";
  pauseButton.style.display = "none";
  resumeButton.style.display = "inline";
});

resumeButton.addEventListener("click", () => {
  if (gameOver || !gamePaused) return; 

  gamePaused = false;
  resumeGame();

  pauseOverlay.style.display = "none";
  pauseButton.style.display = "inline";
  resumeButton.style.display = "none";
});

// â–¼ ã‚¿ãƒ–éã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã«è‡ªå‹•ãƒãƒ¼ã‚ºï¼ˆã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªåˆ‡ã‚Šæ›¿ãˆå«ã‚€ï¼‰
document.addEventListener("visibilitychange", () => {
  if (document.hidden && !gamePaused && !gameOver && gameStarted) {
    pauseGame();
    gamePaused = true;

    pauseOverlay.style.display = "block";
    pauseButton.style.display = "none";
    resumeButton.style.display = "inline";
  }
});

// â–¼ å†é–‹å‡¦ç†ï¼ˆresumeGameï¼‰ã‚’è¿½åŠ 
function resumeGame() {
  const pauseEnd = Date.now(); 
  totalPausedTime += pauseEnd - pauseStart;

  // âœ… currentBGMãŒã‚ã‚Œã°å†é–‹ï¼ˆpausedçŠ¶æ…‹ã®ã‚‚ã®ã®ã¿ï¼‰
  if (currentBGM) {
    if (currentBGM.paused) {
      currentBGM.play().then(() => {
        console.log("âœ… BGM resumed:", currentBGM.src);
      }).catch(e => {
        console.warn("ğŸ”‡ resumeGame: BGM play failed:", e);
      });
    } else {
      console.log("ğŸ” BGM was already playing:", currentBGM.src);
    }
  } else {
    console.warn("âŒ resumeGame: currentBGM is null");
  }

  scoreUpdateInterval = setInterval(updateScore, 100);
  timeUpdateInterval = setInterval(updateTime, 30);
  resetObstacleSpawn(); // â† å†é–‹æ™‚ã®éšœå®³ç‰©ç”Ÿæˆå†é–‹
}

/* =======================================================
   â–¼ éšœå®³ç‰©ä½œæˆãƒªã‚»ãƒƒãƒˆå‡¦ç†
   ======================================================= */
function resetObstacleSpawn() {
  if (obstacleSpawnInterval !== null) {
    clearInterval(obstacleSpawnInterval);
    console.log("æ—¢å­˜ã®spawnIntervalåœæ­¢");
  }

  // ã‚¹ã‚³ã‚¢ã«å¿œã˜ãŸå‡ºç¾é–“éš”ã‚’å®šç¾©
  let baseInterval = 800;
  if (score >= 200000) baseInterval = 400;
  else if (score >= 150000) baseInterval = 500;
  else if (score >= 100000) baseInterval = 600;
  else if (score >= 50000) baseInterval = 700;

  console.log(`[resetObstacleSpawn] baseInterval = ${baseInterval}`);

  obstacleSpawnInterval = setInterval(() => {
    if (!gameOver) createObstacle();
  }, baseInterval);
}

/* =======================================================
   â–¼ éšœå®³ç‰©ä½œæˆå‡¦ç†
   ======================================================= */
function createObstacle() {
  if (gameOver || isPaused) return;
  const item = document.createElement("div");
  item.classList.add("obstacle");

  let sizeOption;
  let colorClass = "";
  let fallSpeed;

  // speedScaleã®è¨ˆç®—
  let speedScale = 1.0;
  if (score >= 150000) {
    const additionalScale = Math.min(Math.floor(score / 150000) * 1.2, 7.0);
    speedScale += additionalScale;
  }
  speedScale = Math.min(speedScale, 8.0);

  // ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¥å†…å®¹
  if (stage === 1) {
    sizeOption = Math.random() < 0.6 ? "small" : "big";
    colorClass = "red";
    fallSpeed = sizeOption === "small" ? 4 * speedScale : 3 * speedScale;
  } else if (stage === 2) {
    sizeOption = Math.random() < 0.7 ? "small" : "big";
    colorClass = "blue";
    fallSpeed = sizeOption === "small" ? 4 * speedScale : 5 * speedScale;
  } else if (stage === 3) {
    sizeOption = Math.random() < 0.8 ? "big" : "huge";
    colorClass = "green";
    fallSpeed = sizeOption === "big" ? 5 * speedScale : 2 * speedScale;
  } else if (stage === 4 || stage === 5) {
    const randomChoice = Math.random();
    if (randomChoice < 0.3) {
      sizeOption = "huge";
      colorClass = "red";
      fallSpeed = 3 * speedScale;
    } else if (randomChoice < 0.4) {
      sizeOption = "huge";
      colorClass = "blue";
      fallSpeed = 2 * speedScale;
    } else {
      sizeOption = "small";
      colorClass = "green";
      fallSpeed = 6 * speedScale;
    }
    item.classList.add("stage4");
  }

  // è¡¨ç¤ºè¨­å®š
  const sizeStr = sizeOption;
  const colorInitial = colorClass[0].toUpperCase();
  item.style.backgroundImage = `url(enm_${sizeStr}_${colorInitial}.gif)`;
  item.style.backgroundSize = "cover";
  item.style.backgroundRepeat = "no-repeat";
  item.style.backgroundPosition = "center";
  item.style.pointerEvents = "none";

  // ã‚µã‚¤ã‚ºã¨ãƒ’ãƒƒãƒˆãƒœãƒƒã‚¯ã‚¹
  const sizeData = {
    small: 60,
    big: 92,
    huge: 172
  };
  const dimension = sizeData[sizeOption];
  item.style.width = dimension + "px";
  item.style.height = dimension + "px";
  item.dataset.hitboxW = dimension;
  item.dataset.hitboxH = dimension;

  item.style.backgroundColor = "transparent";
  item.dataset.hp = sizeOption === "small" ? 1 : sizeOption === "big" ? 2 : 3;
  item.dataset.type = "damage";
  item.dataset.stage = stage;
  item.dataset.size = sizeOption;
  item.dataset.color = colorClass;
  item.classList.add("obstacle");

  // ä½ç½®è¨­å®š
  item.style.left = Math.floor(Math.random() * 9) * 40 + "px";
  item.style.top = "0px";
  item.style.position = "absolute";

  game.appendChild(item);
  allObstacles.push(item);

  let y = 0;
  const fall = setInterval(() => {
    if (gameOver || !item.parentElement) return clearInterval(fall);
    if (isPaused) return;
    y += fallSpeed;
    item.style.top = y + "px";

    const playerRect = hitbox.getBoundingClientRect();
    const itemRect = getAdjustedRect(item);

    if (checkCollision(playerRect, itemRect)) {
      if (!invincible && !superInvincible) {
        const dmg = parseInt(item.dataset.hp);
        lives -= dmg;
        if (lives <= 0) endGame();
        setInvincible();
      }
      item.remove();
      updateUI();
      clearInterval(fall);
      return;
    }

    if (y > 600) {
      item.remove();
      clearInterval(fall);
    }
  }, 30);

  // ğŸ”„ è½ä¸‹ç”¨IDã‚’ä¿å­˜ï¼ˆåå°„æ™‚ã« clear ã™ã‚‹ãŸã‚ï¼‰
  item.fallInterval = fall;
}

/** â˜… æŒ‡å®šãƒŸãƒªç§’ã§éšœå®³ç‰©ç”Ÿæˆã‚¿ã‚¤ãƒãƒ¼ã‚’å†ã‚»ãƒƒãƒˆ */
function setObstacleTimer(interval) {
  clearInterval(obstacleTimerId);
  obstacleTimerId = setInterval(() => {
    if (!gameOver) createObstacle();
  }, interval); // â† interval ã¯ baseInterval ã‚’å—ã‘å–ã‚‹ã¯ãš
}

//åˆæœŸéšœå®³ç‰©ç™ºç”Ÿé–“éš”
/* ==== ã‚¹ã‚³ã‚¢ã«å¿œã˜ã¦ç”Ÿæˆé–“éš”ã‚’æ›´æ–° ==== */
function startObstacleGeneration(){
  // åˆå›èµ·å‹•
  setObstacleTimer(800);
}

/** â˜… ã‚¹ã‚³ã‚¢æ›´æ–°ã”ã¨ã«å‘¼ã¶ï¼ˆupdateScore å†…ã®æœ€å¾Œã«ï¼‘è¡Œè¿½åŠ ã™ã‚Œã°ï¼¯ï¼«ï¼‰ */
function updateObstacleIntervalByScore(score) {
  const newInterval = Math.max(200, 800 - Math.floor(score / 200000) * 200); // â† ã“ã‚ŒãŒå¿…è¦ï¼
  const previousInterval = baseInterval;

  if (newInterval !== baseInterval) {
    baseInterval = newInterval;
    console.log(`[ã‚¹ã‚³ã‚¢æ›´æ–°] score=${score}, baseIntervalå¤‰æ›´: ${previousInterval} â†’ ${baseInterval}`);
    resetObstacleSpawn();
  }
}

/* =======================================================
   â–¼ ã‚¢ã‚¤ãƒ†ãƒ ç”Ÿæˆã¨è½ä¸‹å‡¦ç†æœ¬ä½“
   ======================================================= */
function spawnFallingItem(type) {
  const config = {
    heart: {
      emoji: "ğŸ’—",
      speed: 5,
      condition: () => lives < maxLives && Math.random() < 0.10,
      onCollect: () => {
        lives = Math.min(lives + 1, maxLives);
        updateUI();
      }
    },
    goldHeart: {
      emoji: "ğŸ’›",
      speed: 8,
      condition: () => lives <= 1 && Math.random() < 0.05,
      onCollect: () => {
        lives = maxLives;
        updateUI();
      }
    },
    lemon: {
      emoji: "ğŸ‹",
      speed: 5,
      condition: () => level < maxLevel && lives === maxLives && Math.random() < 0.05,
      onCollect: (x, y) => {
        const scoreAdd = 10000, expAdd = 300;
        createExplosion(x, y, scoreAdd, false, true, expAdd);
        score += scoreAdd;
        addExp(expAdd);
        updateUI();
      }
    },
    grape: {
      emoji: "ğŸ‡",
      speed: 5,
      condition: () => level >= maxLevel && Math.random() < 0.05,
      onCollect: (x, y) => {
        createExplosion(x, y, 15000, false, true);
        score += 15000;
        updateUI();
        setSuperInvincible(15000);
      }
    }
  };

  const itemData = config[type];
  if (!itemData || !itemData.condition() || gameOver || isPaused) return;

  const el = document.createElement("div");
  el.classList.add("heal"); // å…±é€šã‚¯ãƒ©ã‚¹åï¼ˆå‰Šé™¤æ™‚ã«ä¸€æ‹¬æŒ‡å®šå¯èƒ½ï¼‰
  el.textContent = itemData.emoji;
  el.style.left = Math.floor(Math.random() * 9) * 40 + "px";
  el.style.top = "0px";
  game.appendChild(el);

  let y = 0;

  const fall = setInterval(() => {
    if (gameOver || !el.parentElement) return clearFall();
    if (isPaused) return;

    y += itemData.speed;
    el.style.top = y + "px";

    const itemRect = el.getBoundingClientRect();
    const playerRect = hitbox.getBoundingClientRect();
    const gameRect = game.getBoundingClientRect();
    const centerX = itemRect.left + itemRect.width / 2 - gameRect.left;
    const centerY = itemRect.top + itemRect.height / 2 - gameRect.top;

    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨è¡çª
    if (checkCollision(itemRect, playerRect)) {
      el.remove();
      clearFall();
      if (seItem) {
        seItem.currentTime = 0;
        seItem.play().catch(e => console.warn("SE error:", e));
      }
      itemData.onCollect?.(centerX, centerY);
      return;
    }

    // åå°„éšœå®³ç‰©ã¨ã®è¡çª
    for (let obs of allObstacles) {
      if (obs.dataset.type === "reflected") {
        const obsRect = obs.getBoundingClientRect();
        if (checkCollision(itemRect, obsRect)) {
          el.remove();
          clearFall();
          createExplosion(centerX, centerY);
          return;
        }
      }
    }

    // ç”»é¢å¤–ã«å‡ºãŸã‚‰å‰Šé™¤
    if (y > 600) {
      el.remove();
      clearFall();
    }
  }, 30);

  itemFallTimers.push(fall);

  // å®‰å…¨ã«ã‚¿ã‚¤ãƒãƒ¼è§£é™¤ï¼‹ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
  function clearFall() {
    clearInterval(fall);
    itemFallTimers = itemFallTimers.filter(id => id !== fall);
  }
}
/* =======================================================
   â–¼ ãƒãƒ¼ãƒˆ/ãƒ¬ãƒ¢ãƒ³/ã‚°ãƒ¬ãƒ¼ãƒ—ç”Ÿæˆã®å…ƒã‚³ãƒ¼ãƒ‰ç½®ãæ›ãˆ
   ======================================================= */
function maybeSpawnHeart() {
  spawnFallingItem("goldHeart");
  spawnFallingItem("heart");
}
function maybeSpawnLemon() {
  spawnFallingItem("lemon");
}
function maybeSpawnGrape() {
  spawnFallingItem("grape");
}
/* =======================================================
   â–¼ ã‚¢ã‚¤ãƒ†ãƒ å–å¾—SE
   ======================================================= */
function loadAudio(audioEl) {
  return new Promise((resolve, reject) => {
    audioEl.oncanplaythrough = resolve;
    audioEl.onerror = reject;
    audioEl.load();
  });
}

/* =======================================================
   â–¼ ã‚¹ãƒ†ãƒ¼ã‚¸é€²è¡Œ
   ======================================================= */
function updateStage() {
  const prev = stage;

  if (score >= 600000) {
    stage = 5; // âœ… æ–°ã‚¹ãƒ†ãƒ¼ã‚¸5
  } else if (score >= 150000) {
    stage = 4;
  } else if (score >= 100000) {
    stage = 3;
  } else if (score >=  50000) {
    stage = 2;
  } else {
    stage = 1;
  }

  if (stage !== prev) {
    crossfadeBackground(stage);          // èƒŒæ™¯ã®ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰
    setStageBackgroundSpeed(stage);      // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é€Ÿåº¦å¤‰æ›´
  }
}

/* =======================================================
   â–¼ ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¡Œå‹•å‡¦ç†
   ======================================================= */
// å…±é€šãƒ˜ãƒ«ãƒ‘ãƒ¼
function isLeftKey(key) {
  return key === "ArrowLeft" || key === "a" || key === "A";
}
function isRightKey(key) {
  return key === "ArrowRight" || key === "d" || key === "D";
}

// å›é¿ç§»å‹•
function dodge(dir) {
  if (isDodging) return;
  isDodging = true;
  speedBoost = true;
  if (seDodge) { seDodge.currentTime = 0; seDodge.play(); }
  setInvincible(300);
  player.classList.add("dodging");

  const flare = document.createElement("div");
  flare.className = "dodge-flare";
  player.appendChild(flare);

  const startX = playerX;
  spawnAfterImage(startX);

  for (let i = 0; i < 2; i++) {
    const delta = dir === "ArrowLeft" ? -STEP_PX : STEP_PX;
    const newX = Math.max(0, Math.min(360, playerX + delta));
    if (newX !== playerX) {
      playerX = newX;
      player.style.left = playerX + "px";
      hitbox.style.left = (playerX + 4) + "px";
    }
    if (i === 0) spawnAfterImage(playerX);
  }

  setTimeout(() => {
    speedBoost = false;
    isDodging = false;
    player.classList.remove("dodging");
    flare.remove();
  }, 300);
}

// æ®‹åƒ
function spawnAfterImage(xPos){
  const img = document.createElement("div");
  img.className = "afterimage";
  img.style.left = xPos + "px";
  img.style.bottom = "10px";
  img.style.backgroundImage = 'url("chr_moth.gif")';
  img.style.backgroundSize = 'cover';
  game.appendChild(img);
  setTimeout(() => img.remove(), 100);
}

// é€šå¸¸ç§»å‹•
function stepMove(dir){
  if (gameOver || isPaused) return;
  const delta = speedBoost ? playerSpeed * 2 : playerSpeed;
  const prevX = playerX;

  if (dir === "ArrowLeft")  playerX = Math.max(0, playerX - delta);
  if (dir === "ArrowRight") playerX = Math.min(360, playerX + delta);

  if (playerX !== prevX) {
    player.style.left = playerX + "px";
    hitbox.style.left = (playerX + 4) + "px";
  }
}

// PCã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
document.addEventListener("keydown", e => {
  if (gameOver || isPaused) return;

  const key = e.key;
  if (key === "f" || key === "F" || key === "Enter") {
    activateParry();
    return;
  }

  const isLeft  = isLeftKey(key);
  const isRight = isRightKey(key);
  if (!isLeft && !isRight) return;

  const dirKey = isLeft ? "ArrowLeft" : "ArrowRight";

  // é•·æŠ¼ã—ã§ã¯ dodge ç™ºå‹•ã—ãªã„
  if (!e.repeat) {
    const now = performance.now();
    if (lastKey === dirKey && now - lastKeyTime <= DOUBLE_TAP_MS) {
      dodge(dirKey);
      lastKey = "";
    } else {
      lastKey = dirKey;
      lastKeyTime = now;
    }
  }

  keyPressed[dirKey] = true;
});

document.addEventListener("keyup", e => {
  const key = e.key;
  if (isLeftKey(key))  keyPressed["ArrowLeft"] = false;
  if (isRightKey(key)) keyPressed["ArrowRight"] = false;
});

// é€šå¸¸ç§»å‹•ãƒ«ãƒ¼ãƒ—
function continuousMoveLoop() {
  if (!isPaused && !gameOver) {
    if (keyPressed["ArrowLeft"])  stepMove("ArrowLeft");
    if (keyPressed["ArrowRight"]) stepMove("ArrowRight");
  }
  requestAnimationFrame(continuousMoveLoop);
}
continuousMoveLoop();

// ã‚¯ãƒªãƒƒã‚¯ï¼ã‚¿ãƒƒãƒ—ã§ãƒ‘ãƒªã‚£
game.addEventListener("mousedown", () => {
  if (!gameOver) activateParry();
});
game.addEventListener("touchstart", e => {
  e.preventDefault();
  if (!gameOver) activateParry();
});

// ã‚¿ãƒƒãƒé•·æŠ¼ã—ã«ã‚ˆã‚‹ç§»å‹•ãƒ«ãƒ¼ãƒ—ï¼ˆã‚¹ãƒãƒ›ï¼‰
function startTouchHold(dirKey) {
  isTouchHolding = true;
  stopTouchHold();  // å‰ã®ãƒ«ãƒ¼ãƒ—ã‚’ã‚¯ãƒªã‚¢
  keyPressed[dirKey] = true;
  touchHoldInterval = setInterval(() => {
    stepMove(dirKey);
  }, 30);
}

function stopTouchHold() {
  clearInterval(touchHoldInterval);
  touchHoldInterval = null;
  isTouchHolding = false;
  keyPressed["ArrowLeft"] = false;
  keyPressed["ArrowRight"] = false;
}

// ğŸ” ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ï¼†é€šå¸¸ç§»å‹•ã®å…¼ç”¨å‡¦ç†ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰
function handleTap(dirKey) {
  const now = performance.now();
  if (isTouchHolding) return; // æŠ¼ã—ã£ã±ä¸­ã¯ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ç„¡è¦–

  if (lastKey === dirKey && now - lastKeyTime <= DOUBLE_TAP_MS) {
    dodge(dirKey); // 2é€£æ‰“ã§å›é¿ç§»å‹•
    lastKey = "";
  } else {
    lastKey = dirKey;
    lastKeyTime = now;
    stepMove(dirKey); // é€šå¸¸ç§»å‹•1ã‚¹ãƒ†ãƒƒãƒ—
  }
}

// å·¦ãƒœã‚¿ãƒ³ï¼ˆã‚¿ãƒƒãƒï¼‰
btnLeft.addEventListener("touchstart", e => {
  e.preventDefault();
  startTouchHold("ArrowLeft");
}, { passive: false });

btnLeft.addEventListener("touchend", e => {
  e.preventDefault();
  stopTouchHold();
  handleTap("ArrowLeft");
}, { passive: false });

btnLeft.addEventListener("touchcancel", stopTouchHold);

// å³ãƒœã‚¿ãƒ³ï¼ˆã‚¿ãƒƒãƒï¼‰
btnRight.addEventListener("touchstart", e => {
  e.preventDefault();
  startTouchHold("ArrowRight");
}, { passive: false });

btnRight.addEventListener("touchend", e => {
  e.preventDefault();
  stopTouchHold();
  handleTap("ArrowRight");
}, { passive: false });

btnRight.addEventListener("touchcancel", stopTouchHold);

// ãƒ‘ãƒªã‚£ãƒœã‚¿ãƒ³ï¼ˆã‚¿ãƒƒãƒï¼‰
btnParry.addEventListener("touchstart", e => {
  e.preventDefault();
  activateParry();
}, { passive: false });

// ãƒ‘ãƒªã‚£ï¼šã‚²ãƒ¼ãƒ ç”»é¢ã‚¿ãƒƒãƒ—ã§ã‚‚ç™ºå‹•ï¼ˆã‚¹ãƒãƒ›ï¼‰
game.addEventListener("touchstart", e => {
  e.preventDefault();
  if (!gameOver) activateParry();
}, { passive: false });

// ãƒãƒ¼ã‚ºå‡¦ç†
pauseButton.addEventListener("click", () => {
  isPaused = true;
  pauseOverlay.style.display = "flex";
  pauseButton.style.display = "none";
  resumeButton.style.display = "inline";
});
resumeButton.addEventListener("click", () => {
  isPaused = false;
  pauseOverlay.style.display = "none";
  pauseButton.style.display = "inline";
  resumeButton.style.display = "none";
});


// ãƒãƒ¼ã‚ºåˆ¶å¾¡
pauseButton.addEventListener("click", () => {
  isPaused = true;
  pauseOverlay.style.display = "flex";
  pauseButton.style.display = "none";
  resumeButton.style.display = "inline";
});
resumeButton.addEventListener("click", () => {
  isPaused = false;
  pauseOverlay.style.display = "none";
  pauseButton.style.display = "inline";
  resumeButton.style.display = "none";
});

/* â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…  å…¥åŠ›ãƒãƒ³ãƒ‰ãƒ©ã“ã“ã¾ã§  â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜… */

  // ã‚¿ã‚¤ãƒ ã®æ›´æ–°ï¼ˆãƒŸãƒªç§’å˜ä½ï¼‰
  function updateTime() {
    if (isPaused) return;
    if (gameOver) return; // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼æ™‚ã«ã¯ã‚¿ã‚¤ãƒ æ›´æ–°ã—ãªã„
    gameTime = (Date.now() - startTime - totalPausedTime); // âœ… ãƒãƒ¼ã‚ºæ™‚é–“ã‚’é™¤å¤–
    timeEl.innerHTML = `ã‚¿ã‚¤ãƒ : ${(gameTime / 1000).toFixed(3)}ç§’`;  // å°æ•°ç‚¹ä»¥ä¸‹3æ¡ã§è¡¨ç¤º
    
      // ğŸ‘‡ ã“ã“ã«ã‚‚ãƒ­ã‚°ã‚’è¿½åŠ 
//console.log("ğŸ•’ ã‚¿ã‚¤ãƒ é€²è¡Œä¸­ gameTime =", gameTime);
  }

// ã‚¹ã‚³ã‚¢ã®æ›´æ–° â”€ 100ms ã”ã¨ã« +10 åŠ ç®—ã—æ•´æ•°ã§è¡¨ç¤º & ã‚¹ãƒ†ãƒ¼ã‚¸/BGM åˆ¤å®šã‚‚å®Ÿæ–½
function updateScore() {
  if (isPaused) return;
  if (gameOver) return;                       // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ä¸­ã¯æ›´æ–°ã—ãªã„

  const elapsed = Date.now() - startTime;     // çµŒéãƒŸãƒªç§’
  const tick    = Math.floor(elapsed / 100);  // 100ms å˜ä½ã®ã‚«ã‚¦ãƒ³ã‚¿

  // 100ms é€²ã‚“ã ã‚‰ã‚¹ã‚³ã‚¢åŠ ç®—
  if (tick > lastScoreUpdateTime) {
    lastScoreUpdateTime = tick;
    score += 10;

    /* â–¼ ã“ã“ã§ã‚¹ãƒ†ãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ & BGM ã‚¯ãƒ­ã‚¹ãƒ•ã‚§ãƒ¼ãƒ‰ã‚’åˆ¤å®š */
    if (typeof checkStage === "function") {
      checkStage();   // â† äº‹å‰ã«è¿½åŠ ã—ãŸ checkStage() ã‚’å‘¼ã¶
    }

    // UI åæ˜ ï¼ˆå°æ•°ç‚¹ä»¥ä¸‹ãªã—ï¼‰
    scoreEl.textContent = "ã‚¹ã‚³ã‚¢: " + Math.floor(score);
    updateObstacleIntervalByScore(score);
  }
}

/* =======================================================
   â–¼ ãƒ‘ãƒªã‚£/ã‚¸ãƒ£ã‚¹ãƒˆãƒ‘ãƒªã‚£
   ======================================================= */
function activateParry() {
  if (gameOver || isPaused) return;
  if (parryActive || Date.now() - lastParryTime < PARRY_COOLDOWN) return;
  lastParryTime = Date.now();

  seParry.play();
  setInvincible(350);

  parryActive = true;
  justParry = false;

  // é€šå¸¸ãƒ‘ãƒªã‚£ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆåŠå¾„55px, ã‚µã‚¤ã‚º110Ã—110ï¼‰
  const effect = document.createElement("img");
  effect.src = "eff_parry.gif";
  effect.style.position = "absolute";
  effect.style.left = (player.offsetLeft + player.offsetWidth / 2 - 55) + "px";
  effect.style.top = (player.offsetTop + player.offsetHeight / 2 - 55) + "px";
  effect.style.width = "110px";
  effect.style.height = "110px";
  effect.style.pointerEvents = "none";
  effect.style.zIndex = "3";
  game.appendChild(effect);

  // ã‚¸ãƒ£ã‚¹ãƒˆã˜ã‚ƒãªã‹ã£ãŸã‚‰å¾Œã§æ¶ˆã™
  setTimeout(() => {
    if (!justParry) effect.remove();
  }, 350);

  setTimeout(() => {
    const pRect = player.getBoundingClientRect();
    const pcx = (pRect.left + pRect.right) / 2;
    const pcy = (pRect.top + pRect.bottom) / 2;

    for (let i = 0; i < allObstacles.length; i++) {
      const obs = allObstacles[i];
      if (!obs || !obs.parentElement || obs.dataset.type !== "damage") continue;

      const oRect = getAdjustedRect(obs);
      const dx = Math.max(oRect.left - pcx, 0, pcx - oRect.right);
      const dy = Math.max(oRect.top - pcy, 0, pcy - oRect.bottom);
      const dist = Math.hypot(dx, dy);

        if (dist <= justParryRadius) {
          justParry = true;
          effect.remove(); // é€šå¸¸ãƒ‘ãƒªã‚£ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå‰Šé™¤
          showJustParry();
          reflectObstacle(obs, true); // ğŸŒˆã‚¸ãƒ£ã‚¹ãƒˆåå°„
          setInvincible(350);         // ğŸŒˆç„¡æ•µå»¶é•·

        // ã‚¸ãƒ£ã‚¹ãƒˆã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
        const jSize = 60;
        const j = document.createElement("img");
        j.src = "eff_just_parry.gif";
        j.style.position = "absolute";
        j.style.left = (player.offsetLeft + player.offsetWidth / 2 - jSize / 2) + "px";
        j.style.top = (player.offsetTop + player.offsetHeight / 2 - jSize / 2) + "px";
        j.style.width = jSize + "px";
        j.style.height = jSize + "px";
        j.style.pointerEvents = "none";
        j.style.zIndex = "3";
        game.appendChild(j);
        setTimeout(() => j.remove(), 580);
        break;
      } else if (dist <= normalParryRadius) {
        reflectObstacle(obs, false); // é€šå¸¸åå°„
        break;
      }
    }
  }, 70);

  setTimeout(() => {
    parryActive = false;
    justParry = false;
  }, PARRY_COOLDOWN);
}

/* =======================================================
   â–¼ ã‚¸ãƒ£ã‚¹ãƒˆãƒ‘ãƒªã‚£ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
   ======================================================= */
function showJustParry() {
  const j = document.createElement("img");
  j.src = "eff_just_parry.gif";
  j.style.position = "absolute";
  j.style.left = (player.offsetLeft + player.offsetWidth / 2 - 30) + "px";
  j.style.top = (player.offsetTop + player.offsetHeight / 2 - 30) + "px";
  j.style.width = "60px";
  j.style.height = "60px";
  j.style.pointerEvents = "none";
  j.style.zIndex = "3";
  game.appendChild(j);

  if (seJustParry) {
    seJustParry.currentTime = 0;
    seJustParry.play().catch(e => console.warn("JustParryéŸ³å†ç”Ÿå¤±æ•—:", e));
  }

  setTimeout(() => j.remove(), 580);
}

/* =======================================================
   â–¼ è¢«ãƒ€ãƒ¡ãƒ¼ã‚¸æ™‚ã®åŠé€æ˜å‡¦ç†
   ======================================================= */
  function setInvincible(duration = 1000) {
    invincible = true;
    player.style.opacity = "0.5";
    setTimeout(() => {
      invincible = false;
      player.style.opacity = "1";
    }, duration);
  }

/* =======================================================
   â–¼ ç„¡æ•µå‡¦ç†
   ======================================================= */
function setSuperInvincible(duration = 15000) {
  superInvincible = true;

  orb1 = document.createElement("div");
  orb2 = document.createElement("div");
  orb1.className = "invincible-orb orb1";
  orb2.className = "invincible-orb orb2";
  player.appendChild(orb1);
  player.appendChild(orb2);

  setTimeout(() => {
    superInvincible = false;
    orb1?.remove();
    orb2?.remove();
  }, duration);
}

/* =======================================================
   â–¼ çˆ†ç™ºç™ºç”Ÿå‡¦ç†
   ======================================================= */
function createExplosion(x, y, scoreValue = 0, isJust = false, noExplosion = false, expValue = 0) {
  // ---------- çˆ†ç™ºã‚¨ãƒ•ã‚§ã‚¯ãƒˆ ----------
  if (!noExplosion) {
    const explosion = document.createElement("img");
    explosion.src = "eff_bomb_L.gif";
    explosion.style.position = "absolute";
    explosion.style.left = x + "px";  // â† ä½™è¨ˆãª +20 å‰Šé™¤
    explosion.style.top  = y + "px";
    explosion.style.width = "100px";
    explosion.style.height = "100px";
    explosion.style.transform = "translate(-50%, -50%)";
    explosion.style.pointerEvents = "none";
    explosion.style.zIndex = "10";
    game.appendChild(explosion);
      // ğŸ”Š çˆ†ç™ºéŸ³ã‚’å†ç”Ÿ
  if (seBombL) {
    seBombL.currentTime = 0;
    seBombL.play();
  }

    setTimeout(() => explosion.remove(), 400);
  }

  // ---------- ã‚¹ã‚³ã‚¢ + çµŒé¨“å€¤è¡¨ç¤º ----------
  if (scoreValue > 0) {
    const scoreText = document.createElement("div");
    scoreText.textContent = `+${scoreValue}${expValue > 0 ? `\nEXP+${expValue}` : ""}`;
    scoreText.style.position = "absolute";
    scoreText.style.left = x + "px";       // â† ä½™è¨ˆãª +20 å‰Šé™¤
    scoreText.style.top  = (y - 10) + "px";
    scoreText.style.fontSize = "12px";     // â† ä¸€æ®µéšå°ã•ã
    scoreText.style.fontWeight = "bold";
    scoreText.style.whiteSpace = "pre";    // æ”¹è¡Œã‚ã‚Š
    scoreText.style.color = isJust ? "yellow" : "white";
    scoreText.style.zIndex = "15";
    scoreText.style.pointerEvents = "none";
    scoreText.style.transform = "translate(-50%, 0px)";
    game.appendChild(scoreText);

    // æµ®ãä¸ŠãŒã£ã¦æ¶ˆãˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    let offset = 0;
    const floatUp = setInterval(() => {
      offset += 1;
      scoreText.style.transform = `translate(-50%, -${offset}px)`;
      if (offset > 50) {  // â† è¡¨ç¤ºæ™‚é–“ ç´„2ç§’ï¼ˆ40ms Ã— 50ï¼‰
        clearInterval(floatUp);
        scoreText.remove();
      }
    }, 40);
  }
}
/* =======================================================
   â–¼ çˆ†ç™ºç™ºç”Ÿå‡¦ç†è»½é‡åŒ–
   ======================================================= */
function safeCreateExplosion(x, y, score, isJust, isBomb, exp) {
  const now = Date.now();
  if (now - lastExplosionTime < 50) return;  // 50msä»¥å†…ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
  lastExplosionTime = now;

  createExplosion(x, y, score, isJust, isBomb, exp);
}

/* =======================================================
   â–¼ ã‚³ãƒ³ãƒœæ•°è¡¨ç¤ºã®æ›´æ–°ï¼ˆç”»é¢å³ä¸Šã« â—‹Hits!ï¼‰
   ======================================================= */
function updateComboDisplay(currentComboCount) {
  if (currentComboCount < 2) return; // âœ… 1Hits! ã¯è¡¨ç¤ºã—ãªã„

  const cappedCount = Math.min(currentComboCount, 50); // âœ… ä¸Šé™50Hits!

  let comboText = document.getElementById("comboText");
  if (!comboText) {
    comboText = document.createElement("div");
    comboText.id = "comboText";
    game.appendChild(comboText);
  }

  // âœ… æ¯å›ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸Šæ›¸ãï¼ˆCSSå½±éŸ¿ã‚’å—ã‘ãªã„ï¼‰
  comboText.style.position = "absolute";
  comboText.style.top = "450px";           // â† è¡¨ç¤ºä½ç½®ã‚’ç¢ºå®Ÿã«åæ˜ 
  comboText.style.right = "10px";
  comboText.style.fontSize = "24px";
  comboText.style.fontWeight = "bold";
  comboText.style.color = "cyan";
  comboText.style.zIndex = "100";
  comboText.style.pointerEvents = "none";
  comboText.style.textShadow = "1px 1px 2px black";

  comboText.style.display = "block";
  comboText.textContent = `${cappedCount} Hits!`; // â† è¡¨ç¤ºã«ã‚‚ä¸Šé™åæ˜ 

  // âœ… ã‚³ãƒ³ãƒœçµ‚äº†ã‚¿ã‚¤ãƒãƒ¼ã®åˆ¶å¾¡ï¼ˆ600mså¾Œã«ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥å‡¦ç†ï¼‰
  if (comboEndTimeout) clearTimeout(comboEndTimeout);
  comboEndTimeout = setTimeout(() => {
    finishComboBonus();
    comboEndTimeout = null;
  }, 600);
}

/* =======================================================
   â–¼ ã‚³ãƒ³ãƒœæ•°è¡¨ç¤º
   ======================================================= */
function createComboText(x, y, hits) {
  if (hits < 2) return; // âœ… 1Hits! ã¯è¡¨ç¤ºã—ãªã„

  const comboText = document.createElement("div");
  comboText.textContent = `${hits} Hits!`;
  comboText.style.position = "absolute";
  comboText.style.left = `${x}px`;
  comboText.style.top = `${y}px`;
  comboText.style.fontSize = "22px";
  comboText.style.fontWeight = "bold";
  comboText.style.color = "cyan";
  comboText.style.textShadow = "1px 1px 2px black";
  comboText.style.pointerEvents = "none";
  comboText.style.zIndex = "100";
  comboText.style.opacity = "1";
  comboText.style.transform = "translateY(0)";
  comboText.style.transition = "transform 0.6s ease-out, opacity 0.6s ease-out";

  document.getElementById("game").appendChild(comboText);

  setTimeout(() => {
    comboText.style.transform = "translateY(-30px)";
    comboText.style.opacity = "0";
  }, 10);

  setTimeout(() => {
    comboText.remove();
  }, 800);
}

/* =======================================================
   â–¼ ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹è¡¨è¨˜
   ======================================================= */
function finishComboBonus() {
  if (comboBonusGiven || currentComboCount < 2) return;

  comboBonusGiven = true;

  const cappedCount = Math.min(currentComboCount, 50); // âœ… æœ€å¤§50Hitsæ‰±ã„
  const bonusScore = cappedCount * 1000;
  const bonusExp = cappedCount * 10;
  score += bonusScore;
  addExp(bonusExp);

  const bonusDiv = document.createElement("div");
  bonusDiv.innerText = `+${bonusScore}\nEXP+${bonusExp}`;
  bonusDiv.style.position = "absolute";
  bonusDiv.style.right = "5%";
  bonusDiv.style.top = "100%";
  bonusDiv.style.transform = "translateY(350px)";
  bonusDiv.style.fontSize = "20px";
  bonusDiv.style.fontWeight = "bold";
  bonusDiv.style.whiteSpace = "pre";
  bonusDiv.style.color = "aqua";
  bonusDiv.style.textShadow = "2px 2px 4px black";
  bonusDiv.style.pointerEvents = "none";
  bonusDiv.style.zIndex = "100";

  game.appendChild(bonusDiv);

  // æµ®ãä¸ŠãŒã‚Šï¼†ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¢ã‚¦ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
  let offset = 0;
  let opacity = 1;
  const floatUp = setInterval(() => {
    offset += 2;
    opacity -= 0.03;
    bonusDiv.style.top = `${100 - offset}px`; // â† ä¸Šã«ãšã‚‰ã™
    bonusDiv.style.opacity = opacity;
    if (offset > 50 || opacity <= 0) {
      clearInterval(floatUp);
      bonusDiv.remove();
    }
  }, 30);

  // âœ… ã‚³ãƒ³ãƒœæƒ…å ±ãƒªã‚»ãƒƒãƒˆ
  currentComboCount = 0;
  comboBonusGiven = false;
  comboInProgress = false;

  // âœ… ã‚³ãƒ³ãƒœUIã‚’éè¡¨ç¤º
  const comboText = document.getElementById("comboText");
  if (comboText) comboText.style.display = "none";

  // âœ… ã‚¿ã‚¤ãƒãƒ¼ã‚’æ˜ç¤ºçš„ã«è§£é™¤
  if (comboEndTimeout) {
    clearTimeout(comboEndTimeout);
    comboEndTimeout = null;
  }

  updateUI();
}

/* =======================================================
   â–¼ UIã®æ›´æ–°å‡¦ç†
   ======================================================= */
function updateUI() {
  // ãƒãƒ¼ãƒˆã®æ•°è¡¨ç¤ºï¼ˆè² ã®repeatå¯¾ç­–ã‚ã‚Šï¼‰
  livesEl.innerHTML =
    "â¤ï¸".repeat(Math.max(0, lives)) +
    "ğŸ–¤".repeat(Math.max(0, maxLives - lives));

  // ãƒ¬ãƒ™ãƒ«è¡¨ç¤º
  levelEl.textContent = "Lv. " + level;

  // çµŒé¨“å€¤è¡¨ç¤º
  if (level < maxLevel) {
    expEl.textContent = `EXP: ${exp} / ${level * 200}`;
  } else {
    expEl.textContent = `EXP: MAX`;
  }

  // ã‚¹ã‚³ã‚¢è¡¨ç¤º
  scoreEl.textContent = "ã‚¹ã‚³ã‚¢: " + score;
}

/* =======================================================
   â–¼ çµŒé¨“å€¤è¿½åŠ 
   ======================================================= */
function addExp(amount) {
  if (level >= maxLevel) return;

  exp += amount;
  let threshold = level * 200;

  let levelUps = 0;

  while (exp >= threshold && level < maxLevel) {
    exp -= threshold;
    level++;
    maxLives++;
    levelUps++;
    playerSpeed *= 1.05;
    threshold = level * 200;

    // âœ… ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã”ã¨ã«ã‚¸ãƒ£ã‚¹ãƒˆãƒ‘ãƒªã‚£åˆ¤å®šè·é›¢ +2
    justParryRadius = Math.min(justParryRadius + 2, 52); // Lv1:40 â†’ Lv7:52
  }

  // ãƒ©ã‚¤ãƒ•å›å¾©ã¯æœ€å¾Œã«1å›ã ã‘ã¾ã¨ã‚ã¦å‡¦ç†
  if (levelUps > 0) {
    lives = Math.min(lives + levelUps, maxLives);
  }

  updateUI();
}

/* =======================================================
   â–¼ éšœå®³ç‰©ãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨ç¾
   ======================================================= */
  function applyHitFlash(obstacle) {
    obstacle.style.filter = "brightness(2)";
    setTimeout(() => {
      if (obstacle) obstacle.style.filter = "";
    }, 150);
  }
/* =======================================================
   â–¼ ã‚³ãƒªã‚¸ãƒ§ãƒ³åˆ¤å®š
   ======================================================= */
  function checkCollision(r1, r2) {
    return !(r1.top > r2.bottom || r1.bottom < r2.top || r1.left > r2.right || r1.right < r2.left);
  }

/* =======================================================
   â–¼ éšœå®³ç‰©ã‚³ãƒªã‚¸ãƒ§ãƒ³ã‚µã‚¤ã‚ºå¤‰æ›´ï¼ˆé«˜ã•ï¼‰
   ======================================================= */
function getAdjustedRect(elem) {
  const rect = elem.getBoundingClientRect();
  const newHeight = rect.height * 0.7;

  return {
    top: rect.bottom - newHeight,        // â† ä¸‹å¯„ã›ã«å¤‰æ›´
    bottom: rect.bottom,
    left: rect.left,
    right: rect.right,
    width: rect.width,
    height: newHeight
  };
}
/* =======================================================
   â–¼ éšœå®³ç‰©åŒå£«ã®ã‚³ãƒªã‚¸ãƒ§ãƒ³åˆ¤å®š
   ======================================================= */
function rectsOverlap(ax, ay, aw, ah, bx, by, bw, bh) {
  return (
    ax < bx + bw &&
    ax + aw > bx &&
    ay < by + bh &&
    ay + ah > by
  );
}

/* =======================================================
   â–¼ åå°„å‡¦ç†ï¼ˆåå°„ã§ãã‚‹éšœå®³ç‰©ã«å¯¾ã—ã¦åå°„ã‚’è¡Œã†ï¼‰
   ======================================================= */
function reflectObstacle(obstacle, isRainbow) {
  // ğŸ›‘ å…ƒã®è½ä¸‹å‡¦ç†ã‚’åœæ­¢
  if (obstacle.fallInterval) {
    clearInterval(obstacle.fallInterval);
    obstacle.fallInterval = null;
  }

  let hp = parseInt(obstacle.dataset.hp);
  obstacle.dataset.type = "reflected";
  obstacle.dataset.hp = hp;

  let y = parseInt(obstacle.style.top);
  let vy = -obstacleSpeed * (isRainbow ? 1.5 : 1);

  if (isRainbow) {
    obstacle.classList.add("rainbow");
    comboReflectedCount++;
  }

  // å½“ãŸã‚Šåˆ¤å®šæ‹¡å¤§
  const originalW = parseFloat(obstacle.dataset.hitboxW);
  const originalH = parseFloat(obstacle.dataset.hitboxH);
  const expandedW = originalW * 1.2;
  const expandedH = originalH * 1.2;
  obstacle.dataset.hitboxW = expandedW;
  obstacle.dataset.hitboxH = expandedH;

  setTimeout(() => {
    if (obstacle && obstacle.parentElement) {
      obstacle.dataset.hitboxW = originalW;
      obstacle.dataset.hitboxH = originalH;
    }
  }, 500);

  let removed = false;

  setTimeout(() => {
    if (!removed && obstacle && obstacle.parentElement) {
      if (obstacle.classList.contains("rainbow")) {
        comboReflectedCount--;
        if (comboReflectedCount <= 0) {
          comboLastUpdateTime = Date.now();
          comboInProgress = true;
        }
      }
      obstacle.remove();
      removed = true;
    }
  }, 2000);

  const move = setInterval(() => {
    if (!obstacle.parentElement) return clearInterval(move);
    y += vy;
    obstacle.style.top = y + "px";

    if (!obstacle.frameCount) obstacle.frameCount = 0;
    obstacle.frameCount++;
    if (obstacle.frameCount % 2 !== 0) return;

    const selfW = parseFloat(obstacle.dataset.hitboxW || originalW);
    const selfH = parseFloat(obstacle.dataset.hitboxH || originalH);
    const selfX = parseInt(obstacle.style.left);
    const selfY = y;

    for (let other of allObstacles) {
      if (other === obstacle || !other.parentElement) continue;

      const otherX = parseInt(other.style.left);
      const otherY = parseInt(other.style.top);
      const otherW = parseFloat(other.dataset.hitboxW || other.offsetWidth);
      const otherH = parseFloat(other.dataset.hitboxH || other.offsetHeight);

      if (!rectsOverlap(selfX, selfY, selfW, selfH, otherX, otherY, otherW, otherH)) continue;

      const hp1 = parseInt(obstacle.dataset.hp);
      const hp2 = parseInt(other.dataset.hp);
      const stageType = parseInt(other.dataset.stage || 1);
      const size = other.dataset.size;
      const color = other.dataset.color;

      let scoreAdd = 0;
      let expAdd = 0;

      if (stageType === 1 || stageType === 2) {
        scoreAdd = hp2 === 2 ? 1000 : 500;
        expAdd = hp2 === 2 ? 10 : 5;
      } else if (stageType === 3) {
        scoreAdd = hp2 === 3 ? 1500 : 1000;
        expAdd = hp2 === 3 ? 15 : 10;
      } else if (stageType === 4) {
        if (hp2 === 3 && size === "huge" && color === "blue") {
          scoreAdd = 6000;
          expAdd = 60;
        } else if (hp2 === 3) {
          scoreAdd = 4000;
          expAdd = 40;
        } else if (hp2 === 1) {
          scoreAdd = 1500;
          expAdd = 15;
        }
      } else if (stageType >= 5) {
        if (hp2 === 3 && size === "huge" && color === "blue") {
          scoreAdd = 7000;
          expAdd = 70;
        } else if (hp2 === 3) {
          scoreAdd = 5000;
          expAdd = 50;
        } else if (hp2 === 2) {
          scoreAdd = 3000;
          expAdd = 30;
        } else if (hp2 === 1) {
          scoreAdd = 2000;
          expAdd = 20;
        }
      }

      if (isRainbow) {
        score += scoreAdd * 2;
        addExp(expAdd);
        safeCreateExplosion(otherX, otherY, scoreAdd * 2, true, false, expAdd);
        other.remove();

        if (!comboInProgress && currentComboCount === 0) {
          currentComboCount = 2;
          comboBonusGiven = false;
        } else {
          currentComboCount++;
        }

        updateComboDisplay(currentComboCount);
        comboLastUpdateTime = Date.now();
        comboInProgress = true;

      } else {
        if (hp1 === hp2) {
          score += scoreAdd;
          addExp(expAdd);
          safeCreateExplosion(otherX, otherY, scoreAdd, false, false, expAdd);
          obstacle.remove();
          other.remove();
          clearInterval(move);
          removed = true;
        } else if (hp1 > hp2) {
          score += scoreAdd;
          addExp(expAdd);
          safeCreateExplosion(otherX, otherY, scoreAdd, false, false, expAdd);
          obstacle.dataset.hp = hp1 - 1;
          other.remove();
        } else {
          other.dataset.hp = hp2 - 1;
          other.style.opacity = "0.4";
          setTimeout(() => {
            if (other) other.style.opacity = "1";
          }, 150);
          obstacle.remove();
          clearInterval(move);
          removed = true;
        }
      }

      updateUI();
    }

    if (y < 0 && !removed) {
      if (obstacle.classList.contains("rainbow")) {
        comboReflectedCount--;
        if (comboReflectedCount <= 0) {
          comboLastUpdateTime = Date.now();
          comboInProgress = true;
        }
      }
      obstacle.remove();
      removed = true;
      clearInterval(move);
    }
  }, 30);
}

/* =======================================================
   â–¼ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢æ™‚ã®RANKåˆ¤å®š
   ======================================================= */
function getRating(score, time, isMillis = false) {
  const timeInSeconds = isMillis ? time / 1000 : time;
  const spt = score / timeInSeconds;

  if (spt >= 4000) return "V";
  if (spt >= 3600) return "SS";
  if (spt >= 3200) return "S";
  if (spt >= 2800) return "A";
  if (spt >= 2400) return "B";
  if (spt >= 2000) return "C";
  if (spt >= 1600) return "D";
  return "E";
}
/* =======================================================
   â–¼ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢å‡¦ç†
   ======================================================= */
function endGame() {
  gameOver = true;

  // BGMåœæ­¢
  bgm.Stage1.pause();
  bgm.Stage2.pause();
  bgm.Stage3.pause();
  bgm.Final.pause();
  if (bgm.Final2) bgm.Final2.pause(); // âœ… è¿½åŠ 

  // æ—¢ã«è¿½åŠ ã•ã‚ŒãŸGame Overãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Œã°å‰Šé™¤
  const existingOver = document.getElementById("gameOverText");
  if (existingOver) existingOver.remove();

  clearInterval(obstacleTimerId);

  // â–¼â–¼â–¼ ã‚¢ã‚¤ãƒ†ãƒ è½ä¸‹ã‚¿ã‚¤ãƒãƒ¼ã‚’ã™ã¹ã¦åœæ­¢ â–¼â–¼â–¼
  if (typeof itemFallTimers !== "undefined") {
    itemFallTimers.forEach(id => clearInterval(id));
    itemFallTimers = [];
  }

  // â–¼â–¼â–¼ ã‚¢ã‚¤ãƒ†ãƒ ã‚’ã™ã¹ã¦å‰Šé™¤ï¼ˆ.heal ã‚¯ãƒ©ã‚¹ã‚’å…±é€šæŒ‡å®šï¼‰ â–¼â–¼â–¼
  document.querySelectorAll(".heal").forEach(item => item.remove());

  // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç†
  if (score < 150000) {
    const gameOverText = document.createElement("h2");
    gameOverText.id = "gameOverText";
    gameOverText.textContent = "Game Over!";
    gameOverText.style.color = "yellow";
    gameOverText.style.marginTop = "200px";
    game.appendChild(gameOverText);

    gameClear.style.display = "none";
    restartButton.style.display = "block";
    restartButton.style.pointerEvents = "auto";

    pauseButton.style.display = "none";
  } else {
    // â–¼â–¼â–¼ éšœå®³ç‰©å‰Šé™¤å‡¦ç† â–¼â–¼â–¼
    allObstacles.forEach(obj => obj.remove());
    allObstacles.length = 0;

    // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢å‡¦ç†
    const clearTime = (gameTime / 1000).toFixed(3);
    const rating = getRating(score, gameTime, true); // ãƒŸãƒªç§’ãªã®ã§ true ã‚’æŒ‡å®š

    console.log("ã‚¹ã‚³ã‚¢:", score);
    console.log("ã‚²ãƒ¼ãƒ ã‚¿ã‚¤ãƒ ï¼ˆç§’ï¼‰:", clearTime);
    console.log("ã‚¹ã‚³ã‚¢ Ã· ã‚¿ã‚¤ãƒ :", score / gameTime);
    console.log("RANK:", rating);

    timeRatingEl.textContent = `RANK: ${rating}`;

    // âœ… â–¼â–¼â–¼ Vãƒ©ãƒ³ã‚¯æ¼”å‡º â–¼â–¼â–¼
    if (rating.trim().toUpperCase() === "V") {
      timeRatingEl.classList.add("void-rank");

      const existingSubtext = timeRatingEl.parentElement.querySelector(".void-subtext");
      if (existingSubtext) existingSubtext.remove();

      const subtext = document.createElement("div");
      subtext.textContent = "V - VOID RANK";
      subtext.className = "void-subtext";
      timeRatingEl.parentElement.appendChild(subtext);

      triggerVoidFeathers();
    }
    // âœ… â–²â–²â–² Vãƒ©ãƒ³ã‚¯ã“ã“ã¾ã§ â–²â–²â–²

    showMusicTitle("â™ªTwilight Flutter");

    gameClear.style.display = "flex";
    restartButton.style.display = "block";
    document.getElementById("thankYouText").style.display = "block";

    // âœ… è¡¨ç¤ºç”¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’æ›´æ–°
    displayHighScores();

    // âœ… UIè¡¨ç¤ºãŒçµ‚ã‚ã£ã¦ã‹ã‚‰ãƒã‚¤ã‚¹ã‚³ã‚¢ãƒã‚§ãƒƒã‚¯ã‚’å‘¼ã¶
    setTimeout(() => {
      checkAndRegisterHighScore(score, rating);
    }, 500);
  }

  // âœ… ã‚¯ãƒªã‚¢BGMå†ç”Ÿ
  bgm.Result.currentTime = 0;
  bgm.Result.volume = 0.8;
  bgm.Result.play();

  pauseButton.style.display = "none";

  updateUI();
}


setInterval(() => {
  if (gameStarted && !gameOver) {
    maybeSpawnHeart(); // ãƒãƒ¼ãƒˆç”Ÿæˆ
    maybeSpawnLemon(); // ãƒ¬ãƒ¢ãƒ³ç”Ÿæˆ
    maybeSpawnGrape(); // â† ã“ã“ã«è¿½åŠ ï¼
    updateStage();
  }
}, 2500);

/* =======================================================
   â–¼Vãƒ©ãƒ³ã‚¯ã®ç‰¹æ®Šç¾½æ ¹æ¼”å‡ºï¼ˆæ–°è¦è¿½åŠ é–¢æ•°ï¼‰
   ======================================================= */
function triggerVoidFeathers() {
  const container = document.getElementById("voidFeathers");
  const game = document.getElementById("game");
  if (!container || !game) return;

  container.innerHTML = "";
  container.style.display = "block";

  const featherCount = 20;
  const maxSpread = 240;
  const gravityY = 30;

  const gameRect = game.getBoundingClientRect();
  const centerX = gameRect.width / 2;
  const centerY = gameRect.height / 3;

  for (let i = 0; i < featherCount; i++) {
    const feather = document.createElement("div");
    feather.className = "feather";

    const angle = Math.PI + Math.random() * Math.PI;
    const radius = Math.random() * maxSpread;
    const dx = Math.cos(angle) * radius;
    const dy = Math.sin(angle) * radius + 180;

    const flyTimeSec = (5.0 + Math.random()).toFixed(2);
    const rotateSpeedSec = (8.0 + Math.random() * 2).toFixed(2);

    const startAngle = Math.floor(Math.random() * 360);
    const midAngle = startAngle + (Math.random() * 60 - 30);
    const endAngle = midAngle + (Math.random() * 60 - 30);

    feather.style.setProperty("--dx", dx);
    feather.style.setProperty("--dy", dy);
    feather.style.setProperty("--flyTime", `${flyTimeSec}s`);
    feather.style.setProperty("--rotateSpeed", `${rotateSpeedSec}s`);
    feather.style.setProperty("--startAngle", `${startAngle}deg`);
    feather.style.setProperty("--midAngle", `${midAngle}deg`);
    feather.style.setProperty("--endAngle", `${endAngle}deg`);

    feather.style.left = `${centerX}px`;
    feather.style.top = `${centerY}px`;

    // âœ… æ­£ã—ã„å ´æ‰€ã«è¿½åŠ ï¼ˆã“ã‚ŒãŒé‡è¦ï¼ï¼‰
    game.appendChild(feather); 

    // ã‚¢ãƒ‹ãƒ¡å¾Œå‰Šé™¤
    setTimeout(() => {
      feather.remove();
    }, parseFloat(flyTimeSec) * 1000 - 400);
  }
}

/* =======================================================
   â–¼ ãƒã‚¤ã‚¹ã‚³ã‚¢åå‰å…¥åŠ›
   ======================================================= */
function checkAndRegisterHighScore(score, rating) {
  console.log("âœ… checkAndRegisterHighScore ãŒå‘¼ã°ã‚Œã¾ã—ãŸ");
  console.log("ğŸ” score:", score, "rating:", rating);
  console.log("ğŸ’¬ enteringName:", enteringName, "newHighScore:", window.newHighScore);
  console.log("ğŸ“Œ gameStarted:", gameStarted, "gameOver:", gameOver);

  const coefficient = ratingCoefficients[rating] || 1.0;
  const newPower = score * coefficient;
  console.log("ğŸ§® RANKä¿‚æ•°:", coefficient, "â†’ ãƒ‘ãƒ¯ãƒ¼:", newPower);

  // âš ï¸ å‰å›ã® newHighScore ãŒæ®‹ã£ã¦ã„ãŸã‚‰ã‚¯ãƒªã‚¢ï¼ˆå¿µã®ãŸã‚ï¼‰
  if (gameStarted && gameOver && !enteringName && window.newHighScore) {
    console.log("ğŸ§¹ å‰å›ã® newHighScore ã‚’ãƒªã‚»ãƒƒãƒˆ");
    window.newHighScore = null;
  }

  if (enteringName || window.newHighScore) {
    console.log("âš ï¸ ã™ã§ã«åå‰ç™»éŒ²ä¸­ã¾ãŸã¯å®Œäº†æ¸ˆã¿ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚");
    return;
  }
  if (gameStarted === false || gameOver === false) {
    console.log("âš ï¸ ã‚²ãƒ¼ãƒ ãŒã¾ã çµ‚äº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚");
    return;
  }

  if (score < 150000 || !ratingCoefficients[rating]) {
    console.log("âŒ ã‚¹ã‚³ã‚¢ãŒåŸºæº–æœªæº€ã‹ã€RANKä¿‚æ•°ãŒç„¡åŠ¹ã€‚");
    return;
  }

  // ç¾åœ¨ã®ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’ãƒ‘ãƒ¯ãƒ¼é †ã«ã‚½ãƒ¼ãƒˆ
  highScores.sort((a, b) => {
    const aPower = a.score * (ratingCoefficients[a.rating] || 1.0);
    const bPower = b.score * (ratingCoefficients[b.rating] || 1.0);
    return bPower - aPower;
  });

  const lowestPower = highScores.length < 5 ? 0 :
    highScores[4].score * (ratingCoefficients[highScores[4].rating] || 1.0);

  console.log("ğŸ† æœ€ä¸‹ä½Power:", lowestPower, "vs ä»Šå›ã®Power:", newPower);

  if (newPower > lowestPower) {
    console.log("ğŸ‰ ãƒã‚¤ã‚¹ã‚³ã‚¢å…¥ã‚Šåˆ¤å®šæˆåŠŸï¼åå‰å…¥åŠ›ã‚’è¡¨ç¤ºã—ã¾ã™");

    enteringName = true;
    namePos = 0;
    // âœ… å‰å›ã®åå‰ã‚’åˆæœŸå€¤ã«åæ˜ ï¼ˆlocalStorageï¼‰
    const lastName = localStorage.getItem("lastEnteredName") || "AAAA";
    nameChars = lastName.split("").slice(0, 4);
    while (nameChars.length < 4) nameChars.push("A");
  
    updateNameEntryDisplay();

    const entryScreen = document.getElementById("nameEntryScreen");
    if (entryScreen) {
      entryScreen.style.display = "flex";
      entryScreen.style.zIndex = "9999"; // å¿µã®ãŸã‚
    } else {
      console.log("â— nameEntryScreen ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼");
    }

    window.newHighScore = { score, rating };
  } else {
    console.log("â›” ãƒã‚¤ã‚¹ã‚³ã‚¢å…¥ã‚Šã›ãšã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™");
  }
}

function updateNameEntryDisplay() {
  const str = nameChars.map((c, i) => (i === namePos ? `[${c}]` : c)).join(" ");
  document.getElementById("nameEntry").textContent = str;

  // ã€Œæ¬¡ã¸ã€ã¾ãŸã¯ã€Œæ±ºå®šã€ã®åˆ‡ã‚Šæ›¿ãˆ
  const confirmBtn = document.getElementById("confirmButton");
  if (confirmBtn) {
    confirmBtn.textContent = (namePos === nameChars.length - 1) ? "æ±ºå®š" : "æ¬¡ã¸";
  }

  // ã€Œå‰ã¸ã€ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹åˆ¶å¾¡
  const backBtn = document.getElementById("backButton");
  if (backBtn) {
    backBtn.disabled = (namePos === 0); // æœ€åˆã®æ–‡å­—ã§ã¯ç„¡åŠ¹åŒ–
    backBtn.style.opacity = (namePos === 0) ? 0.3 : 1;
  }
}

function nextChar() {
  if (!enteringName) return;
  const idx = availableChars.indexOf(nameChars[namePos]);
  const nextIdx = (idx + 1) % availableChars.length;
  nameChars[namePos] = availableChars[nextIdx];
  updateNameEntryDisplay();
}

function prevChar() {
  if (!enteringName) return;
  const idx = availableChars.indexOf(nameChars[namePos]);
  const prevIdx = (idx - 1 + availableChars.length) % availableChars.length;
  nameChars[namePos] = availableChars[prevIdx];
  updateNameEntryDisplay();
}

function goBackChar() {
  if (namePos > 0) {
    namePos--;
    updateNameEntryDisplay();
  }
}

function displayTopHighScore() {
  const top = highScores[0];
  if (!top) return;
  const coeff = ratingCoefficients[top.rating] || 1.0;
  const power = Math.floor(top.score * coeff);
  const display = `${top.name}ã€€${top.score.toLocaleString()}ã€€RANKï¼š${top.rating}`;
  document.getElementById("topHighScore").textContent = display;
}

window.addEventListener("DOMContentLoaded", () => {
  document.getElementById("nameEntryScreen").style.display = "none";
  enteringName = false;
  window.newHighScore = null;

  // âœ… ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã«ãƒˆãƒƒãƒ—ãƒã‚¤ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º
  displayTopHighScore();
});

function getRatingMultiplier(rating) {
  return ratingCoefficients[rating] || 1.0;
}
  // âœ… åå‰æ±ºå®š
function confirmNameEntry() {
  if (!enteringName) return;

  // æ¬¡ã®æ–‡å­—ã¸ç§»å‹•
  namePos++;

  if (namePos < nameChars.length) {
    updateNameEntryDisplay();
    return; // ã¾ã æœªç¢ºå®šã®æ–‡å­—ãŒã‚ã‚‹ã®ã§ç¢ºå®šã—ãªã„
  }

  // 4æ–‡å­—ã™ã¹ã¦ç¢ºå®šæ¸ˆã¿
  const name = nameChars.join("");
  highScores.push({
    name,
    score: window.newHighScore.score,
    rating: window.newHighScore.rating
  });

  // å†åº¦ã‚½ãƒ¼ãƒˆï¼†5ä»¶ã«çµã‚‹
  highScores.sort((a, b) => {
    const aPower = a.score * (ratingCoefficients[a.rating] || 1.0);
    const bPower = b.score * (ratingCoefficients[b.rating] || 1.0);
    return bPower - aPower;
  });
  highScores = highScores.slice(0, 5);
  saveHighScores(highScores);

  // UIå‡¦ç†
  document.getElementById("nameEntryScreen").style.display = "none";
  enteringName = false;

  // ğŸ¯ å…¥åŠ›ç›´å¾Œã«å³åæ˜ ï¼
  displayHighScores();
  
    // âœ… å…¥åŠ›ã—ãŸåå‰ã‚’ä¿å­˜
  localStorage.setItem("lastEnteredName", name);

  // å¿µã®ãŸã‚ newHighScore ã‚’ãƒªã‚»ãƒƒãƒˆ
  window.newHighScore = null;

  // ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ç”»é¢ã‚’è¡¨ç¤ºï¼ˆå†è¡¨ç¤ºï¼‰
  gameClear.style.display = "flex";
}

/* =======================================================
   â–¼ ãƒã‚¤ã‚¹ã‚³ã‚¢è¡¨
   ======================================================= */
function displayHighScores() {
  const scoreListEl = document.getElementById("scoreList");
  if (!scoreListEl) return;

  const ranks = highScores.map((entry, index) => {
    return `${index + 1}. ${entry.name}ï¼š${entry.score}ï¼ˆ${entry.rating}ï¼‰`;
  });

  scoreListEl.innerHTML = `<p>ğŸ† High Scores</p>` + ranks.map(r => `<div>${r}</div>`).join("");
}

/* =======================================================
   â–¼ ã‚¹ãƒãƒ›è‡ªå‹•æ‹¡å¤§è¡¨ç¤º
   ======================================================= */
window.addEventListener("load", function () {
  setTimeout(function () {
    window.scrollTo(0, 1);
  }, 100);
});
/* =======================================================
   â–¼ visibilitychange ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
   ======================================================= */
document.addEventListener("visibilitychange", () => {
  if (document.hidden) {
    if (gameStarted && !gameOver) {
      pauseGame(); // â†“ã§å®šç¾©
      pausedDueToVisibility = true;
    }
  } else {
    if (pausedDueToVisibility) {
      showResumeOverlay(); // â†“ã§å®šç¾©
      pausedDueToVisibility = false;
    }
  }
});
/* =======================================================
   â–¼ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒªã‚¸ãƒ§ãƒ³è¡¨ç¤º
   ======================================================= */
/*function drawCollisionBox(rect, color = "rgba(255, 0, 0, 0.3)") {
  const box = document.createElement("div");
  box.style.position = "absolute";
  box.style.left = rect.left + "px";
  box.style.top = rect.top + "px";
  box.style.width = rect.width + "px";
  box.style.height = rect.height + "px";
  box.style.backgroundColor = color;
  box.style.zIndex = "9999"; // ä¸€ç•ªä¸Šã«è¡¨ç¤º
  box.style.pointerEvents = "none";
  document.body.appendChild(box);

  // å°‘ã—çµŒã£ãŸã‚‰æ¶ˆãˆã‚‹ã‚ˆã†ã«ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨é€”ï¼‰
  setTimeout(() => box.remove(), 100);
}*/


</script>
</body>
</html>
